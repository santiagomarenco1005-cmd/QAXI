<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>QAXI - Central PRO</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root { --bg: #050505; --sidebar: #0a0a0a; --accent: #ffffff; --border: #1a1a1a; --danger: #ff4444; --warning: #ffaa00; --success: #00ff88; }
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Inter', sans-serif; }
        body { background: var(--bg); color: white; height: 100vh; overflow: hidden; display: flex; }
        
        /* LOGIN */
        #login-gate { text-align: center; width: 100%; max-width: 380px; padding: 20px; margin: auto; }
        .login-logo { font-size: 4rem; font-weight: 800; margin-bottom: 10px; }
        .auth-input { width: 100%; padding: 14px; margin-bottom: 12px; background: #0a0a0a; border: 1px solid #222; color: #fff; border-radius: 8px; outline: none; }
        .login-btn { width: 100%; background: #fff; color: #000; border: none; padding: 14px; border-radius: 8px; font-weight: 800; cursor: pointer; }

        /* PLATAFORMA PRINCIPAL */
        #main-platform { display: none; width: 100%; height: 100%; flex-direction: row; position: relative; }
        
        /* SIDEBAR */
        #sidebar { width: 320px; border-right: 1px solid var(--border); background: var(--sidebar); display: flex; flex-direction: column; transition: 0.3s; z-index: 10; }
        .sb-header { padding: 20px; border-bottom: 1px solid var(--border); }
        #searchClients { width: 100%; background: #111; border: 1px solid #222; padding: 10px; border-radius: 6px; color: white; outline: none; }
        #list-container { flex: 1; overflow-y: auto; }
        .client-item { padding: 15px 20px; border-bottom: 1px solid #0f0f0f; cursor: pointer; display: flex; align-items: center; }
        .client-item.active { background: #fff; color: #000; font-weight: 700; }
        .status-dot { width: 8px; height: 8px; border-radius: 50%; margin-right: 12px; }

        /* CHAT AREA */
        #chat-section { flex: 1; display: flex; flex-direction: column; background: #000; position: relative; }
        #chat-header { padding: 10px 20px; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; min-height: 65px; }
        #btn-back { display: none; background: none; border: none; color: white; font-size: 1.2rem; margin-right: 15px; cursor: pointer; }
        #chat-title { font-size: 0.8rem; font-weight: 700; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        #typing-indicator { font-size: 0.6rem; color: #555; }

        /* MENÃš DE ESTADOS (TICKET) */
        #status-menu { position: absolute; top: 60px; right: 20px; background: #111; border: 1px solid #222; border-radius: 8px; display: none; z-index: 100; box-shadow: 0 10px 30px rgba(0,0,0,0.5); }
        .status-opt { padding: 12px 20px; cursor: pointer; font-size: 0.8rem; border-bottom: 1px solid #1a1a1a; }
        .status-opt:last-child { border: none; }
        .status-opt:hover { background: #222; }

        #msg-display { flex: 1; padding: 20px; overflow-y: auto; display: flex; flex-direction: column; gap: 12px; }
        .msg { max-width: 80%; padding: 12px 16px; border-radius: 12px; font-size: 0.9rem; line-height: 1.4; }
        .me { background: #fff; color: #000; align-self: flex-end; font-weight: 600; }
        .support { background: #111; color: #fff; align-self: flex-start; border: 1px solid #222; }
        
        .attachment-img { max-width: 100%; border-radius: 8px; margin-top: 10px; }
        audio { height: 35px; width: 100%; max-width: 220px; margin-top: 5px; filter: invert(1); }

        /* INPUT AREA */
        #input-area { padding: 15px; border-top: 1px solid var(--border); display: flex; gap: 12px; align-items: center; background: #050505; }
        input#msgInp { flex: 1; background: #111; border: 1px solid #222; color: white; padding: 12px; border-radius: 8px; outline: none; font-size: 16px; }
        .tool-btn { color: #555; font-size: 1.3rem; background: none; border: none; cursor: pointer; transition: 0.2s; }
        .tool-btn:hover { color: #fff; }
        .recording { color: var(--danger) !important; }

        /* MÃ“VIL */
        @media (max-width: 768px) {
            #sidebar { width: 100%; position: absolute; height: 100%; }
            #chat-section { width: 100%; position: absolute; height: 100%; left: 100%; transition: 0.3s; }
            .chat-open #sidebar { transform: translateX(-100%); }
            .chat-open #chat-section { transform: translateX(-100%); }
            .chat-open #btn-back { display: block; }
            .msg { max-width: 90%; }
        }
    </style>
</head>
<body id="app-body">

    <div id="login-gate">
        <div class="login-logo">Q.</div>
        <form id="authForm">
            <input type="email" id="email" class="auth-input" placeholder="Correo electrÃ³nico" required>
            <input type="password" id="pass" class="auth-input" placeholder="ContraseÃ±a" required>
            <button type="submit" class="login-btn">INGRESAR</button>
        </form>
        <p id="toggleAuth" style="margin-top:15px; font-size:0.8rem; color:#555; cursor:pointer; text-decoration:underline;">Â¿Eres nuevo? RegÃ­strate</p>
    </div>

    <div id="main-platform">
        <div id="sidebar">
            <div class="sb-header">
                <input type="text" id="searchClients" placeholder="ðŸ” Buscar cliente...">
            </div>
            <div id="list-container"></div>
            <div style="padding: 15px;"><button id="btnLogout" style="width:100%; padding:10px; background:none; border:1px solid #222; color:#555; border-radius:6px; cursor:pointer; font-size:0.7rem;">CERRAR SESIÃ“N</button></div>
        </div>

        <div id="chat-section">
            <div id="chat-header">
                <div style="display: flex; align-items: center;">
                    <button id="btn-back" onclick="cerrarChatMovil()"><i class="fas fa-arrow-left"></i></button>
                    <div>
                        <div id="chat-title">Selecciona un chat</div>
                        <div id="typing-indicator"></div>
                    </div>
                </div>
                <div id="admin-tools" style="display:none; gap: 18px;">
                    <button class="tool-btn" id="btnStatus" title="Estado de Pago"><i class="fas fa-tag"></i></button>
                    <button class="tool-btn" id="btnClear"><i class="fas fa-broom"></i></button>
                    <button class="tool-btn" id="btnDelete"><i class="fas fa-trash-alt"></i></button>
                </div>
            </div>

            <div id="status-menu">
                <div class="status-opt" onclick="updateStatus('Nuevo', '#ffffff')">âšª Nuevo</div>
                <div class="status-opt" onclick="updateStatus('En Proceso', '#ffaa00')">ðŸŸ  En Proceso</div>
                <div class="status-opt" onclick="updateStatus('Activo/Pagado', '#00ff88')">ðŸŸ¢ Activo / Pagado</div>
                <div class="status-opt" onclick="updateStatus('Pendiente Pago', '#ff4444')">ðŸ”´ Pendiente Pago</div>
            </div>

            <div id="msg-display"></div>

            <form id="input-area">
                <label for="fileInp" class="tool-btn"><i class="fas fa-paperclip"></i></label>
                <input type="file" id="fileInp" style="display:none">
                <button type="button" class="tool-btn" id="voiceBtn"><i class="fas fa-microphone"></i></button>
                <input type="text" id="msgInp" placeholder="Mensaje..." autocomplete="off">
                <button type="submit" id="sendBtn" style="background:#fff; color:#000; border:none; padding:10px 15px; border-radius:6px; font-weight:800;">IR</button>
            </form>
        </div>
    </div>

    <audio id="notif" src="https://assets.mixkit.co/active_storage/sfx/2358/2358-preview.mp3"></audio>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getFirestore, doc, collection, onSnapshot, query, orderBy, addDoc, serverTimestamp, setDoc, deleteDoc, getDocs, writeBatch } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        const firebaseConfig = { 
            apiKey: "AIzaSyDbZAPtQioiXZzkiiIRrkrBkEPF440NMaE", 
            authDomain: "qaxi-93d6d.firebaseapp.com", 
            projectId: "qaxi-93d6d", 
            storageBucket: "qaxi-93d6d.firebasestorage.app", 
            messagingSenderId: "137240859996", 
            appId: "1:137240859996:web:73e14d28c77233be965d99" 
        };
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        const ADMIN_EMAIL = "santiagomarenco1005@icloud.com";
        let isAdmin = false;
        let selectedTarget = null;
        let unsubMessages = null;

        window.abrirChatMovil = () => { if (window.innerWidth <= 768) document.getElementById('app-body').classList.add('chat-open'); };
        window.cerrarChatMovil = () => document.getElementById('app-body').classList.remove('chat-open');

        onAuthStateChanged(auth, (user) => {
            if (user) {
                document.getElementById('login-gate').style.display = 'none';
                document.getElementById('main-platform').style.display = 'flex';
                isAdmin = (user.email === ADMIN_EMAIL);
                if(isAdmin) {
                    document.getElementById('admin-tools').style.display = "flex";
                    cargarLista();
                } else {
                    abrirChat(user.email);
                }
            } else {
                document.getElementById('login-gate').style.display = 'block';
                document.getElementById('main-platform').style.display = 'none';
            }
        });

        function cargarLista() {
            onSnapshot(collection(db, "chats"), (snap) => {
                const list = document.getElementById('list-container');
                list.innerHTML = "";
                snap.forEach(d => {
                    const div = document.createElement('div');
                    div.className = `client-item ${selectedTarget === d.id ? 'active' : ''}`;
                    div.innerHTML = `<span class="status-dot" style="background:${d.data().color || '#333'}"></span>${d.id}`;
                    div.onclick = () => { abrirChat(d.id); abrirChatMovil(); };
                    list.appendChild(div);
                });
            });
        }

        function abrirChat(email) {
            selectedTarget = email;
            document.getElementById('chat-title').innerText = email;
            if (unsubMessages) unsubMessages();
            const q = query(collection(db, "chats", email, "messages"), orderBy("fecha", "asc"));
            unsubMessages = onSnapshot(q, (snap) => {
                const display = document.getElementById('msg-display');
                display.innerHTML = "";
                snap.forEach(d => {
                    const data = d.data();
                    const m = document.createElement('div');
                    const isMe = isAdmin ? (data.emisor === 'admin') : (data.emisor === 'cliente');
                    m.className = `msg ${isMe ? 'me' : 'support'}`;
                    if(data.texto) m.innerHTML = `<p>${data.texto}</p>`;
                    if(data.file) {
                        if(data.fileType?.startsWith('image')) m.innerHTML += `<img src="${data.file}" class="attachment-img">`;
                        else if(data.fileType?.startsWith('audio')) m.innerHTML += `<audio src="${data.file}" controls></audio>`;
                        else m.innerHTML += `<a href="${data.file}" download style="color:inherit;font-size:0.7rem;">ðŸ“Ž Archivo</a>`;
                    }
                    display.appendChild(m);
                });
                display.scrollTop = display.scrollHeight;
            });
        }

        // FUNCIONES ADMIN (ESTADOS)
        document.getElementById('btnStatus').onclick = () => {
            const menu = document.getElementById('status-menu');
            menu.style.display = menu.style.display === 'block' ? 'none' : 'block';
        };

        window.updateStatus = async (name, color) => {
            if(!selectedTarget) return;
            await setDoc(doc(db, "chats", selectedTarget), { status: name, color: color }, { merge: true });
            document.getElementById('status-menu').style.display = 'none';
        };

        // ENVIAR MENSAJES
        async function enviar(txt, file = null, fType = null) {
            if(!selectedTarget) return;
            await addDoc(collection(db, "chats", selectedTarget, "messages"), {
                texto: txt, emisor: isAdmin ? "admin" : "cliente", fecha: serverTimestamp(),
                file: file, fileType: fType
            });
        }

        document.getElementById('input-area').onsubmit = async (e) => {
            e.preventDefault();
            const inp = document.getElementById('msgInp');
            const fileInp = document.getElementById('fileInp');
            if(fileInp.files[0]) {
                const reader = new FileReader();
                reader.readAsDataURL(fileInp.files[0]);
                reader.onload = async () => {
                    await enviar(inp.value, reader.result, fileInp.files[0].type);
                    fileInp.value = ""; inp.value = "";
                };
            } else if(inp.value.trim()) {
                await enviar(inp.value);
                inp.value = "";
            }
        };

        // VOZ
        let mediaRec; let chunks = [];
        document.getElementById('voiceBtn').onclick = async function() {
            if(!mediaRec || mediaRec.state === "inactive") {
                const s = await navigator.mediaDevices.getUserMedia({audio:true});
                mediaRec = new MediaRecorder(s);
                mediaRec.ondataavailable = e => chunks.push(e.data);
                mediaRec.onstop = () => {
                    const blob = new Blob(chunks, {type:'audio/mp3'});
                    const r = new FileReader();
                    r.readAsDataURL(blob);
                    r.onloadend = () => enviar(null, r.result, 'audio/mp3');
                    chunks = []; this.classList.remove('recording');
                };
                mediaRec.start(); this.classList.add('recording');
            } else { mediaRec.stop(); }
        };

        document.getElementById('btnLogout').onclick = () => signOut(auth);
    </script>
</body>
</html>
