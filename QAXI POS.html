<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>QAXI POS | Sistema de Gesti√≥n</title>
    
    <link rel="icon" href="logo.png" type="image/png">

    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <!-- Html5 QR Code for camera-based barcode scanning -->
    <script src="https://unpkg.com/html5-qrcode@2.3.7/minified/html5-qrcode.min.js"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;800&display=swap');
        body { font-family: 'Inter', sans-serif; background-color: #0f172a; color: #e2e8f0; }
        :root{ --bg:#0f172a; --muted:#94a3b8; --accent:#3b82f6; --glass-bg: rgba(30,41,59,0.6); }
        .glass { background: linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.00)); backdrop-filter: blur(8px); border: 1px solid rgba(255, 255, 255, 0.04); }
        .card { background: var(--glass-bg); border-radius: 12px; padding: 12px; }
        .sidebar-link:hover { background-color: #2563eb; color: white; transform: translateX(5px); }
        .sidebar-link { transition: all 0.3s ease; }
        
        /* Loader */
        .loader { border: 4px solid #f3f3f3; border-top: 4px solid #3498db; border-radius: 50%; width: 30px; height: 30px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        
        .hidden-force { display: none !important; }
        .fade-in { animation: fadeIn 0.5s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .logo-img { background: transparent !important; mix-blend-mode: normal; filter: none; }
    </style>
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#0f172a">
</head>
<body class="h-screen overflow-hidden flex flex-col">

    <div id="login-screen" class="absolute inset-0 z-50 bg-slate-900 flex items-center justify-center p-4">
        <div class="glass max-w-md w-full p-8 rounded-2xl shadow-2xl border-t-4 border-blue-600 relative overflow-hidden">
            <div class="absolute -top-10 -right-10 w-32 h-32 bg-blue-600 rounded-full blur-3xl opacity-20"></div>

            <div class="text-center mb-8 relative z-10">
                <img src="logo.png" alt="QAXI Logo" class="logo-img w-16 h-16 mx-auto mb-4 rounded-xl shadow-lg">
                <h1 class="text-3xl font-bold text-white tracking-tight">QAXI <span class="text-blue-500">POS</span></h1>
                <p class="text-slate-400 text-sm mt-2">Inicia sesi√≥n para cargar tu negocio</p>
            </div>

            <form id="auth-form" class="space-y-4 relative z-10">
                <div>
                    <label class="block text-xs font-bold text-slate-400 mb-1 uppercase">Correo Electr√≥nico</label>
                    <div class="relative">
                        <i class="fa-solid fa-envelope absolute left-3 top-3.5 text-slate-500"></i>
                        <input type="email" id="email" class="w-full bg-slate-800 border border-slate-700 rounded-lg py-3 pl-10 text-white focus:outline-none focus:border-blue-500 transition" placeholder="tu@negocio.com" required>
                    </div>
                </div>
                <div>
                    <label class="block text-xs font-bold text-slate-400 mb-1 uppercase">Contrase√±a</label>
                    <div class="relative">
                        <i class="fa-solid fa-lock absolute left-3 top-3.5 text-slate-500"></i>
                        <input type="password" id="password" class="w-full bg-slate-800 border border-slate-700 rounded-lg py-3 pl-10 text-white focus:outline-none focus:border-blue-500 transition" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" required>
                    </div>
                </div>

                <div id="auth-error" class="text-red-400 text-sm text-center hidden">Error de credenciales</div>

                <button type="submit" id="btn-login" class="w-full bg-blue-600 hover:bg-blue-500 text-white font-bold py-3 rounded-lg shadow-lg shadow-blue-900/50 transition transform hover:scale-[1.02]">
                    ENTRAR AL SISTEMA
                </button>
                
                <!-- Registration is removed; credentials are given by the owner -->
            </form>
            
            <div id="loading-overlay" class="absolute inset-0 bg-slate-900/90 flex flex-col items-center justify-center hidden z-20">
                <div class="loader mb-3"></div>
                <p class="text-white text-sm animate-pulse">Conectando...</p>
            </div>
        </div>
    </div>

    <div id="app-screen" class="flex h-full hidden-force">
        
        <aside class="w-64 bg-slate-900 border-r border-slate-800 flex flex-col justify-between hidden md:flex">
            <div>
                <div class="p-6 flex items-center gap-3 border-b border-slate-800/50">
                    <img src="logo.png" class="logo-img w-8 h-8 rounded" alt="QAXI">
                    <h1 class="text-xl font-bold tracking-tight text-white">QAXI <span class="text-blue-500 text-xs bg-blue-900/30 px-2 py-1 rounded">POS</span></h1>
                </div>
                
                <nav class="mt-6 px-4 space-y-2">
                    <a href="#" onclick="window.app.showSection('dashboard')" class="sidebar-link flex items-center gap-3 px-4 py-3 rounded-lg text-slate-400 hover:text-white bg-slate-800/50" id="nav-dashboard">
                        <i class="fa-solid fa-chart-line w-5"></i> Dashboard
                    </a>
                    <a href="#" onclick="window.app.showSection('pos')" class="sidebar-link flex items-center gap-3 px-4 py-3 rounded-lg text-slate-400 hover:text-white" id="nav-pos">
                        <i class="fa-solid fa-cash-register w-5"></i> Punto de Venta
                    </a>
                    <a href="#" onclick="window.app.showSection('inventory')" class="sidebar-link flex items-center gap-3 px-4 py-3 rounded-lg text-slate-400 hover:text-white" id="nav-inventory">
                        <i class="fa-solid fa-boxes-stacked w-5"></i> Inventario
                    </a>
                    <a href="#" onclick="window.app.showSection('history')" class="sidebar-link flex items-center gap-3 px-4 py-3 rounded-lg text-slate-400 hover:text-white" id="nav-history">
                        <i class="fa-solid fa-clock-rotate-left w-5"></i> Historial
                    </a>
                    <a href="#" onclick="window.app.showSection('expenses')" class="sidebar-link flex items-center gap-3 px-4 py-3 rounded-lg text-slate-400 hover:text-white" id="nav-expenses">
                        <i class="fa-solid fa-wallet w-5"></i> Gastos
                    </a>
                    <a href="#" onclick="window.app.showTutorial()" class="sidebar-link flex items-center gap-3 px-4 py-3 rounded-lg text-slate-400 hover:text-white" id="nav-tutorial">
                        <i class="fa-solid fa-circle-question w-5"></i> Tutorial
                    </a>
                </nav>
            </div>
            
            <div class="p-4 bg-slate-800/30 m-4 rounded-xl border border-slate-700/50">
                <div class="flex items-center gap-3 mb-3">
                    <div class="w-8 h-8 rounded-full bg-gradient-to-r from-blue-500 to-cyan-400 flex items-center justify-center text-xs font-bold text-white">
                        <i class="fa-solid fa-user"></i>
                    </div>
                    <div class="overflow-hidden">
                        <p class="text-white text-xs font-bold truncate" id="user-email-display">Usuario</p>
                        <p class="text-green-400 text-[10px]">‚óè Conectado</p>
                    </div>
                </div>
                <button onclick="window.app.logout()" class="w-full py-2 px-4 text-xs text-slate-300 bg-slate-800 hover:bg-red-900/80 hover:text-white rounded transition flex items-center justify-center gap-2">
                    <i class="fa-solid fa-right-from-bracket"></i> Cerrar Sesi√≥n
                </button>
            </div>
        </aside>

        <main class="flex-1 overflow-y-auto bg-slate-950 p-4 md:p-8 relative">
            
            <div class="md:hidden flex justify-between items-center mb-6">
                <div class="flex items-center gap-2">
                    <img src="logo.png" class="logo-img w-8 h-8 rounded">
                    <span class="text-white font-bold">QAXI POS</span>
                </div>
                <button onclick="window.app.logout()" class="text-red-400"><i class="fa-solid fa-power-off"></i></button>
            </div>

            <header class="hidden md:flex justify-between items-center mb-8">
                <div>
                    <h2 id="page-title" class="text-3xl font-bold text-white">Dashboard</h2>
                    <p class="text-slate-400 text-sm" id="page-subtitle">Vista general de tu negocio.</p>
                </div>
                <div class="flex items-center gap-3">
                    <button onclick="window.app.zReport()" class="text-sm bg-slate-800/40 text-white px-3 py-2 rounded">Cierre de Caja</button>
                </div>
            </header>

            <section id="dashboard" class="fade-in block space-y-6">
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                    <div class="glass p-6 rounded-xl border-l-4 border-blue-500">
                        <p class="text-slate-400 text-sm font-medium">Ventas Totales</p>
                        <h3 class="text-3xl font-bold text-white mt-2" id="dash-total">$0</h3>
                    </div>
                    <div class="glass p-6 rounded-xl border-l-4 border-cyan-500">
                        <p class="text-slate-400 text-sm font-medium">Transacciones</p>
                        <h3 class="text-3xl font-bold text-white mt-2" id="dash-count">0</h3>
                    </div>
                    <div class="glass p-6 rounded-xl border-l-4 border-orange-500">
                        <p class="text-slate-400 text-sm font-medium">Valor Inventario</p>
                        <h3 class="text-3xl font-bold text-white mt-2" id="dash-products">$0</h3>
                    </div>
                </div>
                <div class="glass p-4 rounded-xl">
                    <p class="text-slate-400 text-sm">Ganancia potencial estimada</p>
                    <h4 class="text-white font-bold mt-2" id="dash-profit">$0</h4>
                </div>
                <div class="glass p-6 rounded-xl">
                    <h3 class="text-white font-bold mb-4">Rendimiento</h3>
                    <div class="h-64 w-full relative">
                        <canvas id="salesChart"></canvas>
                    </div>
                    <div class="mt-4 h-40 w-full relative">
                        <p class="text-slate-400 text-sm mb-2">Comparativa: Hoy vs Ayer</p>
                        <canvas id="compareChart" class="w-full h-32"></canvas>
                    </div>
                </div>
                <!-- Analista de Ventas eliminado por solicitud del usuario -->
            </section>

            <section id="pos" class="fade-in hidden h-[calc(100vh-140px)]">
                <div class="flex flex-col lg:flex-row gap-6 h-full">
                    <div class="lg:w-2/3 flex flex-col h-full">
                        <div class="bg-slate-900 p-2 rounded-lg mb-4 flex gap-2">
                            <div class="relative flex-1">
                                <i class="fa-solid fa-search absolute left-3 top-3.5 text-slate-500"></i>
                                    <input type="text" id="search-pos" placeholder="Buscar producto..." class="w-full bg-slate-800 border-none text-white rounded px-10 py-3 focus:ring-2 focus:ring-blue-500" onkeyup="window.app.renderPOS()">
                                    <!-- Controles AI removidos -->
                            </div>
                            <div class="hidden sm:flex items-center gap-2">
                                <select id="category-filter" onchange="window.app.renderPOS()" class="bg-slate-800 text-slate-300 px-3 py-2 rounded">
                                    <option value="">Todas</option>
                                </select>
                                <button id="open-scanner" onclick="window.app.toggleScanner()" class="bg-blue-600 hover:bg-blue-500 text-white px-3 py-2 rounded">Escanear</button>
                            </div>
                        </div>
                        <div id="scanner-container" class="hidden mb-4">
                            <div id="qr-reader" style="width:100%; min-height:160px; background:#071022; border-radius:8px; display:flex;align-items:center;justify-content:center;color:var(--muted)">C√°mara inactiva</div>
                            <div class="mt-2 grid grid-cols-1 gap-2">
                                <div class="flex gap-2">
                                    <input id="manual-barcode" placeholder="Ingresar c√≥digo manualmente" class="flex-1 bg-slate-800 text-white rounded px-3 py-2">
                                    <button onclick="(function(){ const v=document.getElementById('manual-barcode').value; if(v) handleBarcodeScanned(v); })()" class="px-3 py-2 bg-emerald-600 rounded text-white">Agregar</button>
                                </div>
                                <div class="text-xs text-slate-400">Si la c√°mara no funciona, ingresa manualmente el c√≥digo o abre esta p√°gina desde un servidor (ej: <code>python3 -m http.server</code>) o en HTTPS para permitir acceso a la c√°mara.</div>
                                <div class="flex justify-end">
                                    <button onclick="window.app.toggleScanner()" class="px-3 py-1 bg-red-600 rounded text-white">Cerrar</button>
                                </div>
                            </div>
                        </div>
                        <div id="pos-grid" class="grid grid-cols-2 sm:grid-cols-3 xl:grid-cols-4 gap-4 overflow-y-auto pr-2 pb-20">
                            </div>
                    </div>
                    <div class="lg:w-1/3 glass rounded-xl flex flex-col h-full border border-slate-700">
                        <div class="p-4 border-b border-slate-700 flex justify-between items-center">
                            <h3 class="font-bold text-white text-lg"><i class="fa-solid fa-receipt mr-2"></i>Orden</h3>
                            <button onclick="window.app.clearCart()" class="text-xs text-red-400 hover:text-red-300">Vaciar</button>
                        </div>
                        <div id="cart-items" class="flex-1 overflow-y-auto p-4 space-y-3">
                            <div class="text-center text-slate-500 mt-10">Carrito vac√≠o</div>
                        </div>
                        <div class="p-4 bg-slate-900 border-t border-slate-700 rounded-b-xl">
                            <div class="flex justify-between text-white text-xl font-bold mb-4">
                                <span>Total</span>
                                <span id="cart-total">$0</span>
                            </div>
                            <div class="mb-3">
                                <label class="text-xs text-slate-400">M√©todo de pago</label>
                                <select id="payment-method" class="w-full mt-1 bg-slate-800 text-white rounded px-3 py-2">
                                    <option value="cash">Efectivo</option>
                                    <option value="transfer">Transferencia</option>
                                    <option value="card">Tarjeta</option>
                                </select>
                            </div>
                            <button onclick="window.app.processSale()" class="w-full bg-gradient-to-r from-blue-600 to-cyan-600 hover:from-blue-500 hover:to-cyan-500 text-white font-bold py-3 rounded-lg transition shadow-lg">
                                COBRAR
                            </button>
                        </div>
                    </div>
                </div>
            </section>

            <section id="inventory" class="fade-in hidden pb-20">
                <div class="flex flex-col sm:flex-row justify-between items-center mb-6 gap-4">
                    <h3 class="text-xl text-white font-bold">Gesti√≥n de Productos</h3>
                    <div class="flex gap-2 w-full sm:w-auto">
                        <button onclick="window.app.addNewProduct()" class="bg-blue-600 hover:bg-blue-500 text-white px-4 py-2 rounded-lg font-medium transition flex items-center gap-2 shadow-lg shadow-blue-900/30">
                            <i class="fa-solid fa-plus"></i> Nuevo
                        </button>
                        <button onclick="window.app.exportInventoryCSV()" class="bg-slate-700 hover:bg-slate-600 text-white px-4 py-2 rounded-lg font-medium transition flex items-center gap-2">
                            <i class="fa-solid fa-file-csv"></i> Exportar
                        </button>
                    </div>
                </div>
                
                <div id="empty-inventory-msg" class="hidden text-center py-20">
                    <div class="w-20 h-20 bg-slate-800 rounded-full flex items-center justify-center mx-auto mb-4 text-slate-600 text-3xl">
                        <i class="fa-solid fa-box-open"></i>
                    </div>
                    <h3 class="text-white text-xl font-bold">Inventario Vac√≠o</h3>
                    <p class="text-slate-400 mb-6">Agrega tus productos para empezar a vender.</p>
                </div>

                <div class="glass rounded-xl overflow-hidden overflow-x-auto" id="inventory-container">
                    <table class="w-full text-left text-slate-400">
                        <thead class="bg-slate-800 text-white uppercase text-xs font-bold">
                            <tr>
                                <th class="px-6 py-4">Producto</th>
                                <th class="px-6 py-4">Precio</th>
                                <th class="px-6 py-4">Valor</th>
                                <th class="px-6 py-4">Stock</th>
                                <th class="px-6 py-4 text-right">Editar</th>
                            </tr>
                        </thead>
                        <tbody id="inventory-table" class="divide-y divide-slate-700"></tbody>
                    </table>
                </div>
            </section>

            <section id="history" class="fade-in hidden">
                 <div class="glass rounded-xl overflow-hidden overflow-x-auto">
                    <table class="w-full text-left text-slate-400">
                        <thead class="bg-slate-800 text-white uppercase text-xs font-bold">
                            <tr>
                                <th class="px-6 py-4">Fecha</th>
                                <th class="px-6 py-4">Total</th>
                                <th class="px-6 py-4">Estado</th>
                            </tr>
                        </thead>
                        <tbody id="history-table" class="divide-y divide-slate-700"></tbody>
                    </table>
                </div>
            </section>

            <section id="expenses" class="fade-in hidden">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-xl text-white font-bold">Gastos / Egresos</h3>
                    <button onclick="window.app.addExpense()" class="bg-red-600 hover:bg-red-500 text-white px-3 py-2 rounded">Nuevo Gasto</button>
                </div>

                <div class="glass p-4 rounded-xl mb-4">
                    <div id="expenses-list" class="space-y-3 text-slate-300">
                        <div class="text-slate-500">No hay gastos registrados</div>
                    </div>
                </div>
            </section>

        </main>
    </div>

    <script type="module">
        // --- 1. FIREBASE IMPORTS & CONFIG ---
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, signInWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc, updateDoc, arrayUnion } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyDbZAPtQioiXZzkiiIRrkrBkEPF440NMaE",
            authDomain: "qaxi-93d6d.firebaseapp.com",
            projectId: "qaxi-93d6d",
            storageBucket: "qaxi-93d6d.firebasestorage.app",
            messagingSenderId: "137240859996",
            appId: "1:137240859996:web:73e14d28c77233be965d99",
            measurementId: "G-C74Z1DWV54"
        };

        // Init
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // --- 2. GLOBAL STATE ---
        let currentUser = null;
        let products = [];
        let sales = [];
        let cart = [];
        let expenses = [];
        let myChart = null;
        let compareChart = null;
        let scannerInstance = null;
        let lowStockThreshold = 5;

        // Quick success sound (Web Audio API)
        function playSuccessSound() {
            try {
                const ctx = new (window.AudioContext || window.webkitAudioContext)();
                const o = ctx.createOscillator();
                const g = ctx.createGain();
                o.type = 'sine';
                o.frequency.value = 880;
                g.gain.value = 0.0015;
                o.connect(g);
                g.connect(ctx.destination);
                o.start();
                g.gain.exponentialRampToValueAtTime(0.00001, ctx.currentTime + 0.15);
                o.stop(ctx.currentTime + 0.16);
            } catch (e) {
                // ignore audio errors
                console.warn('Audio not supported', e);
            }
        }

        // --- 3. EXPORTED FUNCTIONS (Attached to Window for HTML access) ---
        window.app = {
            logout: () => signOut(auth),
            
            showSection: (id) => {
                document.querySelectorAll('section').forEach(el => el.classList.add('hidden'));
                const section = document.getElementById(id);
                if(section) {
                    section.classList.remove('hidden');
                    section.classList.add('fade-in');
                }
                
                // Active link style
                document.querySelectorAll('.sidebar-link').forEach(l => l.classList.remove('bg-slate-800/50', 'text-white'));
                const navLink = document.getElementById(`nav-${id}`);
                if(navLink) navLink.classList.add('bg-slate-800/50', 'text-white');

                // Titles
                const titles = { 'dashboard': 'Dashboard', 'pos': 'Punto de Venta', 'inventory': 'Inventario', 'history': 'Historial', 'expenses': 'Gastos' };
                document.getElementById('page-title').innerText = titles[id] || 'QAXI POS';
                
                if(id === 'pos') renderPOS();
                if(id === 'dashboard') updateDashboard();
            },

            addToCart: (id) => {
                const product = products.find(p => p.id === id);
                if(product.stock <= 0) {
                    Swal.fire({ toast: true, position: 'bottom-end', icon: 'error', title: 'Sin Stock', background: '#1e293b', color: '#fff', showConfirmButton: false, timer: 1500 });
                    return;
                }
                const existing = cart.find(item => item.id === id);
                if(existing) {
                    if(existing.qty >= product.stock) return;
                    existing.qty++;
                } else {
                    cart.push({ ...product, qty: 1 });
                }
                renderCart();
            },

            removeFromCart: (index) => {
                cart.splice(index, 1);
                renderCart();
            },

            clearCart: () => {
                cart = [];
                renderCart();
            },

            processSale: async () => {
                if(cart.length === 0) return;
                
                Swal.fire({ title: 'Procesando...', allowOutsideClick: false, didOpen: () => Swal.showLoading(), background: '#1e293b', color: '#fff' });
                // Update Local State and compute totals with discounts
                cart.forEach(cartItem => {
                    const product = products.find(p => p.id === cartItem.id);
                    if(product) product.stock -= cartItem.qty;
                });

                const total = cart.reduce((acc, i) => {
                    const line = i.price * i.qty;
                    let discountAmount = 0;
                    if (i.discount) {
                        if (i.discount.type === 'percent') discountAmount = line * (Number(i.discount.value) / 100);
                        else discountAmount = Number(i.discount.value) || 0;
                    }
                    return acc + Math.max(0, line - discountAmount);
                }, 0);

                const paymentMethod = document.getElementById('payment-method') ? document.getElementById('payment-method').value : 'cash';

                const newSale = {
                    id: Date.now(),
                    date: new Date().toISOString(),
                    total: total,
                    paymentMethod: paymentMethod,
                    items: cart.map(i => ({ id: i.id, name: i.name, qty: i.qty, price: i.price, discount: i.discount || null }))
                };

                sales.push(newSale);

                // SAVE TO FIREBASE
                try {
                    const userRef = doc(db, "QAXI_POS_DATA", currentUser.uid);
                    await updateDoc(userRef, {
                        products: products, // Update stock
                        sales: arrayUnion(newSale)
                    });

                    // Print ticket
                    try { createTicketWindow(newSale); } catch(e){ console.warn('print failed', e); }

                    cart = [];
                    renderCart();
                    renderPOS();
                    renderInventory();
                    renderHistory();
                    updateDashboard();
                    playSuccessSound();

                    Swal.fire({ icon: 'success', title: '¬°Venta Guardada!', text: 'Venta registrada localmente', background: '#1e293b', color: '#fff', timer: 1600, showConfirmButton: false});

                } catch (error) {
                    console.error("Error saving sale:", error);
                    Swal.fire({ icon: 'error', title: 'Error', text: 'No se pudo guardar.', background: '#1e293b', color: '#fff'});
                }
            },

            addNewProduct: async () => {
                const { value: formValues } = await Swal.fire({
                    title: 'Nuevo Producto',
                    background: '#1e293b', color: '#fff',
                            html:
                                '<input id="swal-name" class="swal2-input" placeholder="Nombre (ej. Coca Cola)" style="background:#334155; color:white; border:none;">' +
                                '<input id="swal-price" type="number" class="swal2-input" placeholder="Precio (ej. 5000)" style="background:#334155; color:white; border:none;">' +
                                '<input id="swal-cost" type="number" class="swal2-input" placeholder="Costo (ej. 3000)" style="background:#334155; color:white; border:none;">' +
                                '<input id="swal-stock" type="number" class="swal2-input" placeholder="Stock Inicial" style="background:#334155; color:white; border:none;">' +
                                '<input id="swal-category" class="swal2-input" placeholder="Categor√≠a (ej. Bebidas)" style="background:#334155; color:white; border:none;">' +
                                '<input id="swal-barcode" class="swal2-input" placeholder="C√≥digo de barras (opcional)" style="background:#334155; color:white; border:none;">' +
                                '<div style="display:flex;align-items:center;gap:8px;justify-content:center;margin-top:8px;">' +
                                  '<label style="font-size:13px;color:#cbd5e1;">' +
                                    '<input id="swal-addlogo" type="checkbox" style="margin-right:8px;" onchange="document.getElementById(\'swal-logo\').style.display = this.checked ? \"block\" : \"none\"">' +
                                    'Agregar logo al producto' +
                                  '</label>' +
                                '</div>' +
                                '<input id="swal-logo" type="file" accept="image/*" class="swal2-file" style="margin-top:8px; display:none;">' +
                                '<input id="swal-image" type="file" accept="image/*" class="swal2-file" style="margin-top:8px;">',
                            focusConfirm: false,
                            preConfirm: () => {
                                return new Promise((resolve) => {
                                    const name = document.getElementById('swal-name').value;
                                    const price = document.getElementById('swal-price').value;
                                    const cost = document.getElementById('swal-cost').value || 0;
                                    const stock = document.getElementById('swal-stock').value;
                                    const fileInput = document.getElementById('swal-image');
                                    const addLogo = document.getElementById('swal-addlogo').checked;
                                    const logoInput = document.getElementById('swal-logo');
                                    if (!name || !price || !stock) return Swal.showValidationMessage('Completa todos los campos');

                                    const result = { image: null, logo: null };
                                    const readers = [];

                                    if (fileInput && fileInput.files && fileInput.files[0]) {
                                        readers.push(new Promise((r) => {
                                            const reader = new FileReader();
                                            reader.onload = () => { result.image = reader.result; r(); };
                                            reader.readAsDataURL(fileInput.files[0]);
                                        }));
                                    }

                                    if (addLogo && logoInput && logoInput.files && logoInput.files[0]) {
                                        readers.push(new Promise((r) => {
                                            const reader = new FileReader();
                                            reader.onload = () => { result.logo = reader.result; r(); };
                                            reader.readAsDataURL(logoInput.files[0]);
                                        }));
                                    }

                                    if (readers.length) {
                                        Promise.all(readers).then(() => resolve([name, price, cost, stock, document.getElementById('swal-category').value, document.getElementById('swal-barcode').value, result.image, result.logo]));
                                    } else {
                                        resolve([name, price, cost, stock, document.getElementById('swal-category').value, document.getElementById('swal-barcode').value, null, null]);
                                    }
                                });
                            }
                });

                if (formValues) {
                    const newProd = {
                        id: Date.now(),
                        name: formValues[0],
                        price: Number(formValues[1]),
                        cost: Number(formValues[2]) || 0,
                        stock: Number(formValues[3]) || 0,
                        icon: 'fa-box',
                        color: 'bg-blue-600',
                        category: formValues[4] || '',
                        barcode: formValues[5] || null,
                        image: formValues[6] || null,
                        logo: formValues[7] || null
                    };

                    products.push(newProd);
                    populateCategoryFilter();
                    
                    // Sync Firebase
                    try {
                        await updateDoc(doc(db, "QAXI_POS_DATA", currentUser.uid), { products: products });
                        renderInventory();
                        renderPOS();
                        updateDashboard();
                        Swal.fire({ icon: 'success', title: 'Producto Agregado', toast: true, position: 'top-end', showConfirmButton: false, timer: 1500, background: '#1e293b', color: '#fff' });
                    } catch (e) {
                        console.error(e);
                        Swal.fire('Error', 'No se pudo guardar', 'error');
                    }
                }
            },

            exportInventoryCSV: function() {
                const rows = ['Nombre,Precio,Costo,Stock,Valor'];
                products.forEach(p => {
                    const val = (p.price || 0) * (p.stock || 0);
                    rows.push(`"${p.name}",${p.price || 0},${p.cost || 0},${p.stock || 0},${val}`);
                });
                const csv = rows.join('\n');
                const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url; a.download = `inventory_${Date.now()}.csv`; a.click();
                URL.revokeObjectURL(url);
            },

            editStock: async (id) => {
                const product = products.find(p => p.id === id);
                const { value: newStock } = await Swal.fire({
                    title: `Editar Stock: ${product.name}`,
                    input: 'number',
                    inputValue: product.stock,
                    background: '#1e293b', color: '#fff',
                    inputAttributes: { style: 'background:#334155; color:white; border:none; margin: 10px auto;' }
                });

                if (newStock) {
                    product.stock = parseInt(newStock);
                    await updateDoc(doc(db, "QAXI_POS_DATA", currentUser.uid), { products: products });
                    renderInventory();
                    renderPOS();
                }
            },
            deleteProduct: async (id) => {
                const product = products.find(p => p.id === id);
                const confirm = await Swal.fire({ title: `Borrar ${product.name}?`, text: 'Esta acci√≥n no se puede deshacer.', icon: 'warning', showCancelButton: true, confirmButtonText: 'Borrar', background: '#1e293b', color: '#fff' });
                if (confirm.isConfirmed) {
                    products = products.filter(p => p.id !== id);
                    try {
                        await updateDoc(doc(db, "QAXI_POS_DATA", currentUser.uid), { products: products });
                        renderInventory();
                        renderPOS();
                        updateDashboard();
                        Swal.fire({ icon: 'success', title: 'Producto borrado', toast: true, position: 'top-end', showConfirmButton: false, timer: 1200, background: '#1e293b', color: '#fff' });
                    } catch (e) {
                        console.error(e);
                        Swal.fire('Error', 'No se pudo guardar', 'error');
                    }
                }
            },
            
            renderPOS: renderPOS // Expose helper
            ,
            // Add multiple of same product to cart
            addMultipleToCart: (id, qty) => {
                const product = products.find(p => p.id === id);
                if (!product) return;
                if (product.stock <= 0) return;
                const existing = cart.find(c => c.id === id);
                const addQty = Math.max(0, Math.min(qty, product.stock - (existing ? existing.qty : 0)));
                if (!existing) cart.push({ ...product, qty: addQty }); else existing.qty += addQty;
                renderCart();
            },
            // Cart-level discount percent (applied to total)
            cartDiscountPercent: 0
        };

        // --- Tutorial for new clients ---
        window.app.showTutorial = async function() {
            const steps = [
                { title: 'Bienvenido a QAXI POS', text: 'Este breve tutorial te mostrar√° las funciones principales.', icon: 'fa-solid fa-hand-holding-dollar' },
                { title: 'Punto de Venta', text: 'En la secci√≥n Punto de Venta puedes buscar productos y a√±adirlos al carrito. Usa el bot√≥n Escanear para abrir la c√°mara.', icon: 'fa-solid fa-cash-register' },
                { title: 'Carrito y Cobro', text: 'Revisa el carrito a la derecha. Pulsa COBRAR para registrar la venta, seleccionar m√©todo de pago y generar ticket.', icon: 'fa-solid fa-receipt' },
                { title: 'Inventario', text: 'En Inventario puedes agregar productos (con foto), categor√≠a y c√≥digo de barras; editar stock y borrarlos.', icon: 'fa-solid fa-boxes-stacked' },
                { title: 'Gastos', text: 'Registra gastos diarios en Gastos para obtener la ganancia real en el dashboard.', icon: 'fa-solid fa-wallet' },
                { title: 'Listo', text: '¬°Eso es todo! Si necesitas repetir el tutorial, pulsa Tutorial en el men√∫.', icon: 'fa-solid fa-circle-check' }
            ];

            for (const step of steps) {
                // eslint-disable-next-line no-await-in-loop
                const res = await Swal.fire({
                    title: step.title,
                    html: `<div style="display:flex;flex-direction:row;gap:12px;align-items:center;color:#e2e8f0"><div style=\"width:56px;height:56px;border-radius:12px;background:linear-gradient(180deg, rgba(59,130,246,0.14), rgba(59,130,246,0.06));display:flex;align-items:center;justify-content:center;\"><i class=\"${step.icon} fa-lg\" style=\"color:var(--accent)\"></i></div><div style=\"max-width:360px;text-align:left\">${step.text}</div></div>`,
                    showCancelButton: true,
                    confirmButtonText: 'Siguiente',
                    cancelButtonText: 'Cerrar',
                    background: '#0f172a', color: '#fff'
                });
                if (res.dismiss === Swal.DismissReason.cancel) break;
            }
        };

        // --- 4. INTERNAL LOGIC ---

        // Auth Listener with strict pos_active license check
        onAuthStateChanged(auth, async (user) => {
            const loginScreen = document.getElementById('login-screen');
            const appScreen = document.getElementById('app-screen');
            const loading = document.getElementById('loading-overlay');

            if (user) {
                // Usuario logueado, ahora verificamos sus permisos
                currentUser = user;
                document.getElementById('user-email-display').innerText = user.email;
                loading.classList.remove('hidden'); 

                try {
                    const docRef = doc(db, "QAXI_POS_DATA", user.uid);
                    const docSnap = await getDoc(docRef);

                    if (docSnap.exists()) {
                        const data = docSnap.data();

                        // üîí BLOQUEO DE SEGURIDAD ABSOLUTO üîí
                        // Verificamos estrictamente si tiene el servicio POS.
                        // Usamos "=== true" para que undefined o null tambi√©n denieguen el acceso.
                        if (data.pos_active !== true) {
                            
                            Swal.fire({
                                icon: 'error',
                                title: 'Acceso Denegado',
                                html: `
                                    <p>Hola <b>${user.email}</b>,</p>
                                    <p class="mt-2">Tu cuenta de QAXI es v√°lida, pero <b>NO tienes contratado el servicio QAXI POS</b>.</p>
                                    <p class="text-sm text-slate-400 mt-2">Si tienes otros planes activos (Web, Marketing), estos no incluyen el acceso al sistema de punto de venta.</p>
                                `,
                                confirmButtonText: 'Entendido, Cerrar Sesi√≥n',
                                confirmButtonColor: '#ef4444',
                                allowOutsideClick: false,
                                allowEscapeKey: false,
                                background: '#1e293b', 
                                color: '#fff'
                            }).then(() => {
                                // Lo sacamos a la fuerza
                                signOut(auth);
                                location.reload();
                            });
                            
                            loading.classList.add('hidden');
                            return; // ‚õî AQU√ç SE MUERE EL PROCESO, NO CARGA NADA M√ÅS.
                        }

                        // SI PASA EL FILTRO, CARGAMOS SUS DATOS
                        products = data.products || [];
                        sales = data.sales || [];
                        expenses = data.expenses || [];

                        // Populate category filter
                        setTimeout(() => {
                            populateCategoryFilter();
                        }, 100);
                        
                        Swal.fire({ toast: true, position: 'top-end', icon: 'success', title: 'Licencia POS: Activa', background: '#1e293b', color: '#fff', showConfirmButton: false, timer: 2000 });

                    } else {
                        // === CLIENTE NUEVO ===
                        // Si se est√° registrando DESDE esta pantalla, asumimos que quiere el POS.
                        // Le damos el permiso inicial.
                        products = [];
                        sales = [];
                        
                        await setDoc(docRef, { 
                            products: [], 
                            sales: [], 
                            createdAt: new Date(),
                            email: user.email,
                            pos_active: true // ‚úÖ SE ACTIVA AL REGISTRARSE AQU√ç
                        });
                        
                        Swal.fire({ icon: 'info', title: 'Bienvenido a QAXI POS', text: 'Tu licencia ha sido activada.', background: '#1e293b', color: '#fff' });
                        // Mostrar tutorial tambi√©n para nuevos clientes
                        if (window.app && typeof window.app.showTutorial === 'function') window.app.showTutorial();
                    }

                    // UI Update (Solo si pas√≥ el filtro)
                    renderInventory();
                    renderPOS();
                    renderHistory();
                    renderExpenses();
                    updateDashboard();
                    if (window.app && typeof window.app.showLowStockAlerts === 'function') window.app.showLowStockAlerts();
                    
                    loginScreen.classList.add('hidden-force');
                    appScreen.classList.remove('hidden-force');

                } catch (error) {
                    console.error("Error fetching data:", error);
                    Swal.fire('Error', 'Problema de conexi√≥n verificando licencia.', 'error');
                    signOut(auth); // Por seguridad, si falla la red, cerramos sesi√≥n.
                } finally {
                    loading.classList.add('hidden');
                }

            } else {
                // Logged Out
                currentUser = null;
                loginScreen.classList.remove('hidden-force');
                appScreen.classList.add('hidden-force');
                loading.classList.add('hidden');
            }
        });

        // Login Logic (registration disabled; credentials provided by owner)
        const authForm = document.getElementById('auth-form');
        const btnLogin = document.getElementById('btn-login');

        authForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;
            const errorMsg = document.getElementById('auth-error');
            const loading = document.getElementById('loading-overlay');
            
            errorMsg.classList.add('hidden');
            loading.classList.remove('hidden');

            try {
                await signInWithEmailAndPassword(auth, email, password);
            } catch (error) {
                loading.classList.add('hidden');
                errorMsg.innerText = error.message;
                errorMsg.classList.remove('hidden');
            }
        });


        // --- UI RENDER FUNCTIONS ---
        
        function renderPOS() {
            const container = document.getElementById('pos-grid');
            const search = document.getElementById('search-pos').value.toLowerCase();
            container.innerHTML = '';

            if(products.length === 0) {
                container.innerHTML = `<div class="col-span-full text-center text-slate-500 py-10">No hay productos. Ve a Inventario para agregar.</div>`;
                return;
            }

            const rows = [];
            const category = (document.getElementById('category-filter') && document.getElementById('category-filter').value) || '';
            products.forEach(p => {
                if(p.name.toLowerCase().includes(search) && (category === '' || (p.category || '') === category)) {
                    const badgeClass = p.stock < 5 ? 'text-red-400' : 'text-slate-500';
                    const media = p.image ? `<img src="${p.image}" alt="${p.name}" class="h-10 w-10 object-cover rounded-lg mb-3 shadow-lg">` : `<div class="h-10 w-10 ${p.color || 'bg-blue-600'} rounded-lg flex items-center justify-center text-white mb-3 shadow-lg"><i class="fa-solid ${p.icon || 'fa-box'}"></i></div>`;
                        const logoBadge = p.logo ? `<img src="${p.logo}" class="absolute top-2 left-2 w-8 h-8 rounded-full border border-white/10 shadow-sm" alt="logo">` : '';
                        rows.push(`
                            <div onclick=\"window.app.addToCart(${p.id})\" class=\"glass p-4 rounded-xl cursor-pointer hover:bg-slate-800 transition group relative border border-slate-700/50\">
                                ${logoBadge}
                                <div class=\"absolute top-2 right-2 text-[10px] font-bold ${p.stock < 5 ? 'text-red-400' : 'text-slate-500'}\">Stock: ${p.stock}</div>
                                ${media}
                                <h4 class=\"font-bold text-white text-sm truncate\">${p.name}</h4>
                                <p class=\"text-blue-400 font-semibold text-xs mt-1\">$${p.price.toLocaleString()}</p>
                                ${p.category?`<div class=\"text-[10px] text-slate-400 mt-1\">${p.category}</div>`:''}
                            </div>
                        `);
                }
            });

            container.innerHTML = rows.join('');
        }

        function renderCart() {
            const container = document.getElementById('cart-items');
            if(cart.length === 0) {
                container.innerHTML = '<div class="text-center text-slate-500 mt-10 text-sm">Carrito vac√≠o</div>';
                document.getElementById('cart-total').innerText = '$0';
                return;
            }
            let total = 0;
            const rows = [];
            cart.forEach((item, index) => {
                const line = item.price * item.qty;
                let discountAmount = 0;
                if (item.discount) {
                    if (item.discount.type === 'percent') discountAmount = line * (Number(item.discount.value) / 100);
                    else discountAmount = Number(item.discount.value) || 0;
                }
                const finalLine = Math.max(0, line - discountAmount);
                total += finalLine;

                rows.push(`
                    <div class="flex justify-between items-center bg-slate-800/50 p-2 rounded mb-2 border-l-2 border-blue-500">
                        <div class="overflow-hidden w-2/3">
                            <p class="text-white text-xs font-bold truncate">${item.name}</p>
                            <p class="text-[10px] text-slate-400">${item.qty} x $${item.price.toLocaleString()}</p>
                            ${item.discount ? `<div class="text-[10px] text-amber-300">Descuento: ${item.discount.type==='percent'?item.discount.value+'%':'$'+Number(item.discount.value).toLocaleString()}</div>` : ''}
                        </div>
                        <div class="flex items-center gap-2">
                            <span class="text-blue-400 font-bold text-xs">$${finalLine.toLocaleString()}</span>
                            <button onclick="window.app.applyDiscountToCartItem(${index})" class="text-slate-300 hover:text-white text-xs px-2 py-1 bg-slate-800 rounded">Descuento</button>
                            <button onclick="window.app.removeFromCart(${index})" class="text-slate-500 hover:text-red-400"><i class="fa-solid fa-trash text-xs"></i></button>
                        </div>
                    </div>
                `);
            });

            container.innerHTML = rows.join('');
            document.getElementById('cart-total').innerText = '$' + total.toLocaleString();
        }

        function renderInventory() {
            const tbody = document.getElementById('inventory-table');
            const container = document.getElementById('inventory-container');
            const msg = document.getElementById('empty-inventory-msg');
            
            tbody.innerHTML = '';

            if(products.length === 0) {
                container.classList.add('hidden');
                msg.classList.remove('hidden');
                return;
            } else {
                container.classList.remove('hidden');
                msg.classList.add('hidden');
            }

            const rows = [];
            products.forEach(p => {
                const imgHtml = p.image ? `<img src="${p.image}" class="w-8 h-8 rounded object-cover" alt="${p.name}">` : `<div class="w-8 h-8 rounded bg-slate-800 flex items-center justify-center text-xs text-blue-400"><i class="fa-solid ${p.icon}"></i></div>`;
                const smallLogo = p.logo ? `<img src="${p.logo}" class="w-5 h-5 rounded-full ml-2 object-cover" alt="logo">` : '';
                rows.push(`
                    <tr class="hover:bg-slate-800/50 transition border-b border-slate-800/50 last:border-0">
                        <td class="px-6 py-4 flex items-center gap-3">
                            ${imgHtml}
                            <span class="text-white font-medium text-sm">${p.name}</span>
                            ${smallLogo}
                        </td>
                        <td class="px-6 py-4 text-sm">$${p.price.toLocaleString()}</td>
                        <td class="px-6 py-4 text-sm">$${(p.price * p.stock).toLocaleString()}</td>
                        <td class="px-6 py-4">
                            <span class="px-2 py-1 rounded text-[10px] font-bold ${p.stock < 5 ? 'bg-red-900/50 text-red-300' : 'bg-green-900/30 text-green-300'}">
                                ${p.stock}
                            </span>
                        </td>
                        <td class="px-6 py-4 text-right">
                            <button onclick=\"window.app.editStock(${p.id})\" class=\"text-blue-400 hover:text-white transition mr-3\"><i class=\"fa-solid fa-pen-to-square\"></i></button>
                            <button onclick=\"window.app.deleteProduct(${p.id})\" class=\"text-red-400 hover:text-white transition\"><i class=\"fa-solid fa-trash\"></i></button>
                        </td>
                    </tr>
                `);
            });

            tbody.innerHTML = rows.join('');
        }

        // Analista de Ventas (AI/LLM/voz) eliminado por solicitud del usuario.

        function renderHistory() {
            const tbody = document.getElementById('history-table');
            tbody.innerHTML = '';
            if (!sales || sales.length === 0) {
                tbody.innerHTML = '<tr><td colspan="3" class="px-6 py-4 text-center text-slate-500">No hay ventas registradas</td></tr>';
                return;
            }
            const rows = [];
            // Show most recent first
            sales.slice().reverse().forEach(s => {
                rows.push(`<tr>
                    <td class="px-6 py-4 text-sm">${new Date(s.date).toLocaleString()}</td>
                    <td class="px-6 py-4 text-sm">$${(s.total||0).toLocaleString()}</td>
                    <td class="px-6 py-4 text-sm">Completado</td>
                </tr>`);
            });
            tbody.innerHTML = rows.join('');
        };

        // --- Helpers: Categories, Scanner, Discounts, Expenses, Reports ---
        function populateCategoryFilter(){
            const sel = document.getElementById('category-filter');
            if(!sel) return;
            const cats = new Set();
            products.forEach(p => { if(p.category) cats.add(p.category); });
            // Clear existing except 'Todas'
            sel.innerHTML = '<option value="">Todas</option>' + Array.from(cats).map(c => `<option value="${c}">${c}</option>`).join('');
        }

        window.app.toggleScanner = function(){
            const container = document.getElementById('scanner-container');
            if(!container) return;
            if(container.classList.contains('hidden')){
                container.classList.remove('hidden');
                startScanner();
            } else {
                stopScanner();
                container.classList.add('hidden');
            }
        };

        function startScanner(){
            if(typeof Html5Qrcode === 'undefined') return Swal.fire('Error','Lector no disponible (m√≥dulo no cargado)','error');
            // Quick checks: file:// and mediaDevices
            if(location.protocol === 'file:' || !navigator.mediaDevices || !navigator.mediaDevices.getUserMedia){
                Swal.fire({
                    icon: 'warning',
                    title: 'C√°mara no disponible',
                    html: `La p√°gina se est√° ejecutando desde <b>${location.protocol}</b> o el navegador no permite acceder a la c√°mara.\n
                        Abre el archivo desde un servidor local (ejecute en la carpeta del proyecto):<br>
                        <code>python3 -m http.server 8000</code><br>
                        y luego abre <b>http://localhost:8000/QAXI%20POS.html</b>.\n
                        En iOS/alg√∫n Safari puede requerir HTTPS o usar Chrome/Edge en escritorio.`,
                    background: '#1e293b', color: '#fff'
                });
                return;
            }
            const qrRegionId = 'qr-reader';
            // If already running, clear first
            if(scannerInstance){ try{ scannerInstance.clear(); }catch(e){} scannerInstance = null; }
            Html5Qrcode.getCameras().then(cameras => {
                const cameraId = (cameras && cameras.length) ? cameras[0].id : undefined;
                scannerInstance = new Html5Qrcode(qrRegionId);
                const config = { fps: 10, qrbox: 250 };
                if(cameraId){
                    scannerInstance.start(cameraId, config, (decodedText, decodedResult) => {
                        handleBarcodeScanned(decodedText);
                    }, (error) => {
                        // per-frame parse error (ignore)
                    }).catch(err => {
                        console.warn('scanner start error', err);
                        Swal.fire('Error', 'No se pudo iniciar la c√°mara o permisos denegados', 'error');
                    });
                } else {
                    // fallback: try to start with facingMode config
                    scannerInstance.start({ facingMode: "environment" }, config, (decodedText) => {
                        handleBarcodeScanned(decodedText);
                    }).catch(err => {
                        console.warn('scanner start error fallback', err);
                        Swal.fire('Error', 'No se pudo iniciar la c√°mara o permisos denegados', 'error');
                    });
                }
            }).catch(err => {
                console.warn('getCameras error', err);
                Swal.fire('Error','No se encontraron c√°maras disponibles','error');
            });
        }

        function stopScanner(){
            if(scannerInstance){
                try{ scannerInstance.stop().then(() => { scannerInstance.clear(); scannerInstance = null; }); }catch(e){ scannerInstance = null; }
            }
        }

        function handleBarcodeScanned(code){
            // Html5Qrcode passes decodedText string; normalize defensively
            const barcode = (typeof code === 'string') ? code : (code && code.decodedText) ? code.decodedText : (code?.result?.text || '');
            if(!barcode) return;
            // try to find product by barcode
            const prod = products.find(p => p.barcode && String(p.barcode) === String(barcode));
            if(prod){
                window.app.addToCart(prod.id);
                Swal.fire({ toast:true, position:'bottom-end', icon:'success', title:`A√±adido: ${prod.name}`, background:'#1e293b', color:'#fff', showConfirmButton:false, timer:1200 });
                // Stop scanner automatically for mobile convenience
                stopScanner();
                document.getElementById('scanner-container')?.classList.add('hidden');
            } else {
                Swal.fire({ toast:true, position:'bottom-end', icon:'warning', title:`C√≥digo no encontrado: ${barcode}`, background:'#1e293b', color:'#fff', showConfirmButton:false, timer:1600 });
            }
        }

        window.app.applyDiscountToCartItem = async function(index){
            const item = cart[index];
            if(!item) return;
            const { value: form } = await Swal.fire({
                title: `Descuento: ${item.name}`,
                html: '<input id="d-value" class="swal2-input" placeholder="Valor (ej: 500 o 10%)" style="background:#334155;color:white;border:none">',
                preConfirm: () => {
                    return document.getElementById('d-value').value;
                },
                background: '#1e293b', color: '#fff'
            });
            if(!form) return;
            // detect percent by trailing %
            const val = form.toString().trim();
            if(val.endsWith('%')){
                const num = parseFloat(val.replace('%','')) || 0;
                item.discount = { type: 'percent', value: num };
            } else {
                const num = parseFloat(val) || 0;
                item.discount = { type: 'amount', value: num };
            }
            renderCart();
        };

        window.app.addExpense = async function(){
            const { value: form } = await Swal.fire({
                title: 'Nuevo Gasto',
                html: '<input id="g-desc" class="swal2-input" placeholder="Descripci√≥n" style="background:#334155;color:white;border:none">' +
                      '<input id="g-amt" type="number" class="swal2-input" placeholder="Monto" style="background:#334155;color:white;border:none">',
                preConfirm: () => [document.getElementById('g-desc').value, document.getElementById('g-amt').value],
                background: '#1e293b', color: '#fff'
            });
            if(!form) return;
            const [desc, amt] = form;
            const expense = { id: Date.now(), date: new Date().toISOString(), description: desc || 'Gasto', amount: Number(amt) || 0 };
            expenses.push(expense);
            try{
                await updateDoc(doc(db, "QAXI_POS_DATA", currentUser.uid), { expenses: expenses });
                renderExpenses();
                updateDashboard();
                Swal.fire({ toast:true, position:'top-end', icon:'success', title:'Gasto registrado', showConfirmButton:false, timer:1200, background:'#1e293b', color:'#fff' });
            }catch(e){ console.error(e); Swal.fire('Error','No se pudo guardar','error'); }
        };

        function renderExpenses(){
            const el = document.getElementById('expenses-list');
            if(!el) return;
            if(!expenses || expenses.length === 0){ el.innerHTML = '<div class="text-slate-500">No hay gastos registrados</div>'; return; }
            const rows = expenses.slice().reverse().map(ex => `<div class="flex justify-between items-center bg-slate-800/40 p-2 rounded">
                <div>
                    <div class="text-white text-sm font-bold">${ex.description}</div>
                    <div class="text-[11px] text-slate-400">${new Date(ex.date).toLocaleString()}</div>
                </div>
                <div class="text-red-400 font-bold">-$${(ex.amount||0).toLocaleString()}</div>
            </div>`);
            el.innerHTML = rows.join('');
        }

        window.app.zReport = function(){
            const sinceLogin = sales || [];
            const totals = { cash:0, card:0, transfer:0 };
            let total = 0;
            sinceLogin.forEach(s => {
                total += s.total || 0;
                if(s.paymentMethod) totals[s.paymentMethod] = (totals[s.paymentMethod]||0) + (s.total||0);
            });
            const expTotal = (expenses || []).reduce((a,b) => a + (b.amount||0), 0);
            const html = `Ventas Totales: $${total.toLocaleString()}<br>
                Efectivo: $${(totals.cash||0).toLocaleString()}<br>
                Tarjeta: $${(totals.card||0).toLocaleString()}<br>
                Transferencia: $${(totals.transfer||0).toLocaleString()}<br>
                <hr>Gastos: $${expTotal.toLocaleString()}<br>
                <b>Total Neto: $${(total - expTotal).toLocaleString()}</b>`;
            Swal.fire({ title: 'Cierre de Caja', html: html, showCancelButton:true, confirmButtonText:'Imprimir Z', background:'#1e293b', color:'#fff' }).then(res => {
                if(res.isConfirmed){
                    // simple print of the report
                    const w = window.open('', '_blank');
                    w.document.write(`<pre style="font-family:sans-serif">Z-Report\n\n${html.replace(/<br>/g,'\n').replace(/<[^>]+>/g,'')}</pre>`);
                    w.print();
                }
            });
        };

        function createTicketWindow(sale){
            const w = window.open('', '_blank', 'width=300,height=600');
            const itemsHtml = sale.items.map(i => `${i.name} x${i.qty} $${i.price.toLocaleString()}${i.discount?(' - '+(i.discount.type==='percent'?i.discount.value+'%':'$'+i.discount.value)) : ''}`).join('<br>');
            const html = `
                <div style="font-family:monospace; padding:10px; width:220px">
                    <h3 style="text-align:center">QAXI POS</h3>
                    <div>Fecha: ${new Date(sale.date).toLocaleString()}</div>
                    <div>Pago: ${sale.paymentMethod || 'N/A'}</div>
                    <hr>
                    <div>${itemsHtml}</div>
                    <hr>
                    <div style="text-align:right; font-weight:bold">Total: $${sale.total.toLocaleString()}</div>
                    <div style="text-align:center; margin-top:10px; font-size:12px">Gracias por su compra</div>
                </div>
            `;
            w.document.write(html);
            w.document.close();
            setTimeout(()=>{ w.print(); }, 500);
        }

        window.app.showLowStockAlerts = function() {
            const low = (products || []).filter(p => (p.stock || 0) <= (lowStockThreshold || 5));
            if (low.length === 0) return;
            const list = low.map(p => `‚Ä¢ ${p.name} (stock: ${p.stock})`).join('<br>');
            Swal.fire({ icon: 'warning', title: `${low.length} productos con bajo stock`, html: list, background: '#1e293b', color: '#fff' });
        };

        function updateDashboard() {
            const totalSales = sales.reduce((sum, s) => sum + s.total, 0);
            document.getElementById('dash-total').innerText = '$' + totalSales.toLocaleString();
            document.getElementById('dash-count').innerText = sales.length;
            // Valor total del inventario
            const inventoryValue = products.reduce((sum, p) => sum + ((p.price || 0) * (p.stock || 0)), 0);
            document.getElementById('dash-products').innerText = '$' + inventoryValue.toLocaleString();

            // Ganancia potencial estimada (precio - costo) * stock
            const potentialProfit = products.reduce((sum, p) => sum + (((p.price || 0) - (p.cost || 0)) * (p.stock || 0)), 0);
            const profitEl = document.getElementById('dash-profit');
            // Calculate real profit: ventas - costo de bienes vendidos - gastos
            const revenue = sales.reduce((s, v) => s + (v.total || 0), 0);
            const costSold = (sales || []).reduce((acc, sale) => {
                const saleCost = (sale.items || []).reduce((si, it) => {
                    const prod = products.find(p => p.id === it.id || p.name === it.name);
                    return si + ((prod ? (prod.cost||0) : 0) * (it.qty || 0));
                }, 0);
                return acc + saleCost;
            }, 0);
            const expensesTotal = (expenses || []).reduce((a,b) => a + (b.amount||0), 0);
            const realProfit = Math.max(0, revenue - costSold - expensesTotal);
            if (profitEl) profitEl.innerText = '$' + realProfit.toLocaleString();

            // Simple Chart
            const ctx = document.getElementById('salesChart').getContext('2d');
            if(myChart) myChart.destroy();

            // Prepare Data (Last 5 Sales)
            const lastSales = sales.slice(-5); 
            const labels = lastSales.length ? lastSales.map(s => new Date(s.date).toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'})) : ['0', '0', '0'];
            const dataPoints = lastSales.length ? lastSales.map(s => s.total) : [0, 0, 0];

            myChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Ventas',
                        data: dataPoints,
                        borderColor: '#3b82f6',
                        backgroundColor: (context) => {
                            const ctx = context.chart.ctx;
                            const gradient = ctx.createLinearGradient(0, 0, 0, 200);
                            gradient.addColorStop(0, 'rgba(59,130,246,0.5)');
                            gradient.addColorStop(1, 'rgba(59,130,246,0)');
                            return gradient;
                        },
                        borderWidth: 2,
                        fill: true,
                        tension: 0.4,
                        pointRadius: 4,
                        pointBackgroundColor: '#fff'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { display: false } },
                    scales: {
                        y: { display: false },
                        x: { ticks: { color: '#64748b', font: { size: 10 } }, grid: { display: false } }
                    }
                }
            });

            // Comparative Chart: Hoy vs Ayer
            try{
                const now = new Date();
                const startToday = new Date(now); startToday.setHours(0,0,0,0);
                const startYesterday = new Date(startToday); startYesterday.setDate(startYesterday.getDate()-1);
                const endYesterday = new Date(startToday);
                const totalToday = (sales || []).reduce((s, sale) => { const d = new Date(sale.date); return s + ((d >= startToday) ? (sale.total||0) : 0); }, 0);
                const totalYesterday = (sales || []).reduce((s, sale) => { const d = new Date(sale.date); return s + ((d >= startYesterday && d < endYesterday) ? (sale.total||0) : 0); }, 0);
                const ctx2 = document.getElementById('compareChart').getContext('2d');
                if(compareChart) compareChart.destroy();
                compareChart = new Chart(ctx2, { type: 'bar', data: { labels: ['Ayer','Hoy'], datasets: [{ label: 'Ventas', data: [totalYesterday, totalToday], backgroundColor: ['#94a3b8','#3b82f6'] }] }, options: { maintainAspectRatio:false, plugins:{legend:{display:false}} } });
            }catch(e){ console.warn('compare chart', e); }
        }

    </script>
    <script>
        // Register service worker for PWA
        if('serviceWorker' in navigator){
            navigator.serviceWorker.register('service-worker.js').then(reg => {
                console.log('ServiceWorker registered', reg);
            }).catch(err => console.warn('SW register failed', err));
        }
    </script>
</body>
</html>