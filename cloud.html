<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>QAXI CLOUD | Titanium</title>
    <!-- Librerías: Firebase, FontAwesome, Marked (Markdown), JsPDF, Html2Canvas, MathJS -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mathjs/11.8.0/math.min.js"></script>
    
    <!-- Google Fonts - Más variedad y contraste -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;700&family=Playfair+Display:ital,wght@0,400;0,700;1,400&family=Lora:ital,wght@0,400;0,700;1,400&family=Merriweather:ital,wght@0,400;0,700;1,400&family=Dancing+Script:wght@400;700&family=Pacifico&family=Oswald:wght@400;700&family=Bebas+Neue&family=Roboto+Slab:wght@400;700&family=Abril+Fatface&family=Permanent+Marker&family=Caveat:wght@400;700&family=Satisfy&family=Great+Vibes&family=Lobster&display=swap" rel="stylesheet">

    <style>
        :root {
            --bg: #050505;
            --panel: rgba(20, 20, 20, 0.7);
            --border: #333333;
            --text: #e0e0e0;
            --gold: #D4AF37; 
            --gold-glow: rgba(212, 175, 55, 0.2);
            --font-main: 'Segoe UI', Roboto, sans-serif;
            --font-brand: 'Cinzel', serif; 
        }
        * { box-sizing: border-box; outline: none; }
        body {
            margin: 0; padding: 0;
            background-color: var(--bg);
            background-image: radial-gradient(circle at 50% 50%, #1a1a1a 0%, #000 100%);
            color: var(--text);
            font-family: var(--font-main);
            height: 100vh;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        /* --- Header --- */
        header {
            height: 60px;
            background: var(--panel);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border-bottom: 1px solid var(--border);
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 25px;
            z-index: 100;
            box-shadow: 0 5px 20px rgba(0,0,0,0.5);
        }
        .brand {
            font-family: var(--font-brand);
            font-size: 1.6rem;
            color: white;
            letter-spacing: 2px;
            display: flex;
            align-items: center;
            gap: 10px;
            text-shadow: 0 0 10px rgba(255,255,255,0.1);
        }
        .brand span { color: var(--gold); text-shadow: 0 0 10px var(--gold-glow); }
        .user-area { display: flex; align-items: center; gap: 15px; }
        
        .status-badge {
            font-size: 0.75rem;
            padding: 6px 14px;
            border-radius: 20px;
            background: rgba(255,255,255,0.05);
            border: 1px solid var(--border);
            color: #aaa;
            cursor: pointer;
            transition: all 0.3s ease;
            letter-spacing: 0.5px;
        }
        .status-badge:hover { background: rgba(255,255,255,0.1); color: white; }
        .status-badge.pro { 
            border-color: var(--gold); 
            color: var(--gold); 
            background: rgba(212,175,55,0.05);
        }
        .status-badge.pro:hover {
            background: var(--gold);
            color: black;
            box-shadow: 0 0 15px var(--gold-glow);
        }

        /* --- Main Layout --- */
        .main-container {
            display: flex;
            flex: 1;
            overflow: hidden;
        }

        /* Sidebar */
        .sidebar {
            width: 85px;
            background: var(--panel);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border-right: 1px solid var(--border);
            display: flex;
            flex-direction: column;
            align-items: center;
            padding-top: 30px;
            box-shadow: 5px 0 20px rgba(0,0,0,0.3);
            z-index: 90;
        }
        .app-icon {
            width: 50px; height: 50px;
            margin-bottom: 25px;
            border-radius: 14px;
            display: flex; flex-direction: column;
            justify-content: center; align-items: center;
            color: #777;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
            font-size: 1.3rem;
            background: transparent;
            border: 1px solid transparent;
            position: relative;
        }
        .app-icon:hover { 
            background: rgba(255,255,255,0.08); 
            color: white; 
            transform: translateY(-2px);
            border-color: rgba(255,255,255,0.1);
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
        }
        .app-icon i { margin-bottom: 3px; }
        .app-icon span { font-size: 0.5rem; letter-spacing: 1px; font-weight: 600; }
        
        .pro-tag {
            position: absolute; top: -5px; right: -5px;
            background: var(--gold); color: black;
            font-size: 0.5rem; padding: 2px 4px; border-radius: 4px;
            font-weight: 800; box-shadow: 0 0 5px var(--gold-glow);
        }

        /* Content Area */
        .content-area {
            flex: 1;
            position: relative;
            display: flex; flex-direction: column;
        }

        /* Hero / Dashboard */
        .hero {
            flex: 1;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            text-align: center;
            animation: fadeIn 0.8s ease;
            position: relative;
            height: 100%;
        }
        .hero h1 {
            font-family: var(--font-brand);
            font-size: 3.5rem;
            margin: 0 0 15px 0;
            background: linear-gradient(135deg, #fff 30%, #888 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            z-index: 2;
            text-shadow: 0 10px 30px rgba(0,0,0,0.5);
        }
        .hero p { 
            color: #888; font-size: 1.1rem; max-width: 450px; margin-bottom: 30px; z-index: 2; line-height: 1.6;
        }

        /* Modal Overlay (LOGIN) */
        .modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.85); backdrop-filter: blur(5px);
            z-index: 2000;
            display: none; justify-content: center; align-items: center;
        }
        .modal {
            background: #111; border: 1px solid var(--border);
            padding: 40px; border-radius: 12px; width: 350px;
            text-align: center; box-shadow: 0 20px 50px rgba(0,0,0,0.5);
        }
        .modal h2 { margin-top:0; color:white; font-family:var(--font-brand); margin-bottom: 10px; }
        .modal input { 
            width:100%; background:#050505; border:1px solid #333; 
            padding:12px; color:white; border-radius:6px; margin: 20px 0;
        }
        .modal input:focus { border-color:var(--gold); }

        /* --- Workspace (App Window) --- */
        #ws {
            position: absolute;
            top: 0; left: 0; width: 100%; height: 100%;
            background: #080808;
            display: none;
            flex-direction: column;
            z-index: 50;
            animation: zoomIn 0.3s cubic-bezier(0.16, 1, 0.3, 1);
        }
        .ws-header {
            height: 55px;
            background: #111;
            border-bottom: 1px solid #252525;
            display: flex; align-items: center;
            padding: 0 20px;
            justify-content: space-between;
        }
        .ws-title { font-family: var(--font-brand); color: white; letter-spacing: 1px; font-size: 1.2rem; }
        .ws-tools { display: flex; gap: 8px; align-items: center; }
        .nav-btn {
            background: #1a1a1a; 
            border: 1px solid #333;
            color: #ccc; 
            padding: 6px 14px; 
            cursor: pointer;
            font-size: 0.75rem; 
            letter-spacing: 1px;
            border-radius: 4px;
            transition: 0.2s;
        }
        .nav-btn:hover { border-color: var(--gold); color: white; background: #222; }
        .ws-stage { flex: 1; overflow: hidden; position: relative; background: #0c0c0c; }

        /* === APPS STYLES === */
        
        /* DOCS */
        .doc-toolbar {
            min-height: 44px; background: #161616; border-bottom: 1px solid #252525;
            display: flex; align-items: center; padding: 8px 15px; gap: 8px; flex-wrap: wrap;
        }
        .tb-btn {
            background: transparent; border: 1px solid transparent; color: #aaa; cursor: pointer;
            width: 32px; height: 32px; border-radius: 4px; display: flex; justify-content: center; align-items: center;
            transition: 0.2s;
        }
        .tb-btn:hover { background: #252525; color: white; border-color: #333; }
        .tb-select, .tb-input {
            background: #0a0a0a; color: #ddd; border: 1px solid #333;
            padding: 6px 10px; font-size: 0.8rem; border-radius: 4px; cursor: pointer;
        }
        .tb-select:focus, .tb-input:focus { border-color: var(--gold); }
        .sep { width: 1px; height: 24px; background: #333; margin: 0 6px; }
        #paper {
            width: 794px; min-height: 1123px;
            background: white; color: black;
            box-shadow: 0 0 30px rgba(0,0,0,0.6);
            margin: 30px; padding: 50px;
            outline: none; overflow-y: hidden;
            font-family: 'Segoe UI', sans-serif;
            font-size: 16px;
            line-height: 1.6;
        }
        .doc-status {
            height: 30px; background: #111; border-top: 1px solid #252525;
            display: flex; align-items: center; justify-content: space-between;
            padding: 0 15px; font-size: 0.75rem; color: #666;
        }
        
        /* Autosave indicator */
        .autosave-indicator {
            display: flex;
            align-items: center;
            gap: 5px;
            font-size: 0.7rem;
            color: #666;
            transition: 0.3s;
        }
        .autosave-indicator.saving { color: var(--gold); }
        .autosave-indicator.saved { color: #4a4; }
        
        /* Magic Writing Button */
        .magic-btn {
            background: linear-gradient(135deg, #D4AF37 0%, #aa8a2e 100%);
            color: black;
            border: none;
            padding: 6px 12px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.75rem;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 5px;
            transition: 0.3s;
        }
        .magic-btn:hover { transform: scale(1.05); box-shadow: 0 0 15px var(--gold-glow); }
        
        /* Font Select with Preview */
        .font-select-wrapper {
            position: relative;
        }
        #fontSelect {
            min-width: 150px;
        }
        #fontSelect option {
            padding: 8px;
            font-size: 14px;
        }

        /* SHEETS */
        .grid-container { width: 100%; height: calc(100% - 30px); overflow: auto; background: #151515; }
        .grid { border-collapse: separate; border-spacing: 0; min-width: 100%; table-layout: fixed; }
        .grid th, .grid td {
            border-right: 1px solid #333; border-bottom: 1px solid #333; 
            padding: 0; min-width: 80px; height: 26px;
            text-align: center; font-size: 0.85rem; color: #ccc; position: relative;
        }
        .grid th { background: #1f1f1f; color: #888; font-weight: 600; position: sticky; top: 0; left: 0; z-index: 2; }
        .grid td input {
            width: 100%; height: 100%; border: none; background: transparent;
            color: #eee; text-align: right; padding: 0 6px; font-family: 'Segoe UI', sans-serif;
        }
        .grid td input:focus { background: #000; outline: 2px solid var(--gold); z-index: 5; }

        /* AI CHAT */
        .ai-box {
            width: 100%; height: 100%; display: flex; flex-direction: column;
            background: #0c0c0c;
        }
        .chat-window {
            flex: 1; overflow-y: auto; padding: 30px;
            display: flex; flex-direction: column; gap: 20px;
        }
        .msg {
            max-width: 75%; padding: 15px 20px; border-radius: 12px;
            font-size: 0.95rem; line-height: 1.6; box-shadow: 0 2px 10px rgba(0,0,0,0.2);
        }
        .msg.ai { align-self: flex-start; background: #1a1a1a; border-left: 3px solid var(--gold); color: #ddd; }
        .msg.user { align-self: flex-end; background: #252525; color: white; border-right: 3px solid #555; }
        .msg strong { display: block; font-size: 0.75rem; color: var(--gold); margin-bottom: 6px; letter-spacing: 1px; }
        .ai-input-area {
            height: 80px; background: #111; border-top: 1px solid #252525;
            display: flex; align-items: center; padding: 0 30px; gap: 15px;
        }
        #aiInput {
            flex: 1; background: #050505; border: 1px solid #333;
            color: white; padding: 12px 15px; border-radius: 6px; font-size: 0.95rem;
            transition: 0.3s;
        }
        #aiInput:focus { border-color: var(--gold); box-shadow: 0 0 10px rgba(212,175,55,0.1); }
        .ai-input-area button {
            background: var(--gold); color: black; border: none; width: 40px; height: 40px;
            border-radius: 6px; cursor: pointer; transition: 0.2s;
        }
        .ai-input-area button:hover { transform: scale(1.05); }

        /* PDF & QR */
        .pdf-zone, .qr-wrapper { height: 100%; display:flex; flex-direction: column; align-items: center; justify-content: flex-start; padding-top:40px; }
        .qr-card {
            background: #181818; padding: 40px; border: 1px solid #333; border-radius: 12px;
            display: flex; flex-direction: column; align-items: center;
            width: 380px; box-shadow: 0 10px 40px rgba(0,0,0,0.6);
        }
        .pdf-list {
            margin-top: 20px; width: 80%; max-width: 600px;
            display: grid; grid-template-columns: repeat(auto-fill, minmax(100px, 1fr)); gap: 10px;
        }
        .pdf-item {
            background: #1a1a1a; padding: 10px; border-radius: 6px; border: 1px solid #333;
            font-size: 0.75rem; text-align: center; position: relative; overflow: hidden;
            display: flex; flex-direction: column; align-items: Center; aspect-ratio: 1;
        }
        .pdf-item i { font-size: 2rem; color: #555; margin-bottom: 5px; }
        .pdf-item .del { 
            position: absolute; top:0; right: 0; background: red; color:white; 
            width: 20px; height: 20px; cursor: pointer; font-size:0.7rem; display:flex; align-items:center; justify-content:center;
        }

        /* PRESENTATIONS TOOL */
        .slides-layout { display: flex; width: 100%; height: 100%; }
        .slides-sidebar {
            width: 160px; background: #111; border-right: 1px solid #252525;
            display: flex; flex-direction: column; padding: 10px; gap: 10px; overflow-y: auto;
        }
        .slide-thumb {
            width: 100%; aspect-ratio: 16/9; background: white; cursor: pointer;
            border: 2px solid transparent; transition: 0.2s; position: relative;
            overflow: hidden;
        }
        .slide-thumb.active { border-color: var(--gold); }
        .slide-thumb span {
            position: absolute; bottom: 2px; right: 4px; color: black; font-size: 10px; font-weight: bold;
        }
        .slides-main {
            flex: 1; background: #1a1a1a; display: flex; justify-content: center; align-items: center;
            position: relative; overflow: hidden;
        }
        .slide-canvas {
            width: 800px; height: 450px; background: white; box-shadow: 0 0 50px rgba(0,0,0,0.5);
            position: relative; overflow: hidden; color: black;
        }
        
        /* Draggable elements in slides */
        .slide-element {
            position: absolute;
            cursor: move;
            user-select: none;
            min-width: 50px;
            min-height: 20px;
            border: 2px solid transparent;
            transition: border-color 0.2s;
        }
        .slide-element:hover { border-color: rgba(212, 175, 55, 0.5); }
        .slide-element.selected { border-color: var(--gold); }
        .slide-element.editing { cursor: text; }
        .slide-element img { 
            width: 100%; height: 100%; object-fit: contain; 
            pointer-events: none;
        }
        
        /* Resize handle */
        .resize-handle {
            position: absolute;
            width: 12px; height: 12px;
            background: var(--gold);
            border-radius: 2px;
            bottom: -6px; right: -6px;
            cursor: nwse-resize;
        }

        /* Animaciones */
        @keyframes fadeIn { from {opacity:0; transform:translateY(15px);} to {opacity:1; transform:translateY(0);} }
        @keyframes zoomIn { from {opacity:0; transform:scale(0.98);} to {opacity:1; transform:scale(1);} }
        
        /* Pro Badge Glow */
        body.is-pro .status-badge.pro { box-shadow: 0 0 15px rgba(212,175,55,0.4); }
    </style>
</head>
<body>

    <!-- Firebase Config -->
    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyDbZAPtQioiXZzkiiIRrkrBkEPF440NMaE",
            authDomain: "qaxi-93d6d.firebaseapp.com",
            projectId: "qaxi-93d6d",
            storageBucket: "qaxi-93d6d.firebasestorage.app",
            messagingSenderId: "137240859996",
            appId: "1:137240859996:web:73e14d28c77233be965d99"
        };
        try { firebase.initializeApp(firebaseConfig); var db = firebase.firestore(); } catch(e){ console.log("Offline or Config Error"); }
        
        let IS_PREMIUM = false;
        const GROQ_KEY = "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";
        
        // Storage Keys
        const STORAGE_KEYS = {
            DOCS: 'qaxi_docs_content',
            SLIDES: 'qaxi_slides_data',
            SHEETS: 'qaxi_sheets_data'
        };
        
        // Docs & Sheets Vars
        let sheetRows = 20, sheetCols = 10;
        let activeCell = {row:1, col:1};
        let pdfImages = [];
        let autoSaveTimer = null;
        let hasUnsavedChanges = false;

        // Slides Vars
        let slides = [{id:1, elements: [], bg: '#ffffff'}];
        let currentSlideIdx = 0;
        let selectedElement = null;
        let isDragging = false;
        let isResizing = false;
        let dragOffset = { x: 0, y: 0 };
        
        // Warn before leaving if unsaved changes
        window.addEventListener('beforeunload', (e) => {
            // Auto-save before leaving
            autoSaveAll();
        });
    </script>

    <!-- Modal Login -->
    <div class="modal-overlay" id="loginModal">
        <div class="modal">
            <h2>ACCESO QAXI</h2>
            <p style="color:#888; margin-bottom:10px;">Ingresa tu correo Titanium</p>
            <input type="email" id="uEmail" placeholder="usuario@email.com">
            <button class="nav-btn" onclick="checkDB()" style="width:100%; border-color:var(--gold); color:var(--gold); padding:10px;">VALIDAR</button>
            <button class="nav-btn" onclick="closeLogin()" style="width:100%; border:none; margin-top:10px;">CANCELAR</button>
            <p id="loginMsg" style="color:var(--gold); margin-top:15px; font-size:0.8rem; height:1rem;"></p>
        </div>
    </div>

    <!-- Header -->
    <header>
        <div class="brand">QAXI<span>CLOUD</span></div>
        <div class="user-area">
            <div class="status-badge" id="accessBtn" onclick="openLogin()">ACCEDER</div>
            <div class="status-badge pro" onclick="goPlans()">TITANIUM PLAN</div>
        </div>
    </header>

    <div class="main-container">
        <!-- Sidebar -->
        <div class="sidebar">
            <div class="app-icon" onclick="startApp('docs')" title="Documentos"><i class="fa-solid fa-file-word"></i><span>DOCS</span></div>
            <div class="app-icon" onclick="startApp('sheets')" title="Hojas de Cálculo"><i class="fa-solid fa-table"></i><span>SHEET</span></div>
            <div class="app-icon" onclick="startApp('pdf')" title="PDF Converter"><i class="fa-solid fa-file-pdf"></i><span>PDF</span></div>
            <div class="app-icon" onclick="startApp('slides')" title="Presentaciones QAXI">
                <i class="fa-solid fa-chalkboard-user"></i><span>SLIDES</span>
                <div class="pro-tag">PRO</div>
            </div>
            <div class="app-icon" onclick="startApp('ai')" title="QAXI AI"><i class="fa-solid fa-brain"></i><span>AI</span></div>
            <div class="app-icon" onclick="startApp('qr')" title="Generador QR"><i class="fa-solid fa-qrcode"></i><span>QR</span></div>
            <div style="flex:1"></div>
            <div class="app-icon" onclick="goHome()" title="Salir"><i class="fa-solid fa-power-off"></i></div>
        </div>

        <!-- Content -->
        <div class="content-area">
            <div class="hero" id="heroPanel">
                <h1 id="heroTitle">Bienvenido a QAXI Cloud!</h1>
                <p id="heroSub">Potencia tu flujo de trabajo seleccionando una herramienta Titanium en el menú lateral.<br>El futuro de tu productividad empieza aquí.</p>
            </div>

            <!-- Workspace Overlay -->
            <div id="ws">
                <div class="ws-header">
                    <div class="ws-title" id="appName">APP</div>
                    <div class="ws-tools" id="appTools"></div>
                    <div class="nav-btn" onclick="exitApp()" style="margin-left:15px; border-color: #555;">CERRAR</div>
                </div>
                <div class="ws-stage" id="wsContent"></div>
            </div>
        </div>
    </div>

    <script>
        window.goHome = function() { 
            autoSaveAll();
            window.location.href = "Index.html"; 
        };
        window.goPlans = function() {
            if (IS_PREMIUM) return;
            const p = encodeURIComponent("QAXI Cloud PRO - Titanium");
            window.location.href = `qaxipay.html?p=${p}&v=15000&t=MICROAPP`;
        };

        // --- AUTO SAVE FUNCTIONS ---
        function autoSaveAll() {
            const paper = document.getElementById('paper');
            if (paper) {
                localStorage.setItem(STORAGE_KEYS.DOCS, paper.innerHTML);
            }
            // Save slides
            if (slides && slides.length > 0) {
                localStorage.setItem(STORAGE_KEYS.SLIDES, JSON.stringify(slides));
            }
        }
        
        function showSaveIndicator(status) {
            const indicator = document.getElementById('autosaveIndicator');
            if (!indicator) return;
            
            indicator.className = 'autosave-indicator ' + status;
            if (status === 'saving') {
                indicator.innerHTML = '<i class="fa-solid fa-circle-notch fa-spin"></i> Guardando...';
            } else if (status === 'saved') {
                indicator.innerHTML = '<i class="fa-solid fa-check"></i> Guardado';
                setTimeout(() => {
                    indicator.innerHTML = '<i class="fa-solid fa-cloud"></i> Auto-guardado activo';
                    indicator.className = 'autosave-indicator';
                }, 2000);
            }
        }
        
        function triggerAutoSave() {
            if (autoSaveTimer) clearTimeout(autoSaveTimer);
            showSaveIndicator('saving');
            autoSaveTimer = setTimeout(() => {
                autoSaveAll();
                showSaveIndicator('saved');
            }, 1000);
        }

        // --- SISTEMA DE LOGIN ---
        window.openLogin = function() {
            document.getElementById('loginModal').style.display = 'flex';
        };

        window.closeLogin = function() {
            document.getElementById('loginModal').style.display = 'none';
            document.getElementById('loginMsg').innerText = "";
        };

        window.checkDB = async function() {
            const email = document.getElementById('uEmail').value.trim().toLowerCase();
            const msg = document.getElementById('loginMsg');
            
            if(!email) { msg.innerText = "Ingresa tu correo."; return; }
            msg.innerText = "Verificando...";

            try {
                const q = db.collection("QAXI_Cloud").where("email", "==", email);
                const querySnapshot = await q.get();

                if(!querySnapshot.empty) {
                    setProMode(email);
                    closeLogin();
                    document.getElementById('accessBtn').style.display = 'none';
                } else {
                    msg.style.color = "#ff4444";
                    msg.innerText = "No tienes Licencia Titanium activa.";
                }
            } catch(e) {
                console.error(e);
                msg.innerText = "Error de conexión/config.";
            }
        };

        function setProMode(email) {
            IS_PREMIUM = true;
            document.body.classList.add('is-pro');
            document.getElementById('heroTitle').innerText = "Bienvenido, QAXI PRO";
            document.getElementById('heroTitle').style.color = "var(--gold)";
            document.getElementById('heroSub').innerText = "LICENCIA PREMIUM ACTIVADA";
        }

        function setFreeMode() {
            IS_PREMIUM = false;
            document.body.classList.remove('is-pro');
        }

        window.startApp = function(id) {
            if (id === 'slides' && !IS_PREMIUM) {
                return goPlans();
            }

            document.getElementById('ws').style.display = 'flex';
            const stage = document.getElementById('wsContent');
            const tools = document.getElementById('appTools');
            const title = document.getElementById('appName');
            
            stage.innerHTML = ''; tools.innerHTML = ''; title.innerText = id.toUpperCase();
            pdfImages = []; 

            if(id === 'docs') loadDocs(stage, tools);
            if(id === 'sheets') loadSheets(stage, tools);
            if(id === 'pdf') loadPDF(stage, tools);
            if(id === 'qr') loadQR(stage, tools);
            if(id === 'ai') loadAI(stage, tools);
            if(id === 'slides') loadSlides(stage, tools);
        };

        window.exitApp = function() { 
            autoSaveAll();
            document.getElementById('ws').style.display = 'none'; 
        };

        // ========================================
        // === DOCS (CON AUTOGUARDADO Y FUENTES MEJORADAS) ===
        // ========================================
        
        let savedSelection = null;
        
        // Lista de fuentes con estilos muy distintos
        const FONTS = [
            { name: 'Normal', value: 'Segoe UI, Arial, sans-serif' },
            { name: 'Elegante Serif', value: 'Playfair Display, serif' },
            { name: 'Clásica', value: 'Lora, serif' },
            { name: 'Editorial', value: 'Merriweather, serif' },
            { name: 'Moderna Bold', value: 'Oswald, sans-serif' },
            { name: 'Impacto', value: 'Bebas Neue, sans-serif' },
            { name: 'Roboto Slab', value: 'Roboto Slab, serif' },
            { name: 'Título Artístico', value: 'Abril Fatface, serif' },
            { name: 'Cursiva Elegante', value: 'Dancing Script, cursive' },
            { name: 'Pacifico', value: 'Pacifico, cursive' },
            { name: 'Manuscrita', value: 'Caveat, cursive' },
            { name: 'Satisfy', value: 'Satisfy, cursive' },
            { name: 'Great Vibes', value: 'Great Vibes, cursive' },
            { name: 'Lobster', value: 'Lobster, cursive' },
            { name: 'Marcador', value: 'Permanent Marker, cursive' },
            { name: 'Cinzel Premium', value: 'Cinzel, serif' }
        ];
        
        function saveSelection() {
            const sel = window.getSelection();
            if (sel.rangeCount > 0) {
                savedSelection = sel.getRangeAt(0).cloneRange();
            }
        }
        
        function restoreSelection() {
            if (savedSelection) {
                const sel = window.getSelection();
                sel.removeAllRanges();
                sel.addRange(savedSelection);
            }
        }

        function loadDocs(c, t) {
            // Build font options with preview styling
            let fontOptions = FONTS.map(f => 
                `<option value="${f.value}" style="font-family: ${f.value}; font-size: 14px;">${f.name}</option>`
            ).join('');
            
            t.innerHTML = `
                <button class="magic-btn" onclick="magicWriting()">
                    <i class="fa-solid fa-wand-magic-sparkles"></i> Escritura Mágica (Beta)
                </button>
                <div class="sep"></div>
                <button class="nav-btn" onclick="clearDoc()">NUEVO</button>
                <button class="nav-btn" onclick="exportDocPdf()">CONVERTIR A PDF</button>
                <button class="nav-btn" onclick="window.print()">IMPRIMIR</button>
            `;
            c.innerHTML = `
                <div style="display:flex; flex-direction:column; width:100%; height:100%;">
                    <div class="doc-toolbar">
                        <!-- Fuente con Preview -->
                        <div class="font-select-wrapper">
                            <select class="tb-select" id="fontSelect" title="Fuente">
                                ${fontOptions}
                            </select>
                        </div>
                        
                        <!-- Tamaño Real en PX -->
                        <select class="tb-select" id="sizeSelect" title="Tamaño">
                            <option value="12">12px</option>
                            <option value="14">14px</option>
                            <option value="16" selected>16px</option>
                            <option value="18">18px</option>
                            <option value="20">20px</option>
                            <option value="24">24px</option>
                            <option value="28">28px</option>
                            <option value="32">32px</option>
                            <option value="36">36px</option>
                            <option value="48">48px</option>
                            <option value="64">64px</option>
                            <option value="72">72px</option>
                        </select>

                        <div class="sep"></div>

                        <!-- Estilos Básicos -->
                        <button class="tb-btn" onmousedown="event.preventDefault(); applyFormat('bold')" title="Negrita"><i class="fa-solid fa-bold"></i></button>
                        <button class="tb-btn" onmousedown="event.preventDefault(); applyFormat('italic')" title="Cursiva"><i class="fa-solid fa-italic"></i></button>
                        <button class="tb-btn" onmousedown="event.preventDefault(); applyFormat('underline')" title="Subrayado"><i class="fa-solid fa-underline"></i></button>
                        <button class="tb-btn" onmousedown="event.preventDefault(); applyFormat('strikeThrough')" title="Tachado"><i class="fa-solid fa-strikethrough"></i></button>
                        
                        <div class="sep"></div>
                        
                        <!-- Color Texto -->
                        <div style="display:flex; align-items:center;">
                            <label style="font-size:11px; color:#888; margin-right:4px;"><i class="fa-solid fa-font"></i></label>
                            <input type="color" id="colorTx" value="#000000" style="border:none; width:24px; height:24px; background:none; cursor:pointer; padding:0;">
                        </div>
                        
                        <!-- Color Fondo -->
                        <div style="display:flex; align-items:center; margin-left:5px;">
                            <label style="font-size:11px; color:#888; margin-right:4px;"><i class="fa-solid fa-highlighter"></i></label>
                            <input type="color" id="colorBg" value="#ffff00" style="border:none; width:24px; height:24px; background:none; cursor:pointer; padding:0;">
                        </div>

                        <div class="sep"></div>

                        <!-- Alineaciones -->
                        <button class="tb-btn" onmousedown="event.preventDefault(); applyFormat('justifyLeft')" title="Izquierda"><i class="fa-solid fa-align-left"></i></button>
                        <button class="tb-btn" onmousedown="event.preventDefault(); applyFormat('justifyCenter')" title="Centro"><i class="fa-solid fa-align-center"></i></button>
                        <button class="tb-btn" onmousedown="event.preventDefault(); applyFormat('justifyRight')" title="Derecha"><i class="fa-solid fa-align-right"></i></button>
                        <button class="tb-btn" onmousedown="event.preventDefault(); applyFormat('justifyFull')" title="Justificar"><i class="fa-solid fa-align-justify"></i></button>
                        
                        <div class="sep"></div>
                        
                        <!-- Listas -->
                        <button class="tb-btn" onmousedown="event.preventDefault(); applyFormat('insertUnorderedList')" title="Lista"><i class="fa-solid fa-list-ul"></i></button>
                        <button class="tb-btn" onmousedown="event.preventDefault(); applyFormat('insertOrderedList')" title="Lista Numérica"><i class="fa-solid fa-list-ol"></i></button>
                        
                        <div class="sep"></div>

                        <!-- Encabezados -->
                        <select class="tb-select" id="headingSelect" title="Formato">
                            <option value="div">Párrafo</option>
                            <option value="h1">Título 1</option>
                            <option value="h2">Título 2</option>
                            <option value="h3">Subtítulo</option>
                            <option value="blockquote">Cita</option>
                        </select>
                        
                        <div class="sep"></div>
                        
                        <!-- Deshacer/Rehacer -->
                        <button class="tb-btn" onmousedown="event.preventDefault(); applyFormat('undo')" title="Deshacer"><i class="fa-solid fa-rotate-left"></i></button>
                        <button class="tb-btn" onmousedown="event.preventDefault(); applyFormat('redo')" title="Rehacer"><i class="fa-solid fa-rotate-right"></i></button>
                    </div>
                    
                    <div style="flex:1; overflow:auto; background:#111; display:flex; justify-content:center;">
                        <div id="paper" contenteditable="true">
                            <h1>Nuevo Documento</h1>
                            <p>Comienza a escribir...</p>
                        </div>
                    </div>
                    <div class="doc-status">
                        <span id="docStats">0 palabras</span>
                        <div class="autosave-indicator" id="autosaveIndicator">
                            <i class="fa-solid fa-cloud"></i> Auto-guardado activo
                        </div>
                    </div>
                </div>`;
            
            const paper = document.getElementById('paper');
            
            // Load saved content
            const savedContent = localStorage.getItem(STORAGE_KEYS.DOCS);
            if (savedContent) {
                paper.innerHTML = savedContent;
            }
            
            paper.addEventListener('input', () => {
                updateDocStats();
                triggerAutoSave();
            });
            
            // Save selection events
            paper.addEventListener('mouseup', saveSelection);
            paper.addEventListener('keyup', saveSelection);
            
            // Font Select - Apply font directly with CSS
            const fontSelect = document.getElementById('fontSelect');
            fontSelect.addEventListener('mousedown', saveSelection);
            fontSelect.addEventListener('change', function() {
                applyFontToSelection(this.value);
                paper.focus();
            });
            
            // Size Select
            const sizeSelect = document.getElementById('sizeSelect');
            sizeSelect.addEventListener('mousedown', saveSelection);
            sizeSelect.addEventListener('change', function() {
                applySizeToSelection(this.value);
                paper.focus();
            });
            
            // Heading Select
            const headingSelect = document.getElementById('headingSelect');
            headingSelect.addEventListener('mousedown', saveSelection);
            headingSelect.addEventListener('change', function() {
                restoreSelection();
                document.execCommand('formatBlock', false, this.value);
                paper.focus();
                triggerAutoSave();
            });
            
            // Color inputs
            document.getElementById('colorTx').addEventListener('input', function() {
                restoreSelection();
                document.execCommand('foreColor', false, this.value);
                triggerAutoSave();
            });
            
            document.getElementById('colorBg').addEventListener('input', function() {
                restoreSelection();
                document.execCommand('hiliteColor', false, this.value);
                triggerAutoSave();
            });
            
            updateDocStats();
        }
        
        window.clearDoc = function() {
            if (confirm('¿Crear un nuevo documento? Se perderá el contenido actual.')) {
                document.getElementById('paper').innerHTML = '<h1>Nuevo Documento</h1><p>Comienza a escribir...</p>';
                localStorage.removeItem(STORAGE_KEYS.DOCS);
            }
        }

        window.applyFormat = function(cmd, val = null) {
            document.execCommand(cmd, false, val);
            document.getElementById('paper').focus();
            triggerAutoSave();
        }
        
        window.applyFontToSelection = function(fontFamily) {
            restoreSelection();
            const selection = window.getSelection();
            
            if (selection.rangeCount > 0 && !selection.isCollapsed) {
                const range = selection.getRangeAt(0);
                
                // Create wrapper span with font
                const span = document.createElement('span');
                span.style.fontFamily = fontFamily;
                
                // Extract and wrap content
                const fragment = range.extractContents();
                span.appendChild(fragment);
                range.insertNode(span);
                
                // Re-select the new content
                range.selectNodeContents(span);
                selection.removeAllRanges();
                selection.addRange(range);
            }
            
            triggerAutoSave();
        }
        
        window.applySizeToSelection = function(size) {
            restoreSelection();
            const selection = window.getSelection();
            
            if (selection.rangeCount > 0 && !selection.isCollapsed) {
                const range = selection.getRangeAt(0);
                
                // Create wrapper span with size
                const span = document.createElement('span');
                span.style.fontSize = size + 'px';
                
                // Extract and wrap content
                const fragment = range.extractContents();
                span.appendChild(fragment);
                range.insertNode(span);
                
                // Re-select the new content
                range.selectNodeContents(span);
                selection.removeAllRanges();
                selection.addRange(range);
            }
            
            triggerAutoSave();
        }

        window.updateDocStats = () => {
            const paper = document.getElementById('paper');
            if (!paper) return;
            const text = paper.innerText.trim();
            const words = text ? text.split(/\s+/).filter(w => w.length > 0).length : 0;
            document.getElementById('docStats').innerText = `${words} palabras`;
        };
        
        window.exportDocPdf = () => {
            const el = document.getElementById('paper');
            html2canvas(el, {scale:2}).then(cvs => {
                const pdf = new jspdf.jsPDF('p','mm','a4');
                const w = pdf.internal.pageSize.getWidth();
                pdf.addImage(cvs.toDataURL('image/png'), 'PNG', 0, 0, w, (cvs.height*w)/cvs.width);
                pdf.save('QAXI_Doc.pdf');
            });
        };
        
        // === ESCRITURA MÁGICA (BETA) ===
        window.magicWriting = async function() {
            const selection = window.getSelection();
            const selectedText = selection.toString().trim();
            
            if (!selectedText) {
                alert('Selecciona una palabra o frase para expandir con IA.');
                return;
            }
            
            const range = selection.getRangeAt(0);
            const loadingSpan = document.createElement('span');
            loadingSpan.id = 'magic-loading';
            loadingSpan.style.cssText = 'background: linear-gradient(90deg, #D4AF37, #fff, #D4AF37); background-size: 200%; animation: shimmer 1s infinite; -webkit-background-clip: text; -webkit-text-fill-color: transparent;';
            loadingSpan.textContent = selectedText + '...';
            
            if (!document.getElementById('shimmer-style')) {
                const style = document.createElement('style');
                style.id = 'shimmer-style';
                style.textContent = '@keyframes shimmer { 0% { background-position: -200% 0; } 100% { background-position: 200% 0; } }';
                document.head.appendChild(style);
            }
            
            range.deleteContents();
            range.insertNode(loadingSpan);
            
            try {
                const systemPrompt = "Eres un escritor experto. El usuario te dará una palabra o frase temática. Tu trabajo es expandirla en un párrafo corto (2-3 oraciones máximo) elegante y bien redactado sobre ese tema. NO uses comillas. NO expliques qué estás haciendo. Solo devuelve el texto expandido directamente.";
                
                const response = await fetch("https://api.groq.com/openai/v1/chat/completions", {
                    method: "POST",
                    headers: { "Content-Type": "application/json", "Authorization": `Bearer ${GROQ_KEY}` },
                    body: JSON.stringify({
                        messages: [
                            { role: "system", content: systemPrompt },
                            { role: "user", content: `Expande esto: "${selectedText}"` }
                        ],
                        model: "llama-3.3-70b-versatile",
                        temperature: 0.8,
                        max_tokens: 200
                    })
                });
                
                if (!response.ok) throw new Error("Error API");
                const data = await response.json();
                const expandedText = data.choices[0].message.content.trim();
                
                loadingSpan.style.cssText = '';
                loadingSpan.style.color = '#000';
                loadingSpan.textContent = expandedText;
                loadingSpan.removeAttribute('id');
                
                triggerAutoSave();
                
            } catch (e) {
                console.error(e);
                loadingSpan.textContent = selectedText;
                loadingSpan.style.cssText = '';
                alert('Error al generar texto. Intenta de nuevo.');
            }
        }

        // === PDF ===
        function loadPDF(c, t) {
            c.innerHTML = `<div class="pdf-zone">
                <i class="fa-solid fa-file-pdf" style="font-size:3rem; margin-bottom:10px; color:var(--text)"></i>
                <h3 style="letter-spacing:1px; margin-bottom:20px;">PDF CONVERTER</h3>
                
                <div class="pdf-opts" style="display:flex; gap:10px; margin-bottom:20px;">
                    <button class="nav-btn" onclick="document.getElementById('imgInput').click()" style="padding:10px 20px; font-size:0.9rem; border-color:var(--text);">
                        <i class="fa-solid fa-plus"></i> AGREGAR IMÁGENES
                    </button>
                    <button class="nav-btn" onclick="imgsToPdf()" style="padding:10px 20px; font-size:0.9rem; border-color:var(--gold); color:var(--gold);">
                        CREAR PDF
                    </button>
                </div>
                
                <input type="file" id="imgInput" multiple accept="image/*" style="display:none">
                <div id="pdfList" class="pdf-list"></div>
                <p style="color:#555; font-size:0.8rem; margin-top:20px;">Soporta JPG, PNG.</p>
            </div>`;
            const input = document.getElementById('imgInput');
            input.addEventListener('change', () => {
                Array.from(input.files).forEach(file => {
                    const reader = new FileReader();
                    reader.onload = () => { pdfImages.push({ name: file.name, data: reader.result }); renderPdfList(); };
                    reader.readAsDataURL(file);
                });
            });
        }
        function renderPdfList() {
            const list = document.getElementById('pdfList');
            list.innerHTML = "";
            pdfImages.forEach((img, idx) => {
                const div = document.createElement("div");
                div.className = "pdf-item";
                div.innerHTML = `<div class="del" onclick="removePdf(${idx})">x</div>
                                 <img src="${img.data}" style="width:100%; height:100%; object-fit:cover; border-radius:4px;">`;
                list.appendChild(div);
            });
        }
        window.removePdf = (idx) => { pdfImages.splice(idx, 1); renderPdfList(); };
        window.imgsToPdf = () => {
            if(!pdfImages.length) return alert("Agrega imágenes.");
            const pdf = new jspdf.jsPDF();
            const w = pdf.internal.pageSize.getWidth();
            const h = pdf.internal.pageSize.getHeight();
            pdfImages.forEach((img, i) => {
                if(i > 0) pdf.addPage();
                pdf.addImage(img.data, 'JPEG', 0, 0, w, h);
            });
            pdf.save("QAXI_Images.pdf");
        };

        // ========================================
        // === PRESENTATIONS QAXI (CON AUTOGUARDADO) ===
        // ========================================
        
        function loadSlides(c, t) {
            t.innerHTML = `
                <button class="nav-btn" onclick="addSlide()">+ SLIDE</button>
                <button class="nav-btn" onclick="addSlideText()">+ TEXTO</button>
                <button class="nav-btn" onclick="addSlideTitle()">+ TÍTULO</button>
                <button class="nav-btn" onclick="document.getElementById('slideImgInput').click()">+ IMAGEN</button>
                <input type="file" id="slideImgInput" accept="image/*" style="display:none" onchange="addSlideImage(this)">
                <div class="sep"></div>
                <input type="color" id="bgColorPicker" onchange="changeSlideBg(this.value)" value="#ffffff" title="Color de Fondo">
                <div class="sep"></div>
                <button class="nav-btn" onclick="deleteSelectedElement()" style="border-color:#ff4444; color:#ff4444;">ELIMINAR</button>
                <div class="sep"></div>
                <button class="nav-btn" onclick="exportSlides()" style="border-color:var(--gold); color:var(--gold)">EXPORTAR PDF</button>
            `;

            c.innerHTML = `
                <div class="slides-layout">
                    <div class="slides-sidebar" id="slideThumbs"></div>
                    <div class="slides-main" id="slidesMain">
                        <div id="activeSlideCanvas" class="slide-canvas"></div>
                    </div>
                </div>
            `;
            
            // Try to load saved slides
            const savedSlides = localStorage.getItem(STORAGE_KEYS.SLIDES);
            if (savedSlides) {
                try {
                    slides = JSON.parse(savedSlides);
                } catch(e) {
                    slides = [{ 
                        id: 1, 
                        elements: [
                            { id: 1, type: 'title', content: 'Título de la Presentación', x: 50, y: 50, width: 700, height: 60, fontSize: 36, fontFamily: 'Cinzel' },
                            { id: 2, type: 'text', content: 'Haz clic para editar...', x: 50, y: 150, width: 600, height: 40, fontSize: 18, fontFamily: 'Segoe UI' }
                        ], 
                        bg: '#ffffff' 
                    }];
                }
            } else {
                slides = [{ 
                    id: 1, 
                    elements: [
                        { id: 1, type: 'title', content: 'Título de la Presentación', x: 50, y: 50, width: 700, height: 60, fontSize: 36, fontFamily: 'Cinzel' },
                        { id: 2, type: 'text', content: 'Haz clic para editar...', x: 50, y: 150, width: 600, height: 40, fontSize: 18, fontFamily: 'Segoe UI' }
                    ], 
                    bg: '#ffffff' 
                }];
            }
            
            currentSlideIdx = 0;
            selectedElement = null;
            
            renderCurrentSlide();
            renderThumbs();
            
            document.getElementById('activeSlideCanvas').addEventListener('click', (e) => {
                if (e.target.id === 'activeSlideCanvas') {
                    deselectAll();
                }
            });
        }
        
        function saveSlides() {
            localStorage.setItem(STORAGE_KEYS.SLIDES, JSON.stringify(slides));
        }
        
        function renderCurrentSlide() {
            const canvas = document.getElementById('activeSlideCanvas');
            if (!canvas) return;
            
            const slide = slides[currentSlideIdx];
            canvas.style.backgroundColor = slide.bg;
            canvas.innerHTML = '';
            
            slide.elements.forEach(el => {
                const elem = createSlideElement(el);
                canvas.appendChild(elem);
            });
        }
        
        function createSlideElement(elData) {
            const wrapper = document.createElement('div');
            wrapper.className = 'slide-element';
            wrapper.dataset.id = elData.id;
            wrapper.style.left = elData.x + 'px';
            wrapper.style.top = elData.y + 'px';
            wrapper.style.width = elData.width + 'px';
            wrapper.style.minHeight = elData.height + 'px';
            
            if (elData.type === 'image') {
                const img = document.createElement('img');
                img.src = elData.src;
                img.draggable = false;
                wrapper.appendChild(img);
            } else {
                const textEl = document.createElement('div');
                textEl.contentEditable = true;
                textEl.innerHTML = elData.content;
                textEl.style.fontSize = elData.fontSize + 'px';
                textEl.style.fontFamily = elData.fontFamily;
                textEl.style.width = '100%';
                textEl.style.minHeight = '100%';
                textEl.style.outline = 'none';
                
                if (elData.type === 'title') {
                    textEl.style.fontWeight = 'bold';
                }
                
                textEl.addEventListener('input', () => {
                    const slide = slides[currentSlideIdx];
                    const elem = slide.elements.find(e => e.id == elData.id);
                    if (elem) elem.content = textEl.innerHTML;
                    saveSlides();
                });
                
                textEl.addEventListener('focus', () => {
                    wrapper.classList.add('editing');
                });
                
                textEl.addEventListener('blur', () => {
                    wrapper.classList.remove('editing');
                });
                
                wrapper.appendChild(textEl);
            }
            
            const resizeHandle = document.createElement('div');
            resizeHandle.className = 'resize-handle';
            resizeHandle.style.display = 'none';
            wrapper.appendChild(resizeHandle);
            
            wrapper.addEventListener('mousedown', (e) => {
                if (e.target === resizeHandle) {
                    startResize(e, wrapper, elData);
                    return;
                }
                selectElement(wrapper, elData);
                if (!wrapper.classList.contains('editing')) {
                    startDrag(e, wrapper, elData);
                }
            });
            
            return wrapper;
        }
        
        function selectElement(wrapper, elData) {
            deselectAll();
            wrapper.classList.add('selected');
            wrapper.querySelector('.resize-handle').style.display = 'block';
            selectedElement = { wrapper, data: elData };
        }
        
        function deselectAll() {
            document.querySelectorAll('.slide-element.selected').forEach(el => {
                el.classList.remove('selected');
                const handle = el.querySelector('.resize-handle');
                if (handle) handle.style.display = 'none';
            });
            selectedElement = null;
        }
        
        function startDrag(e, wrapper, elData) {
            if (wrapper.classList.contains('editing')) return;
            
            isDragging = true;
            const rect = wrapper.getBoundingClientRect();
            dragOffset.x = e.clientX - rect.left;
            dragOffset.y = e.clientY - rect.top;
            
            const onMouseMove = (e) => {
                if (!isDragging) return;
                
                const canvas = document.getElementById('activeSlideCanvas');
                const canvasRect = canvas.getBoundingClientRect();
                
                let newX = e.clientX - canvasRect.left - dragOffset.x;
                let newY = e.clientY - canvasRect.top - dragOffset.y;
                
                newX = Math.max(0, Math.min(newX, canvas.offsetWidth - wrapper.offsetWidth));
                newY = Math.max(0, Math.min(newY, canvas.offsetHeight - wrapper.offsetHeight));
                
                wrapper.style.left = newX + 'px';
                wrapper.style.top = newY + 'px';
                
                elData.x = newX;
                elData.y = newY;
            };
            
            const onMouseUp = () => {
                isDragging = false;
                document.removeEventListener('mousemove', onMouseMove);
                document.removeEventListener('mouseup', onMouseUp);
                saveSlides();
            };
            
            document.addEventListener('mousemove', onMouseMove);
            document.addEventListener('mouseup', onMouseUp);
        }
        
        function startResize(e, wrapper, elData) {
            e.preventDefault();
            e.stopPropagation();
            isResizing = true;
            
            const startX = e.clientX;
            const startY = e.clientY;
            const startWidth = wrapper.offsetWidth;
            const startHeight = wrapper.offsetHeight;
            
            const onMouseMove = (e) => {
                if (!isResizing) return;
                
                const newWidth = Math.max(50, startWidth + (e.clientX - startX));
                const newHeight = Math.max(20, startHeight + (e.clientY - startY));
                
                wrapper.style.width = newWidth + 'px';
                wrapper.style.minHeight = newHeight + 'px';
                
                elData.width = newWidth;
                elData.height = newHeight;
            };
            
            const onMouseUp = () => {
                isResizing = false;
                document.removeEventListener('mousemove', onMouseMove);
                document.removeEventListener('mouseup', onMouseUp);
                saveSlides();
            };
            
            document.addEventListener('mousemove', onMouseMove);
            document.addEventListener('mouseup', onMouseUp);
        }

        window.renderThumbs = function() {
            const cont = document.getElementById('slideThumbs');
            if (!cont) return;
            cont.innerHTML = '';
            slides.forEach((s, i) => {
                const div = document.createElement('div');
                div.className = `slide-thumb ${i === currentSlideIdx ? 'active' : ''}`;
                div.style.backgroundColor = s.bg;
                div.onclick = () => switchSlide(i);
                div.innerHTML = `<span>${i+1}</span>`;
                cont.appendChild(div);
            });
        }

        window.switchSlide = function(idx) {
            currentSlideIdx = idx;
            selectedElement = null;
            renderCurrentSlide();
            renderThumbs();
        }

        window.addSlide = function() {
            slides.push({ 
                id: Date.now(), 
                elements: [
                    { id: Date.now(), type: 'title', content: 'Nueva Diapositiva', x: 50, y: 50, width: 700, height: 60, fontSize: 36, fontFamily: 'Cinzel' }
                ], 
                bg: '#ffffff' 
            });
            switchSlide(slides.length - 1);
            saveSlides();
        }

        window.changeSlideBg = function(color) {
            slides[currentSlideIdx].bg = color;
            document.getElementById('activeSlideCanvas').style.backgroundColor = color;
            renderThumbs();
            saveSlides();
        }

        window.addSlideText = function() {
            const newEl = {
                id: Date.now(),
                type: 'text',
                content: 'Texto nuevo',
                x: 100,
                y: 200,
                width: 300,
                height: 30,
                fontSize: 18,
                fontFamily: 'Segoe UI'
            };
            slides[currentSlideIdx].elements.push(newEl);
            renderCurrentSlide();
            saveSlides();
        }
        
        window.addSlideTitle = function() {
            const newEl = {
                id: Date.now(),
                type: 'title',
                content: 'Título',
                x: 50,
                y: 50,
                width: 700,
                height: 50,
                fontSize: 32,
                fontFamily: 'Cinzel'
            };
            slides[currentSlideIdx].elements.push(newEl);
            renderCurrentSlide();
            saveSlides();
        }
        
        window.addSlideImage = function(input) {
            if (!input.files || !input.files[0]) return;
            
            const reader = new FileReader();
            reader.onload = (e) => {
                const newEl = {
                    id: Date.now(),
                    type: 'image',
                    src: e.target.result,
                    x: 100,
                    y: 100,
                    width: 300,
                    height: 200
                };
                slides[currentSlideIdx].elements.push(newEl);
                renderCurrentSlide();
                saveSlides();
            };
            reader.readAsDataURL(input.files[0]);
            input.value = '';
        }
        
        window.deleteSelectedElement = function() {
            if (!selectedElement) {
                alert('Selecciona un elemento para eliminar.');
                return;
            }
            
            const slide = slides[currentSlideIdx];
            slide.elements = slide.elements.filter(el => el.id != selectedElement.data.id);
            selectedElement = null;
            renderCurrentSlide();
            saveSlides();
        }

        window.exportSlides = async function() {
            const pdf = new jspdf.jsPDF('l', 'mm', 'a4');
            const w = pdf.internal.pageSize.getWidth();
            const h = pdf.internal.pageSize.getHeight();
            const canvas = document.getElementById('activeSlideCanvas');
            const originalIdx = currentSlideIdx;
            
            deselectAll();

            for (let i = 0; i < slides.length; i++) {
                if (i > 0) pdf.addPage();
                switchSlide(i);
                await new Promise(resolve => setTimeout(resolve, 100));
                await html2canvas(canvas, { scale: 2, useCORS: true }).then(cvs => {
                    pdf.addImage(cvs.toDataURL('image/jpeg', 0.9), 'JPEG', 0, 0, w, h);
                });
            }
            
            switchSlide(originalIdx);
            pdf.save('QAXI_Presentation.pdf');
        }

        // === SHEETS ===
        function loadSheets(c, t) {
            t.innerHTML = `<button class="nav-btn" onclick="addR()">+ FILA</button><button class="nav-btn" onclick="exportCSV()">CSV</button>`;
            c.innerHTML = buildGrid(sheetRows, sheetCols);
        }
        function buildGrid(rows, cols) {
            let h = `<div class="grid-container"><table class="grid" id="mainGrid"><thead><tr id="hRow"><th></th>`;
            for(let i=0; i<cols; i++) h += `<th>${String.fromCharCode(65+i)}</th>`;
            h += `</tr></thead><tbody>`;
            for(let r=1; r<=rows; r++) {
                h += `<tr><th style="background:#1f1f1f;">${r}</th>`;
                for(let col=0; col<cols; col++) h += `<td><input onchange="doCalc(this)"></td>`;
                h += `</tr>`;
            }
            return h + `</tbody></table></div>`;
        }
        window.doCalc = (el) => {
            if(el.value.startsWith('=')) { try { el.value = math.evaluate(el.value.substring(1)); el.style.color='var(--gold)'; } catch(e){}}
        };
        window.addR = () => { sheetRows++; loadSheets(document.getElementById('wsContent'), document.getElementById('appTools')); };
        window.exportCSV = () => alert("Exportando CSV...");


        // === QAXI AI ===
        function loadAI(c, t) {
            c.innerHTML = `
                <div class="ai-box">
                    <div class="chat-window" id="aiChat">
                        <div class="msg ai">
                            <strong>QAXI AI</strong>
                            <p>Hola. Soy tu inteligencia artificial Titanium. ¿En qué te ayudo hoy?</p>
                        </div>
                    </div>
                    <div class="ai-input-area">
                        <input type="text" id="aiInput" placeholder="Pregúntame lo que quieras..." onkeydown="if(event.key === 'Enter') askQaxiAI()">
                        <button onclick="askQaxiAI()"><i class="fa-solid fa-paper-plane"></i></button>
                    </div>
                </div>
            `;
        }

        window.askQaxiAI = async function() {
            const input = document.getElementById('aiInput');
            const chat = document.getElementById('aiChat');
            const prompt = input.value.trim();
            if(!prompt) return;

            const uDiv = document.createElement('div'); uDiv.className = 'msg user'; uDiv.innerText = prompt;
            chat.appendChild(uDiv); input.value = ''; chat.scrollTop = chat.scrollHeight;

            const lDiv = document.createElement('div'); lDiv.className = 'msg ai'; lDiv.id = 'ai-loader';
            lDiv.innerHTML = `<strong>QAXI AI</strong><p>Pensando...</p>`; chat.appendChild(lDiv); chat.scrollTop = chat.scrollHeight;

            try {
                const systemPrompt = "Eres QAXI AI, un asistente de inteligencia artificial avanzado integrado en la plataforma QAXI Cloud. Tienes dos funciones principales: 1) Eres un experto en conocimientos generales (historia, programación, matemáticas, ciencia, redacción creativa, etc.) y debes responder cualquier duda del usuario con precisión y elegancia. 2) Conoces el contexto de esta plataforma (Titanium Suite), que tiene herramientas de Docs, Sheets, PDF, Slides y QR. Respuesas breves, profesionales y útiles.";

                const response = await fetch("https://api.groq.com/openai/v1/chat/completions", {
                    method: "POST",
                    headers: { "Content-Type": "application/json", "Authorization": `Bearer ${GROQ_KEY}` },
                    body: JSON.stringify({
                        messages: [{ role: "system", content: systemPrompt }, { role: "user", content: prompt }],
                        model: "llama-3.3-70b-versatile", temperature: 0.7
                    })
                });

                if(!response.ok) throw new Error("Error API");
                const data = await response.json();
                document.getElementById('ai-loader').remove();
                
                const rDiv = document.createElement('div'); rDiv.className = 'msg ai';
                rDiv.innerHTML = `<strong>QAXI AI</strong><div>${marked.parse(data.choices[0].message.content)}</div>`;
                chat.appendChild(rDiv); chat.scrollTop = chat.scrollHeight;

            } catch(e) { 
                console.error(e);
                document.getElementById('ai-loader').innerHTML = `<strong>QAXI AI</strong><p>Error al conectar. Intenta de nuevo.</p>`;
            }
        };

        // === QR ===
        function loadQR(c, t) {
            c.innerHTML = `
                <div class="qr-wrapper">
                    <div class="qr-card">
                        <i class="fa-solid fa-qrcode" style="font-size: 3rem; margin-bottom:15px; color:#fff;"></i>
                        <h3 style="margin-bottom:20px; color:white;">Generador QR</h3>
                        <input type="text" id="qrText" placeholder="URL o Texto" style="width:100%; padding:10px; margin-bottom:15px; border:1px solid #333; background:#000; color:white; border-radius:4px;">
                        <button class="nav-btn" onclick="generateQR()" style="width:100%; border-color:var(--gold); color:var(--gold);">GENERAR</button>
                        <div id="qrOutput" style="margin-top:20px; width:150px; height:150px; background:white; display:flex; align-items:center; justify-content:center; border-radius:8px;"></div>
                    </div>
                </div>`;
        }
        window.generateQR = function() {
            const txt = document.getElementById('qrText').value;
            if(txt) document.getElementById('qrOutput').innerHTML = `<img src="https://api.qrserver.com/v1/create-qr-code/?size=150x150&data=${encodeURIComponent(txt)}">`;
        }
    </script>
</body>
</html>