<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>QAXI CLOUD | Titanium</title>
    <!-- Librerías: Firebase, FontAwesome, Marked (Markdown), JsPDF, Html2Canvas, MathJS -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mathjs/11.8.0/math.min.js"></script>
    

    <style>
        :root {
            --bg: #050505;
            --panel: rgba(20, 20, 20, 0.7);
            --border: #333333;
            --text: #e0e0e0;
            --gold: #D4AF37; 
            --gold-glow: rgba(212, 175, 55, 0.2);
            --font-main: 'Segoe UI', Roboto, sans-serif;
            --font-brand: 'Cinzel', serif; 
        }
        * { box-sizing: border-box; outline: none; }
        body {
            margin: 0; padding: 0;
            background-color: var(--bg);
            background-image: radial-gradient(circle at 50% 50%, #1a1a1a 0%, #000 100%);
            color: var(--text);
            font-family: var(--font-main);
            height: 100vh;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        /* --- Header --- */
        header {
            height: 60px;
            background: var(--panel);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border-bottom: 1px solid var(--border);
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 25px;
            z-index: 100;
            box-shadow: 0 5px 20px rgba(0,0,0,0.5);
        }
        .brand {
            font-family: var(--font-brand);
            font-size: 1.6rem;
            color: white;
            letter-spacing: 2px;
            display: flex;
            align-items: center;
            gap: 10px;
            text-shadow: 0 0 10px rgba(255,255,255,0.1);
        }
        .brand span { color: var(--gold); text-shadow: 0 0 10px var(--gold-glow); }
        .user-area { display: flex; align-items: center; gap: 15px; }
        
        .status-badge {
            font-size: 0.75rem;
            padding: 6px 14px;
            border-radius: 20px;
            background: rgba(255,255,255,0.05);
            border: 1px solid var(--border);
            color: #aaa;
            cursor: pointer;
            transition: all 0.3s ease;
            letter-spacing: 0.5px;
        }
        .status-badge:hover { background: rgba(255,255,255,0.1); color: white; }
        .status-badge.pro { 
            border-color: var(--gold); 
            color: var(--gold); 
            background: rgba(212,175,55,0.05);
        }
        .status-badge.pro:hover {
            background: var(--gold);
            color: black;
            box-shadow: 0 0 15px var(--gold-glow);
        }

        /* --- Main Layout --- */
        .main-container {
            display: flex;
            flex: 1;
            overflow: hidden;
        }

        /* Sidebar */
        .sidebar {
            width: 85px;
            background: var(--panel);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border-right: 1px solid var(--border);
            display: flex;
            flex-direction: column;
            align-items: center;
            padding-top: 30px;
            box-shadow: 5px 0 20px rgba(0,0,0,0.3);
            z-index: 90;
        }
        .app-icon {
            width: 50px; height: 50px;
            margin-bottom: 25px;
            border-radius: 14px;
            display: flex; flex-direction: column;
            justify-content: center; align-items: center;
            color: #777;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
            font-size: 1.3rem;
            background: transparent;
            border: 1px solid transparent;
            position: relative;
        }
        .app-icon:hover { 
            background: rgba(255,255,255,0.08); 
            color: white; 
            transform: translateY(-2px);
            border-color: rgba(255,255,255,0.1);
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
        }
        .app-icon i { margin-bottom: 3px; }
        .app-icon span { font-size: 0.5rem; letter-spacing: 1px; font-weight: 600; }
        
        .pro-tag {
            position: absolute; top: -5px; right: -5px;
            background: var(--gold); color: black;
            font-size: 0.5rem; padding: 2px 4px; border-radius: 4px;
            font-weight: 800; box-shadow: 0 0 5px var(--gold-glow);
        }

        /* Content Area */
        .content-area {
            flex: 1;
            position: relative;
            display: flex; flex-direction: column;
        }

        /* Hero / Dashboard */
        .hero {
            flex: 1;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            text-align: center;
            animation: fadeIn 0.8s ease;
            position: relative;
            height: 100%;
        }
        .hero h1 {
            font-family: var(--font-brand);
            font-size: 3.5rem;
            margin: 0 0 15px 0;
            background: linear-gradient(135deg, #fff 30%, #888 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            z-index: 2;
            text-shadow: 0 10px 30px rgba(0,0,0,0.5);
        }
        .hero p { 
            color: #888; font-size: 1.1rem; max-width: 450px; margin-bottom: 30px; z-index: 2; line-height: 1.6;
        }

        /* Modal Overlay (LOGIN) */
        .modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.85); backdrop-filter: blur(5px);
            z-index: 2000;
            display: none; justify-content: center; align-items: center;
        }
        .modal {
            background: #111; border: 1px solid var(--border);
            padding: 40px; border-radius: 12px; width: 350px;
            text-align: center; box-shadow: 0 20px 50px rgba(0,0,0,0.5);
        }
        .modal h2 { margin-top:0; color:white; font-family:var(--font-brand); margin-bottom: 10px; }
        .modal input { 
            width:100%; background:#050505; border:1px solid #333; 
            padding:12px; color:white; border-radius:6px; margin: 20px 0;
        }
        .modal input:focus { border-color:var(--gold); }

        /* --- Workspace (App Window) --- */
        #ws {
            position: absolute;
            top: 0; left: 0; width: 100%; height: 100%;
            background: #080808;
            display: none;
            flex-direction: column;
            z-index: 50;
            animation: zoomIn 0.3s cubic-bezier(0.16, 1, 0.3, 1);
        }
        .ws-header {
            height: 55px;
            background: #111;
            border-bottom: 1px solid #252525;
            display: flex; align-items: center;
            padding: 0 20px;
            justify-content: space-between;
        }
        .ws-title { font-family: var(--font-brand); color: white; letter-spacing: 1px; font-size: 1.2rem; }
        .ws-tools { display: flex; gap: 8px; align-items: center; }
        .nav-btn {
            background: #1a1a1a; 
            border: 1px solid #333;
            color: #ccc; 
            padding: 6px 14px; 
            cursor: pointer;
            font-size: 0.75rem; 
            letter-spacing: 1px;
            border-radius: 4px;
            transition: 0.2s;
        }
        .nav-btn:hover { border-color: var(--gold); color: white; background: #222; }
        .ws-stage { flex: 1; overflow: hidden; position: relative; background: #0c0c0c; }

        /* === APPS STYLES === */
        
        /* DOCS */
        .doc-toolbar {
            min-height: 44px; background: #161616; border-bottom: 1px solid #252525;
            display: flex; align-items: center; padding: 8px 15px; gap: 8px; flex-wrap: wrap;
        }
        .tb-btn {
            background: transparent; border: 1px solid transparent; color: #aaa; cursor: pointer;
            width: 32px; height: 32px; border-radius: 4px; display: flex; justify-content: center; align-items: center;
            transition: 0.2s;
        }
        .tb-btn:hover { background: #252525; color: white; border-color: #333; }
        .tb-select, .tb-input {
            background: #0a0a0a; color: #ddd; border: 1px solid #333;
            padding: 6px 10px; font-size: 0.8rem; border-radius: 4px; cursor: pointer;
        }
        .tb-select:focus, .tb-input:focus { border-color: var(--gold); }
        .sep { width: 1px; height: 24px; background: #333; margin: 0 6px; }
        #paper {
            width: 794px; min-height: 1123px;
            background: white; color: black;
            box-shadow: 0 0 30px rgba(0,0,0,0.6);
            margin: 30px; padding: 50px;
            outline: none; overflow-y: hidden;
            font-family: 'Segoe UI', sans-serif;
            font-size: 16px;
            line-height: 1.6;
        }
        .doc-status {
            height: 30px; background: #111; border-top: 1px solid #252525;
            display: flex; align-items: center; justify-content: space-between;
            padding: 0 15px; font-size: 0.75rem; color: #666;
        }
        
        /* Autosave indicator */
        .autosave-indicator {
            display: flex;
            align-items: center;
            gap: 5px;
            font-size: 0.7rem;
            color: #666;
            transition: 0.3s;
        }
        .autosave-indicator.saving { color: var(--gold); }
        .autosave-indicator.saved { color: #4a4; }
        
        /* Magic Writing Button */
        .magic-btn {
            background: linear-gradient(135deg, #D4AF37 0%, #aa8a2e 100%);
            color: black;
            border: none;
            padding: 6px 12px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.75rem;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 5px;
            transition: 0.3s;
        }
        .magic-btn:hover { transform: scale(1.05); box-shadow: 0 0 15px var(--gold-glow); }
        
        /* Font Select with Preview */
        .font-select-wrapper {
            position: relative;
        }
        #fontSelect {
            min-width: 150px;
        }
        #fontSelect option {
            padding: 8px;
            font-size: 14px;
        }

        /* SHEETS */
        .grid-container { width: 100%; height: calc(100% - 30px); overflow: auto; background: #151515; }
        .grid { border-collapse: separate; border-spacing: 0; min-width: 100%; table-layout: fixed; }
        .grid th, .grid td {
            border-right: 1px solid #333; border-bottom: 1px solid #333; 
            padding: 0; min-width: 80px; height: 26px;
            text-align: center; font-size: 0.85rem; color: #ccc; position: relative;
        }
        .grid th { background: #1f1f1f; color: #888; font-weight: 600; position: sticky; top: 0; left: 0; z-index: 2; }
        .grid td input {
            width: 100%; height: 100%; border: none; background: transparent;
            color: #eee; text-align: right; padding: 0 6px; font-family: 'Segoe UI', sans-serif;
        }
        .grid td input:focus { background: #000; outline: 2px solid var(--gold); z-index: 5; }

        /* AI CHAT */
        .ai-box {
            width: 100%; height: 100%; display: flex; flex-direction: column;
            background: #0c0c0c;
        }
        .chat-window {
            flex: 1; overflow-y: auto; padding: 30px;
            display: flex; flex-direction: column; gap: 20px; align-items: center;
        }
        .msg {
            width: 100%; max-width: 900px; padding: 14px 18px; border-radius: 12px;
            font-size: 0.98rem; line-height: 1.6; box-shadow: 0 2px 10px rgba(0,0,0,0.25);
        }
        /* AI responses: centered and minimalist */
        .msg.ai { align-self: center; background: rgba(255,255,255,0.02); border: 1px solid rgba(255,255,255,0.03); color: #ddd; text-align: center; }
        /* User messages remain right-aligned */
        .msg.user { align-self: flex-end; background: #252525; color: white; border-right: 3px solid #555; }
        .msg strong { display: none; }
        
        /* Estilos para contenido de IA */
        .msg.ai h1, .msg.ai h2, .msg.ai h3 { color: #fff; margin: 16px 0 10px 0; }
        .msg.ai h1 { font-size: 1.3rem; border-bottom: 1px solid #333; padding-bottom: 8px; }
        .msg.ai h2 { font-size: 1.15rem; color: var(--gold); }
        .msg.ai h3 { font-size: 1.05rem; }
        .msg.ai p { margin: 10px 0; }
        .msg.ai ul, .msg.ai ol { margin: 12px 0; padding-left: 24px; }
        .msg.ai li { margin: 6px 0; }
        .msg.ai code { 
            background: #0d0d0d; 
            padding: 2px 6px; 
            border-radius: 4px; 
            font-family: 'Consolas', 'Monaco', monospace;
            font-size: 0.9em;
            color: #e06c75;
        }
        .msg.ai pre { 
            background: #0a0a0a; 
            padding: 15px; 
            border-radius: 8px; 
            overflow-x: auto;
            border: 1px solid #333;
            margin: 12px 0;
        }
        .msg.ai pre code { 
            background: none; 
            padding: 0; 
            color: #abb2bf;
            display: block;
            line-height: 1.5;
        }
        .msg.ai blockquote {
            border-left: 3px solid var(--gold);
            margin: 12px 0;
            padding: 10px 15px;
            background: rgba(212, 175, 55, 0.05);
            font-style: italic;
        }
        .msg.ai table { 
            border-collapse: collapse; 
            margin: 12px 0; 
            width: 100%;
        }
        .msg.ai th, .msg.ai td { 
            border: 1px solid #333; 
            padding: 8px 12px; 
            text-align: left;
        }
        .msg.ai th { background: #252525; color: var(--gold); }
        .msg.ai a { color: var(--gold); text-decoration: none; }
        .msg.ai a:hover { text-decoration: underline; }
        .msg.ai hr { border: none; border-top: 1px solid #333; margin: 15px 0; }
        /* Input bar styled like modern chat UIs */
        .ai-input-wrap { display:flex; justify-content:center; padding:12px; border-top:1px solid rgba(255,255,255,0.02); }
        .ai-input-pill { width:100%; max-width:900px; display:flex; gap:8px; align-items:center; background: rgba(255,255,255,0.02); padding:8px; border-radius:999px; border:1px solid rgba(255,255,255,0.03); }
        .ai-input-pill input[type="text"] { flex:1; background:transparent; border:none; color: #e0e0e0; padding:10px 12px; font-size:1rem; }
        .ai-input-pill input[type="text"]:focus { outline:none; }
        .ai-attach-btn { background:transparent; border:none; color:#aaa; padding:6px; cursor:pointer; }
        .ai-send-btn { background:var(--gold); color:black; border:none; padding:8px 12px; border-radius:8px; cursor:pointer; }
        .ai-response { text-align:center; }
        .ai-sender { font-size:0.85rem; color:var(--gold); margin-bottom:6px; text-align:center; font-weight:700; }
        .ai-response-short { color:#ddd; }
        .ai-response-full { color:#ddd; text-align:left; }
        
        /* CARNET CREATOR */
        .carnet-container {
            display: flex;
            width: 100%;
            height: 100%;
            padding: 30px;
            gap: 40px;
            overflow: auto;
        }
        .carnet-form {
            flex: 1;
            max-width: 400px;
            display: flex;
            flex-direction: column;
            gap: 15px;
        }
        .carnet-form label {
            font-size: 0.8rem;
            color: #888;
            margin-bottom: -10px;
        }
        .carnet-form input, .carnet-form select {
            padding: 12px;
            background: #111;
            border: 1px solid #333;
            color: white;
            border-radius: 6px;
            font-size: 0.9rem;
        }
        .carnet-form input:focus, .carnet-form select:focus {
            border-color: var(--gold);
        }
        .carnet-preview-area {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }
        .carnet-card {
            width: 350px;
            height: 220px;
            border-radius: 15px;
            padding: 20px;
            position: relative;
            overflow: hidden;
            box-shadow: 0 10px 40px rgba(0,0,0,0.5);
            display: flex;
            gap: 15px;
        }
        .carnet-card.style-corporate {
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 50%, #0f3460 100%);
            color: white;
        }
        .carnet-card.style-modern {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        .carnet-card.style-elegant {
            background: linear-gradient(135deg, #232526 0%, #414345 100%);
            color: white;
            border: 2px solid var(--gold);
        }
        .carnet-card.style-vibrant {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            color: white;
        }
        .carnet-card.style-nature {
            background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
            color: white;
        }
        .carnet-card.style-sunset {
            background: linear-gradient(135deg, #fa709a 0%, #fee140 100%);
            color: #333;
        }
        .carnet-photo {
            width: 90px;
            height: 110px;
            background: rgba(255,255,255,0.2);
            border-radius: 8px;
            overflow: hidden;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
        }
        .carnet-photo img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        .carnet-photo i {
            font-size: 2.5rem;
            opacity: 0.5;
        }
        .carnet-info {
            flex: 1;
            display: flex;
            flex-direction: column;
            justify-content: center;
        }
        .carnet-company {
            font-size: 0.7rem;
            text-transform: uppercase;
            letter-spacing: 2px;
            opacity: 0.8;
            margin-bottom: 5px;
        }
        .carnet-name {
            font-size: 1.3rem;
            font-weight: bold;
            margin-bottom: 3px;
        }
        .carnet-role {
            font-size: 0.85rem;
            opacity: 0.9;
            margin-bottom: 10px;
        }
        .carnet-id {
            font-size: 0.75rem;
            font-family: monospace;
            opacity: 0.7;
        }
        .carnet-qr {
            position: absolute;
            bottom: 15px;
            right: 15px;
            width: 50px;
            height: 50px;
            background: white;
            border-radius: 5px;
            padding: 3px;
        }
        .carnet-qr img {
            width: 100%;
            height: 100%;
        }
        .carnet-logo {
            position: absolute;
            top: 15px;
            right: 15px;
            font-size: 1.5rem;
            opacity: 0.3;
        }
        .color-row {
            display: flex;
            gap: 10px;
            align-items: center;
        }
        .color-row input[type="color"] {
            width: 40px;
            height: 40px;
            padding: 0;
            border: none;
            cursor: pointer;
        }
        .photo-upload-btn {
            background: var(--gold);
            color: black;
            border: none;
            padding: 10px 15px;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            font-size: 0.85rem;
        }
        .photo-upload-btn:hover {
            transform: scale(1.02);
        }
        .share-options {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }
        .share-btn {
            padding: 10px 20px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.8rem;
            font-weight: 600;
            border: 1px solid #333;
            background: #1a1a1a;
            color: #ccc;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: 0.2s;
        }
        .share-btn:hover {
            border-color: var(--gold);
            color: white;
        }
        .share-btn.primary {
            background: var(--gold);
            color: black;
            border-color: var(--gold);
        }
        .carnet-card.style-custom {
            background: #333;
            background-size: cover;
            background-position: center;
            color: white;
        }
        
        /* FIRMA PDF */
        .firma-container {
            display: flex;
            width: 100%;
            height: 100%;
            gap: 20px;
            padding: 20px;
        }
        .firma-sidebar {
            width: 280px;
            background: #111;
            border: 1px solid #333;
            border-radius: 10px;
            padding: 20px;
            display: flex;
            flex-direction: column;
            gap: 15px;
        }
        .firma-preview {
            flex: 1;
            background: #1a1a1a;
            border: 1px solid #333;
            border-radius: 10px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            overflow: auto;
            position: relative;
        }
        .firma-canvas-container {
            background: #0a0a0a;
            border: 1px solid #444;
            border-radius: 8px;
            padding: 10px;
            margin-bottom: 15px;
        }
        #firmaCanvas {
            background: transparent;
            border-radius: 5px;
            cursor: crosshair;
        }
        .firma-tools {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }
        .firma-tool-btn {
            padding: 8px 12px;
            background: #222;
            border: 1px solid #444;
            color: #ccc;
            border-radius: 5px;
            cursor: pointer;
            font-size: 0.8rem;
            transition: 0.2s;
        }
        .firma-tool-btn:hover {
            border-color: var(--gold);
            color: white;
        }
        .firma-tool-btn.active {
            background: var(--gold);
            color: black;
            border-color: var(--gold);
        }
        .pdf-preview-container {
            max-width: 100%;
            max-height: 100%;
            overflow: auto;
            padding: 20px;
        }
        .pdf-preview-container canvas {
            box-shadow: 0 5px 30px rgba(0,0,0,0.5);
        }
        .firma-overlay {
            position: absolute;
            cursor: move;
            border: 2px dashed var(--gold);
            padding: 5px;
            background: transparent;
        }
        .firma-overlay img {
            max-width: 150px;
            max-height: 80px;
            pointer-events: none;
        }
        .ai-input-area {
            height: 80px; background: #111; border-top: 1px solid #252525;
            display: flex; align-items: center; padding: 0 30px; gap: 15px;
        }
        #aiInput {
            flex: 1; background: #050505; border: 1px solid #333;
            color: white; padding: 12px 15px; border-radius: 6px; font-size: 0.95rem;
            transition: 0.3s;
        }
        #aiInput:focus { border-color: var(--gold); box-shadow: 0 0 10px rgba(212,175,55,0.1); }
        .ai-input-area button {
            background: var(--gold); color: black; border: none; width: 40px; height: 40px;
            border-radius: 6px; cursor: pointer; transition: 0.2s;
        }
        .ai-input-area button:hover { transform: scale(1.05); }

        /* PDF & QR */
        .pdf-zone, .qr-wrapper { height: 100%; display:flex; flex-direction: column; align-items: center; justify-content: flex-start; padding-top:40px; }
        .qr-card {
            background: #181818; padding: 40px; border: 1px solid #333; border-radius: 12px;
            display: flex; flex-direction: column; align-items: center;
            width: 380px; box-shadow: 0 10px 40px rgba(0,0,0,0.6);
        }
        .pdf-list {
            margin-top: 20px; width: 80%; max-width: 600px;
            display: grid; grid-template-columns: repeat(auto-fill, minmax(100px, 1fr)); gap: 10px;
        }
        .pdf-item {
            background: #1a1a1a; padding: 10px; border-radius: 6px; border: 1px solid #333;
            font-size: 0.75rem; text-align: center; position: relative; overflow: hidden;
            display: flex; flex-direction: column; align-items: Center; aspect-ratio: 1;
        }
        .pdf-item i { font-size: 2rem; color: #555; margin-bottom: 5px; }
        .pdf-item .del { 
            position: absolute; top:0; right: 0; background: red; color:white; 
            width: 20px; height: 20px; cursor: pointer; font-size:0.7rem; display:flex; align-items:center; justify-content:center;
        }

        /* PRESENTATIONS TOOL */
        .slides-layout { display: flex; width: 100%; height: 100%; }
        .slides-sidebar {
            width: 160px; background: #111; border-right: 1px solid #252525;
            display: flex; flex-direction: column; padding: 10px; gap: 10px; overflow-y: auto;
        }
        .slide-thumb {
            width: 100%; aspect-ratio: 16/9; background: white; cursor: pointer;
            border: 2px solid transparent; transition: 0.2s; position: relative;
            overflow: hidden;
        }
        .slide-thumb.active { border-color: var(--gold); }
        .slide-thumb span {
            position: absolute; bottom: 2px; right: 4px; color: black; font-size: 10px; font-weight: bold;
        }
        .slides-main {
            flex: 1; background: #1a1a1a; display: flex; justify-content: center; align-items: center;
            position: relative; overflow: hidden;
        }
        .slide-canvas {
            width: 800px; height: 450px; background: white; box-shadow: 0 0 50px rgba(0,0,0,0.5);
            position: relative; overflow: hidden; color: black;
        }
        
        /* Draggable elements in slides */
        .slide-element {
            position: absolute;
            cursor: move;
            user-select: none;
            min-width: 50px;
            min-height: 20px;
            border: 2px solid transparent;
            transition: border-color 0.2s;
        }
        .slide-element:hover { border-color: rgba(212, 175, 55, 0.5); }
        .slide-element.selected { border-color: var(--gold); }
        .slide-element.editing { cursor: text; }
        .slide-element img { 
            width: 100%; height: 100%; object-fit: contain; 
            pointer-events: none;
        }
        
        /* Resize handle */
        .resize-handle {
            position: absolute;
            width: 12px; height: 12px;
            background: var(--gold);
            border-radius: 2px;
            bottom: -6px; right: -6px;
            cursor: nwse-resize;
        }

        /* Animaciones */
        @keyframes fadeIn { from {opacity:0; transform:translateY(15px);} to {opacity:1; transform:translateY(0);} }
        @keyframes zoomIn { from {opacity:0; transform:scale(0.98);} to {opacity:1; transform:scale(1);} }
        
        /* Pro Badge Glow */
        body.is-pro .status-badge.pro { box-shadow: 0 0 15px rgba(212,175,55,0.4); }
    </style>
</head>
<body>

    <!-- Firebase Config -->
    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyDbZAPtQioiXZzkiiIRrkrBkEPF440NMaE",
            authDomain: "qaxi-93d6d.firebaseapp.com",
            projectId: "qaxi-93d6d",
            storageBucket: "qaxi-93d6d.firebasestorage.app",
            messagingSenderId: "137240859996",
            appId: "1:137240859996:web:73e14d28c77233be965d99"
        };

        window.toggleAiExpand = function(btn) {
            try {
                const msg = btn.closest('.msg');
                if(!msg) return;
                const full = msg.querySelector('.ai-response-full');
                const short = msg.querySelector('.ai-response-short');
                if(!full || !short) return;
                if (full.style.display === 'none') {
                    full.style.display = 'block';
                    short.style.display = 'none';
                    btn.innerText = 'Ver menos';
                } else {
                    full.style.display = 'none';
                    short.style.display = 'block';
                    btn.innerText = 'Ver más';
                }
            } catch(e){ console.warn('toggleAiExpand', e); }
        };

        // === QAXI STORE ===
        // Store app removed by user request. (loadStore / purchaseProduct intentionally omitted)
        try { firebase.initializeApp(firebaseConfig); var db = firebase.firestore(); } catch(e){ console.log("Offline or Config Error"); }

        // GROQ API key: read from localStorage (no hard-coded key)
        let GROQ_KEY = localStorage.getItem('qaxi_groq_key') || '';

        window.setGroqKey = function(key){ GROQ_KEY = key || ''; try{ if(key) localStorage.setItem('qaxi_groq_key', key); else localStorage.removeItem('qaxi_groq_key'); }catch(e){} };
        window.clearGroqKey = function(){ GROQ_KEY = ''; try{ localStorage.removeItem('qaxi_groq_key'); }catch(e){} };

        // Helper to call Groq/OpenAI endpoint using dynamic key
        window.callGroqProxy = async function({ forwardTo, payload }) {
            if(!GROQ_KEY) throw new Error('MISSING_API_KEY');
            return fetch(forwardTo, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${GROQ_KEY}` },
                body: JSON.stringify(payload)
            });
        };

        let IS_PREMIUM = false;
        
        // Storage Keys
        const STORAGE_KEYS = {
            DOCS: 'qaxi_docs_content',
            SLIDES: 'qaxi_slides_data',
            SHEETS: 'qaxi_sheets_data',
            SHEETS_BOOK: 'qaxi_sheets_workbook',
            LIVE: 'qaxi_live_meetings',
            LIVE_SETTINGS: 'qaxi_live_settings'
        };
        
        // Docs & Sheets Vars
        let sheetRows = 20, sheetCols = 10;
        let sheetsWorkbook = null; // will hold array of sheets
        let activeSheetIdx = 0;
        let activeCell = {row:1, col:1};
        let pdfImages = [];
        let autoSaveTimer = null;
        let hasUnsavedChanges = false;

        // Slides Vars
        let slides = [{id:1, elements: [], bg: '#ffffff'}];
        let currentSlideIdx = 0;
        let selectedElement = null;
        let isDragging = false;
        let isResizing = false;
        let dragOffset = { x: 0, y: 0 };
        
        // AI Chat History
        let aiChatHistory = [];
        const MAX_HISTORY = 20; // Mantener últimos 20 mensajes para contexto
        // Live sync variables
        let liveCloudSync = false;
        let liveUnsubscribe = null;
        let cloudMeetings = [];
        
        // Warn before leaving if unsaved changes
        window.addEventListener('beforeunload', (e) => {
            // Auto-save before leaving
            autoSaveAll();
        });
    </script>

    <!-- Modal Login -->
    <div class="modal-overlay" id="loginModal">
        <div class="modal">
            <h2>ACCESO QAXI</h2>
            <p style="color:#888; margin-bottom:10px;">Ingresa tu correo Titanium</p>
            <input type="email" id="uEmail" placeholder="usuario@email.com">
            <button class="nav-btn" onclick="checkDB()" style="width:100%; border-color:var(--gold); color:var(--gold); padding:10px;">VALIDAR</button>
            <button class="nav-btn" onclick="closeLogin()" style="width:100%; border:none; margin-top:10px;">CANCELAR</button>
            <p id="loginMsg" style="color:var(--gold); margin-top:15px; font-size:0.8rem; height:1rem;"></p>
        </div>
    </div>

    <!-- Header -->
    <header>
        <div class="brand">QAXI<span>CLOUD</span></div>
        <div class="user-area">
            <div class="status-badge" id="accessBtn" onclick="openLogin()">ACCEDER</div>
            <div class="status-badge pro" onclick="goPlans()">TITANIUM PLAN</div>
        </div>
    </header>

    <div class="main-container">
        <!-- Sidebar -->
        <div class="sidebar">
            <div class="app-icon" onclick="startApp('docs')" title="Documentos"><i class="fa-solid fa-file-word"></i><span>DOCS</span></div>
            <div class="app-icon" onclick="startApp('sheets')" title="Hojas de Cálculo"><i class="fa-solid fa-table"></i><span>SHEET</span></div>
            <div class="app-icon" onclick="startApp('pdf')" title="PDF Converter"><i class="fa-solid fa-file-pdf"></i><span>PDF</span></div>
            <div class="app-icon" onclick="startApp('slides')" title="Presentaciones QAXI">
                <i class="fa-solid fa-chalkboard-user"></i><span>SLIDES</span>
                <div class="pro-tag">PRO</div>
            </div>
            <div class="app-icon" onclick="startApp('ai')" title="QAXI AI"><i class="fa-solid fa-brain"></i><span>AI</span></div>
            <!-- Store removed per user request -->
            <!-- QAXI Search removed -->
            <div class="app-icon" onclick="startApp('carnet')" title="Creador de Carnets">
                <i class="fa-solid fa-id-card"></i><span>CARNET</span>
                <div class="pro-tag">PRO</div>
            </div>
            <div class="app-icon" onclick="startApp('live')" title="QAXI Live"><i class="fa-solid fa-video"></i><span>LIVE</span></div>
            
            <div class="app-icon" onclick="startApp('qr')" title="Generador QR"><i class="fa-solid fa-qrcode"></i><span>QR</span></div>
            <div class="app-icon" onclick="startApp('firma')" title="Firmar PDF"><i class="fa-solid fa-signature"></i><span>FIRMA</span></div>
            <div style="flex:1"></div>
            <div class="app-icon" onclick="goHome()" title="Salir"><i class="fa-solid fa-power-off"></i></div>
        </div>

        <!-- Content -->
        <div class="content-area">
            <div class="hero" id="heroPanel">
                <h1 id="heroTitle">Bienvenido a QAXI Cloud!</h1>
                <p id="heroSub">Potencia tu flujo de trabajo seleccionando una herramienta Titanium en el menú lateral.<br>El futuro de tu productividad empieza aquí.</p>
            </div>

            <!-- Workspace Overlay -->
            <div id="ws">
                <div class="ws-header">
                    <div class="ws-title" id="appName">APP</div>
                    <div class="ws-tools" id="appTools"></div>
                    <div class="nav-btn" onclick="exitApp()" style="margin-left:15px; border-color: #555;">CERRAR</div>
                </div>
                <div class="ws-stage" id="wsContent"></div>
            </div>
        </div>
    </div>

    <script>
        window.goHome = function() { 
            autoSaveAll();
            window.location.href = "Index.html"; 
        };
        window.goPlans = function() {
            if (IS_PREMIUM) return;
            const p = encodeURIComponent("QAXI Cloud PRO - Titanium");
            window.location.href = `qaxipay.html?p=${p}&v=15000&t=MICROAPP`;
        };

        // --- AUTO SAVE FUNCTIONS ---
        function autoSaveAll() {
            const paper = document.getElementById('paper');
            if (paper) {
                localStorage.setItem(STORAGE_KEYS.DOCS, paper.innerHTML);
            }
            // Save slides
            if (slides && slides.length > 0) {
                localStorage.setItem(STORAGE_KEYS.SLIDES, JSON.stringify(slides));
            }
            // Save sheets (serialize grid values)
            const grid = document.getElementById('mainGrid');
            if (grid) {
                try {
                    const data = { rows: sheetRows, cols: sheetCols, values: [] };
                    const trs = grid.querySelectorAll('tbody tr');
                    trs.forEach(tr => {
                        const rowVals = [];
                        tr.querySelectorAll('td input').forEach(inp => rowVals.push(inp.value));
                        data.values.push(rowVals);
                    });
                    localStorage.setItem(STORAGE_KEYS.SHEETS, JSON.stringify(data));
                    // also save workbook if exists
                    if (window.sheetsWorkbook && Array.isArray(window.sheetsWorkbook)) {
                        // update active sheet values in workbook
                        window.sheetsWorkbook[activeSheetIdx] = window.sheetsWorkbook[activeSheetIdx] || {};
                        window.sheetsWorkbook[activeSheetIdx].rows = sheetRows;
                        window.sheetsWorkbook[activeSheetIdx].cols = sheetCols;
                        window.sheetsWorkbook[activeSheetIdx].values = data.values;
                        localStorage.setItem(STORAGE_KEYS.SHEETS_BOOK, JSON.stringify(window.sheetsWorkbook));
                    }
                } catch (e) { console.warn('Error saving sheets', e); }
            }
        }
        
        function showSaveIndicator(status) {
            const indicator = document.getElementById('autosaveIndicator');
            if (!indicator) return;
            
            indicator.className = 'autosave-indicator ' + status;
            if (status === 'saving') {
                indicator.innerHTML = '<i class="fa-solid fa-circle-notch fa-spin"></i> Guardando...';
            } else if (status === 'saved') {
                indicator.innerHTML = '<i class="fa-solid fa-check"></i> Guardado';
                setTimeout(() => {
                    indicator.innerHTML = '<i class="fa-solid fa-cloud"></i> Auto-guardado activo';
                    indicator.className = 'autosave-indicator';
                }, 2000);
            }
        }
        
        function triggerAutoSave() {
            if (autoSaveTimer) clearTimeout(autoSaveTimer);
            showSaveIndicator('saving');
            autoSaveTimer = setTimeout(() => {
                autoSaveAll();
                showSaveIndicator('saved');
            }, 1000);
        }

        // --- SISTEMA DE LOGIN ---
        window.openLogin = function() {
            document.getElementById('loginModal').style.display = 'flex';
        };

        window.closeLogin = function() {
            document.getElementById('loginModal').style.display = 'none';
            document.getElementById('loginMsg').innerText = "";
        };

        window.checkDB = async function() {
            const email = document.getElementById('uEmail').value.trim().toLowerCase();
            const msg = document.getElementById('loginMsg');
            
            if(!email) { msg.innerText = "Ingresa tu correo."; return; }
            msg.innerText = "Verificando...";

            try {
                if (!db) throw new Error('Firestore no inicializado');

                // Primero intentar buscar documento con id = email
                try {
                    const docRef = db.collection('QAXI_Cloud').doc(email);
                    const doc = await docRef.get();
                    if (doc && doc.exists) {
                        setProMode(email);
                        closeLogin();
                        document.getElementById('accessBtn').style.display = 'none';
                        return;
                    }
                } catch (innerErr) {
                    // ignore and fallback to query by field
                    console.warn('Doc lookup failed, fallback to query', innerErr);
                }

                // Fallback: buscar campo 'email' en la colección
                const q = db.collection("QAXI_Cloud").where("email", "==", email);
                const querySnapshot = await q.get();

                if(!querySnapshot.empty) {
                    setProMode(email);
                    closeLogin();
                    document.getElementById('accessBtn').style.display = 'none';
                } else {
                    msg.style.color = "#ff4444";
                    msg.innerText = "No tienes Licencia Titanium activa.";
                }
            } catch(e) {
                console.error(e);
                msg.style.color = "#ff4444";
                msg.innerText = "Error de conexión/config. Comprueba Firebase.";
            }
        };

        function setProMode(email) {
            IS_PREMIUM = true;
            document.body.classList.add('is-pro');
            document.getElementById('heroTitle').innerText = "Bienvenido, QAXI PRO";
            document.getElementById('heroTitle').style.color = "var(--gold)";
            document.getElementById('heroSub').innerText = "LICENCIA PREMIUM ACTIVADA";
        }

        function setFreeMode() {
            IS_PREMIUM = false;
            document.body.classList.remove('is-pro');
        }

        window.startApp = function(id) {
            if ((id === 'slides' || id === 'carnet') && !IS_PREMIUM) {
                return goPlans();
            }

            document.getElementById('ws').style.display = 'flex';
            const stage = document.getElementById('wsContent');
            const tools = document.getElementById('appTools');
            const title = document.getElementById('appName');
            
            stage.innerHTML = ''; tools.innerHTML = ''; title.innerText = id.toUpperCase();
            pdfImages = []; 

            if(id === 'docs') loadDocs(stage, tools);
            if(id === 'sheets') loadSheets(stage, tools);
            if(id === 'pdf') loadPDF(stage, tools);
            if(id === 'qr') loadQR(stage, tools);
            if(id === 'ai') loadAI(stage, tools);
            if(id === 'search') loadSearch(stage, tools);
            if(id === 'live') loadLive(stage, tools);
            if(id === 'slides') loadSlides(stage, tools);
            if(id === 'carnet') loadCarnet(stage, tools);
            if(id === 'firma') loadFirma(stage, tools);
        };

        window.exitApp = function() { 
            autoSaveAll();
            document.getElementById('ws').style.display = 'none'; 
        };

        // ========================================
        // === DOCS (CON AUTOGUARDADO Y FUENTES MEJORADAS) ===
        // ========================================
        
        let savedSelection = null;
        
        // Lista de fuentes disponibles
        const FONTS = [
            { name: 'Normal', value: "'Segoe UI', Arial, sans-serif" }
        ];
        
        function saveSelection() {
            const sel = window.getSelection();
            if (sel.rangeCount > 0) {
                savedSelection = sel.getRangeAt(0).cloneRange();
            }
        }
        
        function restoreSelection() {
            if (savedSelection) {
                const sel = window.getSelection();
                sel.removeAllRanges();
                sel.addRange(savedSelection);
            }
        }

        // Insert plain text reliably at current selection/caret
        window.insertTextAtSelection = function(text) {
            try {
                restoreSelection();
                const sel = window.getSelection();
                const paper = document.getElementById('paper');
                if (!sel.rangeCount) {
                    if (paper) {
                        const range = document.createRange();
                        range.selectNodeContents(paper);
                        range.collapse(false);
                        sel.removeAllRanges();
                        sel.addRange(range);
                    }
                }
                if (!sel.rangeCount) return;
                const range = sel.getRangeAt(0);
                range.deleteContents();
                const tn = document.createTextNode(text);
                range.insertNode(tn);
                // move caret after inserted node
                range.setStartAfter(tn);
                range.collapse(true);
                sel.removeAllRanges();
                sel.addRange(range);
            } catch (e) { console.warn('insertTextAtSelection failed', e); }
        };

        function loadDocs(c, t) {
            t.innerHTML = `
                <button class="magic-btn" onclick="magicWriting()">
                    <i class="fa-solid fa-wand-magic-sparkles"></i> Escritura Mágica (Beta)
                </button>
                <div class="sep"></div>
                <button class="nav-btn" onclick="clearDoc()">NUEVO</button>
                <button class="nav-btn" onclick="exportDocPdf()">CONVERTIR A PDF</button>
                <button class="nav-btn" onclick="window.print()">IMPRIMIR</button>
            `;
            c.innerHTML = `
                <div style="display:flex; flex-direction:column; width:100%; height:100%;">
                    <div class="doc-toolbar">
                        <!-- Selector de Fuente -->
                        <select class="tb-select" id="fontSelect" title="Fuente">
                            <option value="'Segoe UI', Arial, sans-serif">Normal</option>
                        </select>
                        
                        <div class="sep"></div>
                        
                        <!-- Estilos Básicos -->
                        <button class="tb-btn" onmousedown="event.preventDefault(); applyFormat('bold')" title="Negrita"><i class="fa-solid fa-bold"></i></button>
                        <button class="tb-btn" onmousedown="event.preventDefault(); applyFormat('italic')" title="Cursiva"><i class="fa-solid fa-italic"></i></button>
                        <button class="tb-btn" onmousedown="event.preventDefault(); applyFormat('underline')" title="Subrayado"><i class="fa-solid fa-underline"></i></button>
                        <button class="tb-btn" onmousedown="event.preventDefault(); applyFormat('strikeThrough')" title="Tachado"><i class="fa-solid fa-strikethrough"></i></button>
                        
                        <div class="sep"></div>
                        
                        <!-- Color Texto -->
                        <div style="display:flex; align-items:center;">
                            <label style="font-size:11px; color:#888; margin-right:4px;"><i class="fa-solid fa-font"></i></label>
                            <input type="color" id="colorTx" value="#000000" style="border:none; width:24px; height:24px; background:none; cursor:pointer; padding:0;">
                        </div>
                        
                        <!-- Color Fondo -->
                        <div style="display:flex; align-items:center; margin-left:5px;">
                            <label style="font-size:11px; color:#888; margin-right:4px;"><i class="fa-solid fa-highlighter"></i></label>
                            <input type="color" id="colorBg" value="#ffff00" style="border:none; width:24px; height:24px; background:none; cursor:pointer; padding:0;">
                        </div>

                        <div class="sep"></div>

                        <!-- Alineaciones -->
                        <button class="tb-btn" onmousedown="event.preventDefault(); applyFormat('justifyLeft')" title="Izquierda"><i class="fa-solid fa-align-left"></i></button>
                        <button class="tb-btn" onmousedown="event.preventDefault(); applyFormat('justifyCenter')" title="Centro"><i class="fa-solid fa-align-center"></i></button>
                        <button class="tb-btn" onmousedown="event.preventDefault(); applyFormat('justifyRight')" title="Derecha"><i class="fa-solid fa-align-right"></i></button>
                        <button class="tb-btn" onmousedown="event.preventDefault(); applyFormat('justifyFull')" title="Justificar"><i class="fa-solid fa-align-justify"></i></button>
                        
                        <div class="sep"></div>
                        
                        <!-- Listas -->
                        <button class="tb-btn" onmousedown="event.preventDefault(); applyFormat('insertUnorderedList')" title="Lista"><i class="fa-solid fa-list-ul"></i></button>
                        <button class="tb-btn" onmousedown="event.preventDefault(); applyFormat('insertOrderedList')" title="Lista Numérica"><i class="fa-solid fa-list-ol"></i></button>
                        
                        <div class="sep"></div>

                        <!-- Encabezados -->
                        <select class="tb-select" id="headingSelect" title="Formato">
                            <option value="div">Párrafo</option>
                            <option value="h1">Título 1</option>
                            <option value="h2">Título 2</option>
                            <option value="h3">Subtítulo</option>
                            <option value="blockquote">Cita</option>
                        </select>
                        
                        <div class="sep"></div>
                        
                        <!-- Deshacer/Rehacer -->
                        <button class="tb-btn" onmousedown="event.preventDefault(); applyFormat('undo')" title="Deshacer"><i class="fa-solid fa-rotate-left"></i></button>
                        <button class="tb-btn" onmousedown="event.preventDefault(); applyFormat('redo')" title="Rehacer"><i class="fa-solid fa-rotate-right"></i></button>
                        
                        <div class="sep"></div>
                        
                        <!-- Herramientas adicionales -->
                        <button class="tb-btn" onmousedown="event.preventDefault(); insertLink()" title="Insertar Enlace"><i class="fa-solid fa-link"></i></button>
                        <button class="tb-btn" onmousedown="event.preventDefault(); insertImage()" title="Insertar Imagen"><i class="fa-solid fa-image"></i></button>
                        <button class="tb-btn" onmousedown="event.preventDefault(); insertTable()" title="Insertar Tabla"><i class="fa-solid fa-table"></i></button>
                        <button class="tb-btn" onmousedown="event.preventDefault(); insertHR()" title="Línea Horizontal"><i class="fa-solid fa-minus"></i></button>
                    </div>
                    
                    <div style="flex:1; overflow:auto; background:#111; display:flex; justify-content:center;">
                        <div id="paper" contenteditable="true">
                            <h1>Nuevo Documento</h1>
                            <p>Comienza a escribir...</p>
                        </div>
                    </div>
                    <div class="doc-status">
                        <span id="docStats">0 palabras</span>
                        <div class="autosave-indicator" id="autosaveIndicator">
                            <i class="fa-solid fa-cloud"></i> Auto-guardado activo
                        </div>
                    </div>
                </div>`;
            
            const paper = document.getElementById('paper');
            
            // Load saved content
            const savedContent = localStorage.getItem(STORAGE_KEYS.DOCS);
            if (savedContent) {
                paper.innerHTML = savedContent;
            }
            
            paper.addEventListener('input', () => {
                updateDocStats();
                triggerAutoSave();
            });
            
            // Save selection events
            paper.addEventListener('mouseup', saveSelection);
            paper.addEventListener('keyup', saveSelection);
            
            // Font Select
            const fontSelect = document.getElementById('fontSelect');
            fontSelect.addEventListener('mousedown', saveSelection);
            fontSelect.addEventListener('change', function() {
                applyFontToSelection(this.value);
                paper.focus();
            });
            
            // Heading Select
            const headingSelect = document.getElementById('headingSelect');
            headingSelect.addEventListener('mousedown', saveSelection);
            headingSelect.addEventListener('change', function() {
                restoreSelection();
                document.execCommand('formatBlock', false, this.value);
                paper.focus();
                triggerAutoSave();
            });
            
            // Color inputs
            document.getElementById('colorTx').addEventListener('input', function() {
                restoreSelection();
                document.execCommand('foreColor', false, this.value);
                triggerAutoSave();
            });
            
            document.getElementById('colorBg').addEventListener('input', function() {
                restoreSelection();
                document.execCommand('hiliteColor', false, this.value);
                triggerAutoSave();
            });
            
            updateDocStats();
        }
        
        window.clearDoc = function() {
            if (confirm('¿Crear un nuevo documento? Se perderá el contenido actual.')) {
                document.getElementById('paper').innerHTML = '<h1>Nuevo Documento</h1><p>Comienza a escribir...</p>';
                localStorage.removeItem(STORAGE_KEYS.DOCS);
            }
        }

        window.applyFormat = function(cmd, val = null) {
            document.execCommand(cmd, false, val);
            document.getElementById('paper').focus();
            triggerAutoSave();
        }
        
        window.applyFontToSelection = function(fontFamily) {
            restoreSelection();
            
            // Usar execCommand con styleWithCSS para mejor compatibilidad de escritura
            document.execCommand('styleWithCSS', false, true);
            document.execCommand('fontName', false, fontFamily);
            
            // Foco de vuelta al papel
            document.getElementById('paper').focus();
            triggerAutoSave();
        }
        
        window.applySizeToSelection = function(size) {
            restoreSelection();
            const selection = window.getSelection();
            
            if (selection.rangeCount > 0 && !selection.isCollapsed) {
                const range = selection.getRangeAt(0);
                
                // Create wrapper span with size
                const span = document.createElement('span');
                span.style.fontSize = size + 'px';
                
                // Extract and wrap content
                const fragment = range.extractContents();
                span.appendChild(fragment);
                range.insertNode(span);
                
                // Re-select the new content
                range.selectNodeContents(span);
                selection.removeAllRanges();
                selection.addRange(range);
            }
            
            triggerAutoSave();
        }

        // --- Speech to Text for Docs ---
        window._qaxi_recognition = null;
        window._qaxi_recognizing = false;

        window.toggleSpeech = function() {
            if (window._qaxi_recognizing) return stopSpeech();
            startSpeech();
        }

        function startSpeech() {
            const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
            if (!SpeechRecognition) { alert('Tu navegador no soporta reconocimiento por voz. Usa Chrome/Edge/Safari en versiones recientes.'); return; }
            if (!window._qaxi_recognition) {
                window._qaxi_recognition = new SpeechRecognition();
                window._qaxi_recognition.lang = 'es-ES';
                window._qaxi_recognition.interimResults = true;
                window._qaxi_recognition.maxAlternatives = 1;
                let finalTranscript = '';
                // Ensure caret is placed in the doc so recognized text is inserted
                try {
                    const paper = document.getElementById('paper');
                    if (paper) {
                        const sel = window.getSelection();
                        if (!savedSelection || !sel.rangeCount) {
                            const range = document.createRange();
                            range.selectNodeContents(paper);
                            range.collapse(false);
                            sel.removeAllRanges();
                            sel.addRange(range);
                        }
                    }
                } catch (e) { console.warn('Could not position caret for speech:', e); }
                window._qaxi_recognition.onresult = (event) => {
                    let interim = '';
                    for (let i = event.resultIndex; i < event.results.length; ++i) {
                        if (event.results[i].isFinal) {
                            finalTranscript += event.results[i][0].transcript;
                        } else {
                            interim += event.results[i][0].transcript;
                        }
                    }
                        // Insert final transcript at caret (use reliable Range method)
                        const paper = document.getElementById('paper');
                        if (!paper) return;
                        restoreSelection();
                        if (finalTranscript) {
                            window.insertTextAtSelection(finalTranscript + ' ');
                            finalTranscript = '';
                            triggerAutoSave();
                        }
                };
                window._qaxi_recognition.onerror = (e) => { console.error('Speech error', e); };
                window._qaxi_recognition.onend = () => { window._qaxi_recognizing = false; updateSpeechBtn(false); };
            }
            window._qaxi_recognition.start();
            window._qaxi_recognizing = true;
            updateSpeechBtn(true);
        }

        function stopSpeech() {
            if (window._qaxi_recognition) window._qaxi_recognition.stop();
            window._qaxi_recognizing = false;
            updateSpeechBtn(false);
        }

        function updateSpeechBtn(active) {
            const b = document.getElementById('speechBtn');
            if (!b) return;
            if (active) { b.style.background = 'var(--gold)'; b.style.color='black'; b.innerHTML = '<i class="fa-solid fa-microphone-lines"></i> DETENER'; }
            else { b.style.background = ''; b.style.color=''; b.innerHTML = '<i class="fa-solid fa-microphone"></i> VOZ'; }
        }

        window.updateDocStats = () => {
            const paper = document.getElementById('paper');
            if (!paper) return;
            const text = paper.innerText.trim();
            const words = text ? text.split(/\s+/).filter(w => w.length > 0).length : 0;
            document.getElementById('docStats').innerText = `${words} palabras`;
        };
        
        // === HERRAMIENTAS ADICIONALES DE DOCS ===
        
        window.insertLink = function() {
            const url = prompt('Ingresa la URL del enlace:', 'https://');
            if (url && url !== 'https://') {
                const text = prompt('Texto del enlace (dejar vacío para usar la URL):', '');
                const linkText = text || url;
                document.execCommand('insertHTML', false, `<a href="${url}" target="_blank" style="color: #0066cc; text-decoration: underline;">${linkText}</a>`);
                triggerAutoSave();
            }
        };
        
        window.insertImage = function() {
            const url = prompt('Ingresa la URL de la imagen:', 'https://');
            if (url && url !== 'https://') {
                const width = prompt('Ancho de la imagen en píxeles (ej: 300):', '400');
                document.execCommand('insertHTML', false, `<img src="${url}" style="max-width: ${width}px; height: auto; display: block; margin: 10px 0;" alt="Imagen">`);
                triggerAutoSave();
            }
        };
        
        window.insertTable = function() {
            const rows = prompt('Número de filas:', '3');
            const cols = prompt('Número de columnas:', '3');
            
            if (rows && cols) {
                let tableHTML = '<table style="border-collapse: collapse; width: 100%; margin: 15px 0;">';
                
                // Header row
                tableHTML += '<tr>';
                for (let c = 0; c < parseInt(cols); c++) {
                    tableHTML += `<th style="border: 1px solid #ccc; padding: 10px; background: #f5f5f5; font-weight: bold;">Encabezado ${c+1}</th>`;
                }
                tableHTML += '</tr>';
                
                // Data rows
                for (let r = 1; r < parseInt(rows); r++) {
                    tableHTML += '<tr>';
                    for (let c = 0; c < parseInt(cols); c++) {
                        tableHTML += '<td style="border: 1px solid #ccc; padding: 10px;">Celda</td>';
                    }
                    tableHTML += '</tr>';
                }
                tableHTML += '</table>';
                
                document.execCommand('insertHTML', false, tableHTML);
                triggerAutoSave();
            }
        };
        
        window.insertHR = function() {
            document.execCommand('insertHTML', false, '<hr style="border: none; border-top: 2px solid #ccc; margin: 20px 0;">');
            triggerAutoSave();
        };
        
        window.exportDocPdf = () => {
            const el = document.getElementById('paper');
            html2canvas(el, {scale:2}).then(cvs => {
                const pdf = new jspdf.jsPDF('p','mm','a4');
                const w = pdf.internal.pageSize.getWidth();
                pdf.addImage(cvs.toDataURL('image/png'), 'PNG', 0, 0, w, (cvs.height*w)/cvs.width);
                pdf.save('QAXI_Doc.pdf');
            });
        };
        
        // === ESCRITURA MÁGICA (BETA) ===
        window.magicWriting = async function() {
            const selection = window.getSelection();
            const selectedText = selection.toString().trim();
            
            if (!selectedText) {
                alert('Selecciona una palabra o frase para expandir con IA.');
                return;
            }
            
            const range = selection.getRangeAt(0);
            const loadingSpan = document.createElement('span');
            loadingSpan.id = 'magic-loading';
            loadingSpan.style.cssText = 'background: linear-gradient(90deg, #D4AF37, #fff, #D4AF37); background-size: 200%; animation: shimmer 1s infinite; -webkit-background-clip: text; -webkit-text-fill-color: transparent;';
            loadingSpan.textContent = selectedText + '...';
            
            if (!document.getElementById('shimmer-style')) {
                const style = document.createElement('style');
                style.id = 'shimmer-style';
                style.textContent = '@keyframes shimmer { 0% { background-position: -200% 0; } 100% { background-position: 200% 0; } }';
                document.head.appendChild(style);
            }
            
            range.deleteContents();
            range.insertNode(loadingSpan);
            
            try {
                const systemPrompt = "Eres un escritor experto. El usuario te dará una palabra o frase temática. Tu trabajo es expandirla en un párrafo corto (2-3 oraciones máximo) elegante y bien redactado sobre ese tema. NO uses comillas. NO expliques qué estás haciendo. Solo devuelve el texto expandido directamente.";
                
                const response = await fetch("https://api.groq.com/openai/v1/chat/completions", {
                    method: "POST",
                    headers: { "Content-Type": "application/json", "Authorization": `Bearer ${GROQ_KEY}` },
                    body: JSON.stringify({
                        messages: [
                            { role: "system", content: systemPrompt },
                            { role: "user", content: `Expande esto: "${selectedText}"` }
                        ],
                        model: "llama-3.3-70b-versatile",
                        temperature: 0.8,
                        max_tokens: 200
                    })
                });
                
                if (!response.ok) throw new Error("Error API");
                const data = await response.json();
                const expandedText = data.choices[0].message.content.trim();
                
                loadingSpan.style.cssText = '';
                loadingSpan.style.color = '#000';
                loadingSpan.textContent = expandedText;
                loadingSpan.removeAttribute('id');
                
                triggerAutoSave();
                
            } catch (e) {
                console.error(e);
                loadingSpan.textContent = selectedText;
                loadingSpan.style.cssText = '';
                alert('Error al generar texto. Intenta de nuevo.');
            }
        }

        // === PDF ===
        function loadPDF(c, t) {
            c.innerHTML = `<div class="pdf-zone">
                <i class="fa-solid fa-file-pdf" style="font-size:3rem; margin-bottom:10px; color:var(--text)"></i>
                <h3 style="letter-spacing:1px; margin-bottom:20px;">PDF CONVERTER</h3>
                
                <div class="pdf-opts" style="display:flex; gap:10px; margin-bottom:20px;">
                    <button class="nav-btn" onclick="document.getElementById('imgInput').click()" style="padding:10px 20px; font-size:0.9rem; border-color:var(--text);">
                        <i class="fa-solid fa-plus"></i> AGREGAR IMÁGENES
                    </button>
                    <button class="nav-btn" onclick="imgsToPdf()" style="padding:10px 20px; font-size:0.9rem; border-color:var(--gold); color:var(--gold);">
                        CREAR PDF
                    </button>
                </div>
                
                <input type="file" id="imgInput" multiple accept="image/*" style="display:none">
                <div id="pdfList" class="pdf-list"></div>
                <p style="color:#555; font-size:0.8rem; margin-top:20px;">Soporta JPG, PNG.</p>
            </div>`;
            const input = document.getElementById('imgInput');
            input.addEventListener('change', () => {
                Array.from(input.files).forEach(file => {
                    const reader = new FileReader();
                    reader.onload = () => { pdfImages.push({ name: file.name, data: reader.result }); renderPdfList(); };
                    reader.readAsDataURL(file);
                });
            });
        }
        function renderPdfList() {
            const list = document.getElementById('pdfList');
            list.innerHTML = "";
            pdfImages.forEach((img, idx) => {
                const div = document.createElement("div");
                div.className = "pdf-item";
                div.innerHTML = `<div class="del" onclick="removePdf(${idx})">x</div>
                                 <img src="${img.data}" style="width:100%; height:100%; object-fit:cover; border-radius:4px;">`;
                list.appendChild(div);
            });
        }
        window.removePdf = (idx) => { pdfImages.splice(idx, 1); renderPdfList(); };
        window.imgsToPdf = () => {
            if(!pdfImages.length) return alert("Agrega imágenes.");
            const pdf = new jspdf.jsPDF();
            const w = pdf.internal.pageSize.getWidth();
            const h = pdf.internal.pageSize.getHeight();
            pdfImages.forEach((img, i) => {
                if(i > 0) pdf.addPage();
                pdf.addImage(img.data, 'JPEG', 0, 0, w, h);
            });
            pdf.save("QAXI_Images.pdf");
        };

        // ========================================
        // === PRESENTATIONS QAXI (CON AUTOGUARDADO) ===
        // ========================================
        
        function loadSlides(c, t) {
            t.innerHTML = `
                <button class="nav-btn" onclick="addSlide()">+ SLIDE</button>
                <button class="nav-btn" onclick="addSlideText()">+ TEXTO</button>
                <button class="nav-btn" onclick="addSlideTitle()">+ TÍTULO</button>
                <button class="nav-btn" onclick="document.getElementById('slideImgInput').click()">+ IMAGEN</button>
                <input type="file" id="slideImgInput" accept="image/*" style="display:none" onchange="addSlideImage(this)">
                <div class="sep"></div>
                <input type="color" id="bgColorPicker" onchange="changeSlideBg(this.value)" value="#ffffff" title="Color de Fondo">
                <div class="sep"></div>
                <button class="nav-btn" onclick="deleteSelectedElement()" style="border-color:#ff4444; color:#ff4444;">ELIMINAR ELEMENTO</button>
                <button class="nav-btn" onclick="deleteSlide()" style="background:transparent;border-color:#6b1616;color:#ff9b9b;">ELIMINAR SLIDE</button>
                <div class="sep"></div>
                <button class="nav-btn" onclick="exportSlides()" style="border-color:var(--gold); color:var(--gold)">EXPORTAR PDF</button>
            `;

            c.innerHTML = `
                <div class="slides-layout">
                    <div class="slides-sidebar" id="slideThumbs"></div>
                    <div class="slides-main" id="slidesMain">
                        <div id="activeSlideCanvas" class="slide-canvas"></div>
                    </div>
                </div>
            `;
            
            // Try to load saved slides
            const savedSlides = localStorage.getItem(STORAGE_KEYS.SLIDES);
            if (savedSlides) {
                try {
                    slides = JSON.parse(savedSlides);
                } catch(e) {
                    slides = [{ 
                        id: 1, 
                        elements: [
                            { id: 1, type: 'title', content: 'Título de la Presentación', x: 50, y: 50, width: 700, height: 60, fontSize: 36, fontFamily: 'Cinzel' },
                            { id: 2, type: 'text', content: 'Haz clic para editar...', x: 50, y: 150, width: 600, height: 40, fontSize: 18, fontFamily: 'Segoe UI' }
                        ], 
                        bg: '#ffffff' 
                    }];
                }
            } else {
                slides = [{ 
                    id: 1, 
                    elements: [
                        { id: 1, type: 'title', content: 'Título de la Presentación', x: 50, y: 50, width: 700, height: 60, fontSize: 36, fontFamily: 'Cinzel' },
                        { id: 2, type: 'text', content: 'Haz clic para editar...', x: 50, y: 150, width: 600, height: 40, fontSize: 18, fontFamily: 'Segoe UI' }
                    ], 
                    bg: '#ffffff' 
                }];
            }
            
            currentSlideIdx = 0;
            selectedElement = null;
            
            renderCurrentSlide();
            renderThumbs();
            
            document.getElementById('activeSlideCanvas').addEventListener('click', (e) => {
                if (e.target.id === 'activeSlideCanvas') {
                    deselectAll();
                }
            });
        }
        
        function saveSlides() {
            localStorage.setItem(STORAGE_KEYS.SLIDES, JSON.stringify(slides));
            // Also trigger the visual autosave indicator / centralized autosave
            try { triggerAutoSave(); } catch(e){}
        }
        
        function renderCurrentSlide() {
            const canvas = document.getElementById('activeSlideCanvas');
            if (!canvas) return;
            
            const slide = slides[currentSlideIdx];
            canvas.style.backgroundColor = slide.bg;
            canvas.innerHTML = '';
            
            slide.elements.forEach(el => {
                const elem = createSlideElement(el);
                canvas.appendChild(elem);
            });
        }
        
        function createSlideElement(elData) {
            const wrapper = document.createElement('div');
            wrapper.className = 'slide-element';
            wrapper.dataset.id = elData.id;
            wrapper.style.left = elData.x + 'px';
            wrapper.style.top = elData.y + 'px';
            wrapper.style.width = elData.width + 'px';
            wrapper.style.minHeight = elData.height + 'px';
            
            if (elData.type === 'image') {
                const img = document.createElement('img');
                img.src = elData.src;
                img.draggable = false;
                wrapper.appendChild(img);
            } else {
                const textEl = document.createElement('div');
                textEl.contentEditable = true;
                textEl.innerHTML = elData.content;
                textEl.style.fontSize = elData.fontSize + 'px';
                textEl.style.fontFamily = elData.fontFamily;
                textEl.style.width = '100%';
                textEl.style.minHeight = '100%';
                textEl.style.outline = 'none';
                
                if (elData.type === 'title') {
                    textEl.style.fontWeight = 'bold';
                }
                
                textEl.addEventListener('input', () => {
                    const slide = slides[currentSlideIdx];
                    const elem = slide.elements.find(e => e.id == elData.id);
                    if (elem) elem.content = textEl.innerHTML;
                    saveSlides();
                });
                
                textEl.addEventListener('focus', () => {
                    wrapper.classList.add('editing');
                });
                
                textEl.addEventListener('blur', () => {
                    wrapper.classList.remove('editing');
                });
                
                wrapper.appendChild(textEl);
            }
            
            const resizeHandle = document.createElement('div');
            resizeHandle.className = 'resize-handle';
            resizeHandle.style.display = 'none';
            wrapper.appendChild(resizeHandle);
            
            wrapper.addEventListener('mousedown', (e) => {
                if (e.target === resizeHandle) {
                    startResize(e, wrapper, elData);
                    return;
                }
                selectElement(wrapper, elData);
                if (!wrapper.classList.contains('editing')) {
                    startDrag(e, wrapper, elData);
                }
            });
            
            return wrapper;
        }
        
        function selectElement(wrapper, elData) {
            deselectAll();
            wrapper.classList.add('selected');
            wrapper.querySelector('.resize-handle').style.display = 'block';
            selectedElement = { wrapper, data: elData };
        }
        
        function deselectAll() {
            document.querySelectorAll('.slide-element.selected').forEach(el => {
                el.classList.remove('selected');
                const handle = el.querySelector('.resize-handle');
                if (handle) handle.style.display = 'none';
            });
            selectedElement = null;
        }
        
        function startDrag(e, wrapper, elData) {
            if (wrapper.classList.contains('editing')) return;
            
            isDragging = true;
            const rect = wrapper.getBoundingClientRect();
            dragOffset.x = e.clientX - rect.left;
            dragOffset.y = e.clientY - rect.top;
            
            const onMouseMove = (e) => {
                if (!isDragging) return;
                
                const canvas = document.getElementById('activeSlideCanvas');
                const canvasRect = canvas.getBoundingClientRect();
                
                let newX = e.clientX - canvasRect.left - dragOffset.x;
                let newY = e.clientY - canvasRect.top - dragOffset.y;
                
                newX = Math.max(0, Math.min(newX, canvas.offsetWidth - wrapper.offsetWidth));
                newY = Math.max(0, Math.min(newY, canvas.offsetHeight - wrapper.offsetHeight));
                
                wrapper.style.left = newX + 'px';
                wrapper.style.top = newY + 'px';
                
                elData.x = newX;
                elData.y = newY;
            };
            
            const onMouseUp = () => {
                isDragging = false;
                document.removeEventListener('mousemove', onMouseMove);
                document.removeEventListener('mouseup', onMouseUp);
                saveSlides();
            };
            
            document.addEventListener('mousemove', onMouseMove);
            document.addEventListener('mouseup', onMouseUp);
        }
        
        function startResize(e, wrapper, elData) {
            e.preventDefault();
            e.stopPropagation();
            isResizing = true;
            
            const startX = e.clientX;
            const startY = e.clientY;
            const startWidth = wrapper.offsetWidth;
            const startHeight = wrapper.offsetHeight;
            
            const onMouseMove = (e) => {
                if (!isResizing) return;
                
                const newWidth = Math.max(50, startWidth + (e.clientX - startX));
                const newHeight = Math.max(20, startHeight + (e.clientY - startY));
                
                wrapper.style.width = newWidth + 'px';
                wrapper.style.minHeight = newHeight + 'px';
                
                elData.width = newWidth;
                elData.height = newHeight;
            };
            
            const onMouseUp = () => {
                isResizing = false;
                document.removeEventListener('mousemove', onMouseMove);
                document.removeEventListener('mouseup', onMouseUp);
                saveSlides();
            };
            
            document.addEventListener('mousemove', onMouseMove);
            document.addEventListener('mouseup', onMouseUp);
        }

        window.renderThumbs = function() {
            const cont = document.getElementById('slideThumbs');
            if (!cont) return;
            cont.innerHTML = '';
            slides.forEach((s, i) => {
                const div = document.createElement('div');
                div.className = `slide-thumb ${i === currentSlideIdx ? 'active' : ''}`;
                div.style.backgroundColor = s.bg;
                div.onclick = () => switchSlide(i);
                div.innerHTML = `<span>${i+1}</span>`;
                cont.appendChild(div);
            });
        }

        window.switchSlide = function(idx) {
            currentSlideIdx = idx;
            selectedElement = null;
            renderCurrentSlide();
            renderThumbs();
        }

        window.addSlide = function() {
            slides.push({ 
                id: Date.now(), 
                elements: [
                    { id: Date.now(), type: 'title', content: 'Nueva Diapositiva', x: 50, y: 50, width: 700, height: 60, fontSize: 36, fontFamily: 'Cinzel' }
                ], 
                bg: '#ffffff' 
            });
            switchSlide(slides.length - 1);
            saveSlides();
        }

        window.changeSlideBg = function(color) {
            slides[currentSlideIdx].bg = color;
            document.getElementById('activeSlideCanvas').style.backgroundColor = color;
            renderThumbs();
            saveSlides();
        }

        window.addSlideText = function() {
            const newEl = {
                id: Date.now(),
                type: 'text',
                content: 'Texto nuevo',
                x: 100,
                y: 200,
                width: 300,
                height: 30,
                fontSize: 18,
                fontFamily: 'Segoe UI'
            };
            slides[currentSlideIdx].elements.push(newEl);
            renderCurrentSlide();
            saveSlides();
        }
        
        window.addSlideTitle = function() {
            const newEl = {
                id: Date.now(),
                type: 'title',
                content: 'Título',
                x: 50,
                y: 50,
                width: 700,
                height: 50,
                fontSize: 32,
                fontFamily: 'Cinzel'
            };
            slides[currentSlideIdx].elements.push(newEl);
            renderCurrentSlide();
            saveSlides();
        }
        
        window.addSlideImage = function(input) {
            if (!input.files || !input.files[0]) return;
            
            const reader = new FileReader();
            reader.onload = (e) => {
                const newEl = {
                    id: Date.now(),
                    type: 'image',
                    src: e.target.result,
                    x: 100,
                    y: 100,
                    width: 300,
                    height: 200
                };
                slides[currentSlideIdx].elements.push(newEl);
                renderCurrentSlide();
                saveSlides();
            };
            reader.readAsDataURL(input.files[0]);
            input.value = '';
        }
        
        window.deleteSelectedElement = function() {
            if (!selectedElement) {
                alert('Selecciona un elemento para eliminar.');
                return;
            }
            
            const slide = slides[currentSlideIdx];
            slide.elements = slide.elements.filter(el => el.id != selectedElement.data.id);
            selectedElement = null;
            renderCurrentSlide();
            saveSlides();
        }

        window.deleteSlide = function() {
            if (!confirm('¿Confirmas eliminar la diapositiva actual? Esta acción no se puede deshacer.')) return;
            slides.splice(currentSlideIdx, 1);
            if (slides.length === 0) {
                slides = [{ id: Date.now(), elements: [], bg: '#ffffff' }];
            }
            if (currentSlideIdx >= slides.length) currentSlideIdx = slides.length - 1;
            renderCurrentSlide();
            renderThumbs();
            saveSlides();
        }

        window.exportSlides = async function() {
            const pdf = new jspdf.jsPDF('l', 'mm', 'a4');
            const w = pdf.internal.pageSize.getWidth();
            const h = pdf.internal.pageSize.getHeight();
            const canvas = document.getElementById('activeSlideCanvas');
            const originalIdx = currentSlideIdx;
            
            deselectAll();

            for (let i = 0; i < slides.length; i++) {
                if (i > 0) pdf.addPage();
                switchSlide(i);
                await new Promise(resolve => setTimeout(resolve, 100));
                await html2canvas(canvas, { scale: 2, useCORS: true }).then(cvs => {
                    pdf.addImage(cvs.toDataURL('image/jpeg', 0.9), 'JPEG', 0, 0, w, h);
                });
            }
            
            switchSlide(originalIdx);
            pdf.save('QAXI_Presentation.pdf');
        }

        // === SHEETS ===
        function loadSheets(c, t) {
            t.innerHTML = `<div style="display:flex; align-items:center; gap:8px;">
                                                <div id="sheetTabs" style="display:flex; gap:6px;"></div>
                                                <button class="nav-btn" onclick="newWorkbook()" style="border-color:var(--gold); color:var(--gold)">NUEVO LIBRO</button>
                                                <button class="nav-btn" onclick="addSheet()">+ NUEVA HOJA</button>
                                                <button class="nav-btn" onclick="deleteCurrentSheet()" style="background:transparent;border-color:#6b1616;color:#ff9b9b;">BORRAR HOJA</button>
                                                <button class="nav-btn" onclick="addR()">AGREGAR FILA</button>
                                                <button class="nav-btn" onclick="addC()">AGREGAR COLUMNA</button>
                                <button class="nav-btn" onclick="exportCSV()">CSV</button>
                                <button class="nav-btn" onclick="exportSheetsPdf()">EXPORTAR A PDF</button>
                            </div>`;

            // initialize workbook if not present
            if (!window.sheetsWorkbook) {
                const wb = localStorage.getItem(STORAGE_KEYS.SHEETS_BOOK);
                if (wb) {
                    try { window.sheetsWorkbook = JSON.parse(wb); } catch(e) { window.sheetsWorkbook = null; }
                }
            }
            if (!window.sheetsWorkbook) {
                // try older single-sheet storage
                const saved = localStorage.getItem(STORAGE_KEYS.SHEETS);
                let values = [];
                if (saved) {
                    try { const obj = JSON.parse(saved); values = obj.values || []; } catch(e){}
                }
                window.sheetsWorkbook = [{ name: 'Hoja 1', rows: sheetRows, cols: sheetCols, values }];
                activeSheetIdx = 0;
            }

            // ensure active index exists
            if (activeSheetIdx == null || activeSheetIdx >= window.sheetsWorkbook.length) activeSheetIdx = 0;

            // render tabs and grid for active sheet
            renderSheetTabs();
            const active = window.sheetsWorkbook[activeSheetIdx];
            sheetRows = active.rows || sheetRows;
            sheetCols = active.cols || sheetCols;
            c.innerHTML = buildGrid(sheetRows, sheetCols);

            // Load saved sheet values if any
            try {
                const saved = localStorage.getItem(STORAGE_KEYS.SHEETS);
                if (saved) {
                    const obj = JSON.parse(saved);
                    if (obj.rows) sheetRows = obj.rows;
                    if (obj.cols) sheetCols = obj.cols;
                    // rebuild if sizes changed
                    if (obj.rows !== undefined || obj.cols !== undefined) {
                        c.innerHTML = buildGrid(sheetRows, sheetCols);
                    }
                    if (obj.values && obj.values.length) {
                        const inputs = document.querySelectorAll('#mainGrid tbody tr');
                        obj.values.forEach((r, ri) => {
                            const tr = inputs[ri];
                            if (!tr) return;
                            const tinputs = tr.querySelectorAll('td input');
                            r.forEach((val, ci) => {
                                if (tinputs[ci]) tinputs[ci].value = val;
                            });
                        });
                    }
                }
            } catch(e) { console.warn('Error loading sheets', e); }

            // Attach autosave hooks to inputs
            const grid = document.getElementById('mainGrid');
            if (grid) {
                grid.querySelectorAll('td input').forEach(inp => {
                    inp.addEventListener('input', () => {
                        // simple calc handling is still on change; provide immediate autosave
                        triggerAutoSave();
                    });
                    // keep onchange calc behavior
                    inp.addEventListener('change', () => { doCalc(inp); triggerAutoSave(); });
                });
                // fill values from workbook if available
                const active = window.sheetsWorkbook[activeSheetIdx];
                if (active && active.values && active.values.length) {
                    const rows = document.querySelectorAll('#mainGrid tbody tr');
                    active.values.forEach((r, ri) => {
                        const tr = rows[ri]; if (!tr) return;
                        const tinputs = tr.querySelectorAll('td input');
                        r.forEach((val, ci) => { if (tinputs[ci]) tinputs[ci].value = val; });
                    });
                }
            }
        }

        function renderSheetTabs() {
            const cont = document.getElementById('sheetTabs');
            if (!cont) return;
            cont.innerHTML = '';
            window.sheetsWorkbook.forEach((s, i) => {
                const btn = document.createElement('button');
                btn.className = 'nav-btn';
                btn.innerText = s.name || `Hoja ${i+1}`;
                btn.style.border = i === activeSheetIdx ? '2px solid var(--gold)' : '';
                btn.onclick = () => { switchSheet(i); };
                cont.appendChild(btn);
            });
        }

        function addSheet() {
            try { autoSaveAll(); } catch(e){}
            const name = `Hoja ${window.sheetsWorkbook.length+1}`;
            window.sheetsWorkbook.push({ name, rows: 20, cols: 10, values: [] });
            activeSheetIdx = window.sheetsWorkbook.length - 1;
            localStorage.setItem(STORAGE_KEYS.SHEETS_BOOK, JSON.stringify(window.sheetsWorkbook));
            loadSheets(document.getElementById('wsContent'), document.getElementById('appTools'));
            try { triggerAutoSave(); } catch(e){}
        }

        function switchSheet(idx) {
            // before switching, save current grid values
            try { autoSaveAll(); } catch(e){}
            activeSheetIdx = idx;
            loadSheets(document.getElementById('wsContent'), document.getElementById('appTools'));
        }

        function deleteCurrentSheet() {
            if (!window.sheetsWorkbook || window.sheetsWorkbook.length <= 1) {
                alert('No puedes borrar la única hoja.');
                return;
            }
            try { autoSaveAll(); } catch(e){}
            const name = window.sheetsWorkbook[activeSheetIdx].name || `Hoja ${activeSheetIdx+1}`;
            if (!confirm(`¿Confirmas borrar la hoja "${name}"? Esta acción no se puede deshacer.`)) return;
            window.sheetsWorkbook.splice(activeSheetIdx, 1);
            if (activeSheetIdx >= window.sheetsWorkbook.length) activeSheetIdx = window.sheetsWorkbook.length - 1;
            localStorage.setItem(STORAGE_KEYS.SHEETS_BOOK, JSON.stringify(window.sheetsWorkbook));
            loadSheets(document.getElementById('wsContent'), document.getElementById('appTools'));
            try { triggerAutoSave(); } catch(e){}
        }

        function newWorkbook() {
            try { autoSaveAll(); } catch(e){}
            if (!confirm('¿Crear un nuevo libro de cálculo? Se reemplazarán las hojas actuales.')) return;
            window.sheetsWorkbook = [{ name: 'Hoja 1', rows: 20, cols: 10, values: [] }];
            activeSheetIdx = 0;
            sheetRows = 20; sheetCols = 10;
            localStorage.setItem(STORAGE_KEYS.SHEETS_BOOK, JSON.stringify(window.sheetsWorkbook));
            loadSheets(document.getElementById('wsContent'), document.getElementById('appTools'));
            try { triggerAutoSave(); } catch(e){}
        }
        function buildGrid(rows, cols) {
            let h = `<div class="grid-container"><table class="grid" id="mainGrid"><thead><tr id="hRow"><th></th>`;
            for(let i=0; i<cols; i++) h += `<th>${String.fromCharCode(65+i)}</th>`;
            h += `</tr></thead><tbody>`;
            for(let r=1; r<=rows; r++) {
                h += `<tr><th style="background:#1f1f1f;">${r}</th>`;
                for(let col=0; col<cols; col++) h += `<td><input onchange="doCalc(this)"></td>`;
                h += `</tr>`;
            }
            return h + `</tbody></table></div>`;
        }
        window.doCalc = (el) => {
            if(el.value.startsWith('=')) { try { el.value = math.evaluate(el.value.substring(1)); el.style.color='var(--gold)'; } catch(e){}}
        };
        window.addR = () => {
            try { autoSaveAll(); } catch(e){}
            // update active workbook and persist
            sheetRows++;
            if (window.sheetsWorkbook && window.sheetsWorkbook[activeSheetIdx]) {
                window.sheetsWorkbook[activeSheetIdx].rows = sheetRows;
                // ensure values array has rows
                window.sheetsWorkbook[activeSheetIdx].values = window.sheetsWorkbook[activeSheetIdx].values || [];
            }
            localStorage.setItem(STORAGE_KEYS.SHEETS_BOOK, JSON.stringify(window.sheetsWorkbook));
            loadSheets(document.getElementById('wsContent'), document.getElementById('appTools'));
            try { triggerAutoSave(); } catch(e){}
        };
        window.addC = () => {
            try { autoSaveAll(); } catch(e){}
            sheetCols++;
            if (window.sheetsWorkbook && window.sheetsWorkbook[activeSheetIdx]) {
                window.sheetsWorkbook[activeSheetIdx].cols = sheetCols;
                window.sheetsWorkbook[activeSheetIdx].values = window.sheetsWorkbook[activeSheetIdx].values || [];
            }
            localStorage.setItem(STORAGE_KEYS.SHEETS_BOOK, JSON.stringify(window.sheetsWorkbook));
            loadSheets(document.getElementById('wsContent'), document.getElementById('appTools'));
            try { triggerAutoSave(); } catch(e){}
        };
        window.exportCSV = () => alert("Exportando CSV...");

        window.exportSheetsPdf = async function() {
            const grid = document.getElementById('mainGrid');
            if (!grid) { alert('No hay hoja para exportar'); return; }

            // Clone table and replace inputs with their text values for rendering
            const clone = grid.cloneNode(true);
            clone.style.width = '100%';
            clone.querySelectorAll('input').forEach(inp => {
                const span = document.createElement('span');
                span.textContent = inp.value || '';
                span.style.display = 'inline-block';
                span.style.padding = '4px 6px';
                inp.parentNode.replaceChild(span, inp);
            });

            const container = document.createElement('div');
            container.style.position = 'fixed';
            container.style.left = '-9999px';
            container.style.background = 'white';
            container.style.padding = '20px';
            container.appendChild(clone);
            document.body.appendChild(container);

            try {
                const cvs = await html2canvas(container, { scale: 2, useCORS: true });
                const pdf = new jspdf.jsPDF('p', 'pt', [cvs.width, cvs.height]);
                pdf.addImage(cvs.toDataURL('image/png'), 'PNG', 0, 0, cvs.width, cvs.height);
                pdf.save('QAXI_Sheet.pdf');
            } catch (e) {
                console.error(e);
                alert('Error al exportar a PDF');
            } finally {
                container.remove();
            }
        };


        // === QAXI AI ===
        function loadAI(c, t) {
            // Limpiar historial al cargar la app
            aiChatHistory = [];

            c.innerHTML = `
                <div class="ai-box" style="display:flex; flex-direction:column; height:100%;">
                    <div class="chat-window" id="aiChat" style="flex:1; overflow:auto; padding:12px;"></div>
                    <div class="ai-input-wrap">
                        <div class="ai-input-pill">
                            <input type="text" id="aiInput" placeholder="Pregunta o comando..." onkeydown="if(event.key === 'Enter') askQaxiAI()">
                            <button class="ai-send-btn" onclick="askQaxiAI()" title="Enviar"><i class="fa-solid fa-paper-plane"></i></button>
                        </div>
                    </div>
                </div>
            `;
            
            
        }
        
        // === FUNCIÓN DE BÚSQUEDA WEB ===
        async function searchWeb(query) {
            try {
                // Usar DuckDuckGo Instant Answer API (gratuita)
                const searchUrl = `https://api.duckduckgo.com/?q=${encodeURIComponent(query)}&format=json&no_html=1&skip_disambig=1`;
                
                const response = await fetch(searchUrl);
                const data = await response.json();
                
                let results = [];
                
                // Abstract (respuesta principal)
                if (data.Abstract) {
                    results.push({
                        title: data.Heading || 'Resultado',
                        snippet: data.Abstract,
                        source: data.AbstractSource || 'DuckDuckGo'
                    });
                }
                
                // Respuesta instantánea
                if (data.Answer) {
                    results.push({
                        title: 'Respuesta Directa',
                        snippet: data.Answer,
                        source: 'DuckDuckGo'
                    });
                }
                
                // Temas relacionados
                if (data.RelatedTopics && data.RelatedTopics.length > 0) {
                    data.RelatedTopics.slice(0, 5).forEach(topic => {
                        if (topic.Text) {
                            results.push({
                                title: topic.FirstURL ? topic.FirstURL.split('/').pop().replace(/_/g, ' ') : 'Info',
                                snippet: topic.Text,
                                source: 'Wikipedia'
                            });
                        }
                    });
                }
                
                return results;
            } catch (e) {
                console.error('Error en búsqueda:', e);
                return [];
            }
        }
        
        // Detectar si la pregunta necesita búsqueda web
        function needsWebSearch(prompt) {
            const searchKeywords = [
                'busca', 'buscar', 'búsqueda', 'investiga', 'googlea', 'google',
                'qué es', 'quien es', 'quién es', 'qué son', 'donde queda', 'dónde queda',
                'última noticia', 'últimas noticias', 'actualidad', 'reciente',
                'precio de', 'cotización', 'clima en', 'tiempo en',
                'cómo está', 'como esta', 'qué pasó', 'que paso',
                'información sobre', 'info sobre', 'datos de', 'datos sobre',
                'define', 'definición', 'significado de',
                'en internet', 'en la web', 'online'
            ];
            
            const lowerPrompt = prompt.toLowerCase();
            return searchKeywords.some(kw => lowerPrompt.includes(kw));
        }

        window.askQaxiAI = async function() {
            const input = document.getElementById('aiInput');
            const chat = document.getElementById('aiChat');
            const prompt = input.value.trim();
            if(!prompt) return;

            const uDiv = document.createElement('div'); uDiv.className = 'msg user'; uDiv.innerText = prompt;
            chat.appendChild(uDiv); input.value = ''; chat.scrollTop = chat.scrollHeight;

            const lDiv = document.createElement('div'); lDiv.className = 'msg ai'; lDiv.id = 'ai-loader';
            lDiv.innerHTML = `<div class="ai-response">Pensando...</div>`; chat.appendChild(lDiv); chat.scrollTop = chat.scrollHeight;

            // Agregar mensaje del usuario al historial
            aiChatHistory.push({ role: "user", content: prompt });
            
            // Limitar historial para no exceder tokens
            if (aiChatHistory.length > MAX_HISTORY) {
                aiChatHistory = aiChatHistory.slice(-MAX_HISTORY);
            }

            try {
                // Verificar si necesita búsqueda web
                let webContext = '';
                if (needsWebSearch(prompt)) {
                    document.getElementById('ai-loader').innerHTML = `<div class="ai-response">🔍 Buscando en la web...</div>`;
                    
                    const searchResults = await searchWeb(prompt);
                    
                    if (searchResults.length > 0) {
                        webContext = '\n\n## INFORMACIÓN DE LA WEB (Búsqueda reciente):\n';
                        searchResults.forEach((r, i) => {
                            webContext += `\n**${i+1}. ${r.title}** (${r.source}):\n${r.snippet}\n`;
                        });
                        webContext += '\n---\nUsa esta información para responder de forma precisa y actualizada.\n';
                    }
                    
                    document.getElementById('ai-loader').innerHTML = `<div class="ai-response">Analizando resultados...</div>`;
                }
                
                // Obtener fecha actual formateada
                const now = new Date();
                const fechaActual = now.toLocaleDateString('es-ES', { 
                    weekday: 'long', 
                    year: 'numeric', 
                    month: 'long', 
                    day: 'numeric',
                    hour: '2-digit',
                    minute: '2-digit'
                });
                
                // Attachments disabled: keep empty context
                let attachContext = '';

                const systemPrompt = `Eres QAXI AI, el asistente integrado en QAXI Cloud.
Responde siempre de forma breve, elegante y útil. Empieza con un resumen de 1-2 líneas, seguido de hasta 3 viñetas con puntos clave.
Si la respuesta requiere más detalle, proporciona el resumen y ofrece extenderla (el cliente usa un botón "Ver más").
Cuando uses búsquedas web o adjuntos, menciónalo brevemente.
Fecha: ${fechaActual}
${attachContext}
${webContext}`;

                // Construir mensajes con historial
                const messages = [
                    { role: "system", content: systemPrompt },
                    ...aiChatHistory
                ];

                if(!GROQ_KEY) {
                    // Show friendly message in chat if no API key configured
                    document.getElementById('ai-loader').remove();
                    const warn = document.createElement('div'); warn.className = 'msg ai';
                    warn.innerHTML = `<div class="ai-response"><span style="color:#ffcc66;">QAXI AI no está configurado. Ejecuta window.setGroqKey('<tu_api_key>') en la consola.</span></div>`;
                    chat.appendChild(warn); chat.scrollTop = chat.scrollHeight;
                    return;
                }

                const response = await fetch("https://api.groq.com/openai/v1/chat/completions", {
                    method: "POST",
                    headers: { "Content-Type": "application/json", "Authorization": `Bearer ${GROQ_KEY}` },
                    body: JSON.stringify({
                        messages: messages,
                        model: "llama-3.3-70b-versatile",
                        temperature: 0.7,
                        max_tokens: 2048,
                        top_p: 0.9
                    })
                });

                if(!response.ok) {
                    const errorData = await response.json().catch(() => ({}));
                    throw new Error(errorData.error?.message || "Error de conexión");
                }

                const data = await response.json();
                const aiResponse = data.choices[0].message.content;
                
                // Agregar respuesta al historial
                aiChatHistory.push({ role: "assistant", content: aiResponse });
                
                document.getElementById('ai-loader').remove();

                const rDiv = document.createElement('div'); rDiv.className = 'msg ai';
                // Build a short preview and a full view, with toggle
                let shortText = (aiResponse || '').split(/\n\n/)[0] || aiResponse || '';
                if (shortText.length > 350) shortText = shortText.slice(0,350) + '...';
                const shortHtml = marked.parse(shortText);
                const fullHtml = marked.parse(aiResponse || '');
                rDiv.innerHTML = `
                    <div class="ai-sender">QAXI AI</div>
                    <div class="ai-response-short">${shortHtml}</div>
                    <div class="ai-response-full" style="display:none">${fullHtml}</div>
                    <div style="text-align:center; margin-top:8px;">
                        <button class="nav-btn" onclick="toggleAiExpand(this)">Ver más</button>
                    </div>
                `;
                chat.appendChild(rDiv); chat.scrollTop = chat.scrollHeight;

            } catch(e) { 
                console.error(e);
                // Remover el último mensaje del usuario del historial si falló
                aiChatHistory.pop();
                const loader = document.getElementById('ai-loader');
                if (loader) {
                    loader.innerHTML = `<strong>QAXI AI</strong><p>⚠️ ${e.message || 'Error al conectar. Intenta de nuevo.'}</p>`;
                }
            }
        };

        // ========================================
        // === QAXI SEARCH APP ===
        // ========================================
                // === QAXI LIVE (REUNIONES) ===
                
        function loadSearch(c, t) {
            c.innerHTML = `
                <div class="search-container" style="display:flex; flex-direction:column; width:100%; height:100%; padding:20px; overflow-y:auto; align-items: center;">
                    <div id="searchHero" style="display:flex; flex-direction:column; align-items:center; justify-content:center; flex:1; transition:0.3s; width: 100%; max-width: 800px;">
                        <h1 style="font-family:var(--font-brand); font-size:4rem; color:var(--text); margin-bottom:30px; letter-spacing: 2px;">
                            <span style="color:var(--gold); text-shadow: 0 0 20px var(--gold-glow);">QAXI</span> SEARCH
                        </h1>
                        <div style="position:relative; width:100%; max-width:650px;">
                            <input type="text" id="searchInput" placeholder="¿Qué quieres descubrir hoy?" 
                                style="width:100%; padding:20px 55px 20px 25px; background:rgba(20,20,20,0.8); border:1px solid #444; 
                                border-radius:50px; color:white; font-size:1.2rem; box-shadow: 0 10px 40px rgba(0,0,0,0.4); outline:none; transition: all 0.3s ease;"
                                onfocus="this.style.borderColor='var(--gold)'; this.style.boxShadow='0 10px 40px rgba(212,175,55,0.1)';"
                                onblur="this.style.borderColor='#444'; this.style.boxShadow='0 10px 40px rgba(0,0,0,0.4)';"
                                onkeydown="if(event.key === 'Enter') performQaxiSearch()">
                            <button onclick="performQaxiSearch()" style="position:absolute; right:15px; top:50%; transform:translateY(-50%); 
                                background:none; border:none; color:var(--gold); font-size:1.4rem; cursor:pointer; transition: 0.2s;"
                                onmouseover="this.style.transform='translateY(-50%) scale(1.1)'; this.style.textShadow='0 0 10px var(--gold)'"
                                onmouseout="this.style.transform='translateY(-50%) scale(1)'; this.style.textShadow='none'">
                                <i class="fa-solid fa-magnifying-glass"></i>
                            </button>
                        </div>
                        <div style="margin-top:25px; font-size:0.9rem; color:#666; display: flex; gap: 10px; align-items: center;">
                            <span>Potenciado por</span>
                            <span style="background: rgba(255,255,255,0.1); padding: 4px 10px; border-radius: 12px; color: #aaa; display: flex; align-items: center; gap: 5px;">
                                <i class="fa-brands fa-google"></i> Google
                            </span>
                            <span>&</span>
                            <span style="background: rgba(212,175,55,0.1); padding: 4px 10px; border-radius: 12px; color: var(--gold); display: flex; align-items: center; gap: 5px;">
                                <i class="fa-solid fa-brain"></i> QAXI AI
                            </span>
                        </div>
                    </div>
                    
                    <div id="searchResults" style="display:none; width:100%; max-width:900px; margin:0 auto; padding-top: 20px;">
                        <!-- Top Bar -->
                        <div style="display:flex; align-items:center; gap:20px; margin-bottom:30px; border-bottom:1px solid #333; padding-bottom:20px; position: sticky; top: 0; background: var(--bg); z-index: 10; padding-top: 10px;">
                            <div style="font-family:var(--font-brand); font-size:1.8rem; color:white; cursor:pointer; display: flex; align-items: center;" onclick="loadSearch(document.getElementById('wsContent'), document.getElementById('appTools'))">
                                <span style="color:var(--gold);">Q</span>S
                            </div>
                            <div style="position: relative; flex: 1;">
                                <input type="text" id="searchInput2" placeholder="Buscar..." 
                                    style="width: 100%; padding:12px 20px; background:#111; border:1px solid #333; border-radius:25px; color:white; font-size: 1rem;"
                                    onkeydown="if(event.key === 'Enter') performQaxiSearch(this.value)">
                                <i class="fa-solid fa-search" style="position: absolute; right: 15px; top: 50%; transform: translateY(-50%); color: #666;"></i>
                            </div>
                        </div>
                        
                        <div style="display: flex; gap: 30px; flex-wrap: wrap;">
                            <!-- Left Col: AI & Top Result -->
                            <div style="flex: 2; min-width: 300px;">
                                <!-- AI Overview -->
                                <div id="aiOverview" style="background:linear-gradient(180deg, rgba(212, 175, 55, 0.08) 0%, rgba(20,20,20,0) 100%); border:1px solid rgba(212, 175, 55, 0.3); border-radius:16px; padding:25px; margin-bottom:30px; display:none;">
                                    <h3 style="margin-top:0; color:var(--gold); display:flex; align-items:center; gap:10px; font-size: 1.1rem; margin-bottom: 15px;">
                                        <i class="fa-solid fa-wand-magic-sparkles"></i> QAXI AI Generativo
                                    </h3>
                                    <div id="aiContent" style="line-height:1.7; color:#e0e0e0; font-size: 0.95rem;"></div>
                                </div>

                                <!-- Web Results -->
                                <div id="webResultsList"></div>
                            </div>
                            
                            <!-- Right Col: Google Direct -->
                            <div style="flex: 1; min-width: 250px;">
                                <div style="background:#111; padding:20px; border-radius:12px; border:1px solid #333; position: sticky; top: 100px;">
                                    <h4 style="margin:0 0 15px 0; color:#888; font-size: 0.8rem; text-transform: uppercase;">Fuentes Externas</h4>
                                    <a id="googleLink" href="#" target="_blank" style="display: block; text-decoration:none; margin-bottom: 10px;">
                                        <div style="padding: 15px; background: #202124; border-radius: 8px; border: 1px solid #5f6368; display: flex; align-items: center; gap: 15px; transition: 0.2s;" onmouseover="this.style.background='#303134'" onmouseout="this.style.background='#202124'">
                                            <div style="font-size: 1.5rem; color: white;"><i class="fa-brands fa-google"></i></div>
                                            <div>
                                                <div style="color: #dadce0; font-weight: 500;">Google Search</div>
                                                <div style="color: #9aa0a6; font-size: 0.8rem;">Ver resultados completos</div>
                                            </div>
                                        </div>
                                    </a>
                                    <div style="font-size: 0.8rem; color: #666; margin-top: 15px; line-height: 1.4;">
                                        QAXI Search utiliza fuentes públicas y algoritmos de IA para sintetizar información. Para navegar profundamente, usa el enlace a Google.
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        async function performQaxiSearch(val) {
            const input1 = document.getElementById('searchInput');
            const input2 = document.getElementById('searchInput2');
            const query = val || (input1 ? input1.value : input2.value);
            
            if (!query) return;
            
            // Switch UI
            const hero = document.getElementById('searchHero');
            const results = document.getElementById('searchResults');
            const list = document.getElementById('webResultsList');
            const aiSection = document.getElementById('aiOverview');
            const aiContent = document.getElementById('aiContent');
            const googleLink = document.getElementById('googleLink');
            
            if(hero) hero.style.display = 'none';
            results.style.display = 'block';
            if(input2) input2.value = query;
            googleLink.href = `https://www.google.com/search?q=${encodeURIComponent(query)}`;
            
            // Clear previous
            list.innerHTML = '';
            aiContent.innerHTML = '<div style="display:flex; align-items:center; gap:10px; color:#888;"><i class="fa-solid fa-circle-notch fa-spin"></i> Generando respuesta inteligente...</div>';
            aiSection.style.display = 'block';
            
            // 1. Get Web Data
            const webData = await searchWeb(query);
            
            // 2. Render Results List
            let listHtml = '';
            if(webData.length > 0) {
                webData.forEach(item => {
                    listHtml += `
                        <div class="result-item" style="margin-bottom:25px; padding-bottom: 15px; border-bottom: 1px solid #222;">
                            <div style="font-size:0.75rem; color:#888; margin-bottom:5px; display: flex; align-items: center; gap: 6px;">
                                <img src="https://www.google.com/s2/favicons?domain=${item.source}&sz=16" style="width:14px; height:14px; opacity: 0.7; border-radius: 2px;">
                                ${item.source || 'Web'}
                            </div>
                            <div style="color:#8ab4f8; font-size:1.2rem; margin-bottom:6px; cursor: pointer; text-decoration: underline;" onclick="window.open('https://www.google.com/search?q=${encodeURIComponent(item.title)}')">${item.title}</div>
                            <div style="color:#ccc; font-size:0.9rem; line-height:1.5;">${item.snippet}</div>
                        </div>
                    `;
                });
            } else {
                listHtml += `<div style="padding:20px 0; color:#666;">No se encontraron resultados directos en la vista rápida.</div>`;
            }
            list.innerHTML = listHtml;
            
            // 3. Generate AI Summary (using Groq)
            try {
                const systemPrompt = `Eres QAXI SEARCH, un motor de respuestas inteligente. 
Responde a la búsqueda: "${query}".
Usa esta información extraída de la web si es útil:
${webData.map(r => `[${r.source}]: ${r.snippet}`).join('\n')}

Instrucciones:
1. Responde directamente a la intención del usuario.
2. Usa formato Markdown limpio.
3. Sé objetivo y verificable.
4. Si es una pregunta factual, da la respuesta exacta al principio.
5. Cita las fuentes entre paréntesis si usas la info provista.`;

                const response = await fetch("https://api.groq.com/openai/v1/chat/completions", {
                    method: "POST",
                    headers: { "Content-Type": "application/json", "Authorization": `Bearer ${GROQ_KEY}` },
                    body: JSON.stringify({
                        messages: [{ role: "system", content: systemPrompt }, { role: "user", content: query }],
                        model: "llama-3.3-70b-versatile",
                        temperature: 0.4,
                        max_tokens: 800
                    })
                });
                
                const data = await response.json();
                const text = data.choices ? data.choices[0].message.content : "No se pudo generar el resumen.";
                aiContent.innerHTML = marked.parse(text);
                
            } catch(e) {
                console.error(e);
                aiContent.innerHTML = "QAXI AI no está disponible en este momento.";
            }
        }

        // === QR ===
        function loadQR(c, t) {
            c.innerHTML = `
                <div class="qr-wrapper">
                    <div class="qr-card">
                        <i class="fa-solid fa-qrcode" style="font-size: 3rem; margin-bottom:15px; color:#fff;"></i>
                        <h3 style="margin-bottom:20px; color:white;">Generador QR</h3>
                        <input type="text" id="qrText" placeholder="URL o Texto" style="width:100%; padding:10px; margin-bottom:15px; border:1px solid #333; background:#000; color:white; border-radius:4px;">
                        <button class="nav-btn" onclick="generateQR()" style="width:100%; border-color:var(--gold); color:var(--gold);">GENERAR</button>
                        <div id="qrOutput" style="margin-top:20px; width:150px; height:150px; background:white; display:flex; align-items:center; justify-content:center; border-radius:8px;"></div>
                    </div>
                </div>`;
        }
        window.generateQR = function() {
            const txt = document.getElementById('qrText').value;
            if(txt) document.getElementById('qrOutput').innerHTML = `<img src="https://api.qrserver.com/v1/create-qr-code/?size=150x150&data=${encodeURIComponent(txt)}">`;
        }

        

        // ========================================
        // === QAXI LIVE (REUNIONES EN LA NUBE) ===
        // ========================================

        function loadLive(c, t) {
            // Toolbar
            t.innerHTML = `
                <button class="nav-btn" onclick="createLiveMeeting()" style="border-color:var(--gold); color:var(--gold);">NUEVA REUNIÓN</button>
                <button class="nav-btn" onclick="openSelectedMeeting()">UNIRSE</button>
                <button class="nav-btn" onclick="copySelectedLink()">COPIAR ENLACE</button>
                <button class="nav-btn" onclick="testMediaPermissions()">PROBAR CÁMARA</button>
                <div class="sep"></div>
                <button class="nav-btn" onclick="openLiveInNewTab()">ABRIR PÁGINA OFICIAL DE QAXI LIVE</button>
                <div class="sep"></div>
                <button class="nav-btn" id="cloudSyncBtn" onclick="toggleLiveCloudSync()">Sincronizar (Nube)</button>
            `;

            // Main content: left panel (meetings) + right panel (iframe preview)
            c.innerHTML = `
                <div style="display:flex; width:100%; height:100%; gap:20px; padding:20px;">
                    <div style="width:320px; background:#0f0f0f; border:1px solid #222; border-radius:10px; padding:12px; display:flex; flex-direction:column; gap:10px;">
                        <h3 style="margin:0; color:var(--gold); font-family:var(--font-brand);">QAXI Live</h3>
                        <div style="font-size:0.85rem; color:#aaa;">Gestiona tus reuniones en la nube. Crea, programa y comparte.</div>
                        <div style="flex:1; overflow:auto; margin-top:8px;" id="liveMeetingsList"></div>
                        <div style="display:flex; gap:8px; margin-top:8px;">
                            <input id="newMeetingName" placeholder="Nombre (opcional)" style="flex:1; padding:8px; background:#050505; border:1px solid #333; color:#ddd; border-radius:6px;">
                            <button class="nav-btn" onclick="createLiveMeeting(true)">Crear</button>
                        </div>
                    </div>
                    <div style="flex:1; background:#050505; border:1px solid #222; border-radius:10px; display:flex; flex-direction:column;">
                        <div style="padding:12px; border-bottom:1px solid #222; display:flex; align-items:center; gap:10px;">
                            <div style="font-weight:700; color:#ddd;">Vista previa</div>
                            <div style="color:#888; font-size:0.85rem;">(si la web lo permite, se mostrará aquí)</div>
                        </div>
                        <div style="flex:1; overflow:auto; display:flex; position:relative;">
                                <div id="livePreviewWrapper" style="flex:1; position:relative;">
                                    <iframe id="liveIframe" src="https://qaxilive.netlify.app" style="flex:1; width:100%; height:100%; border:none; border-radius:8px;" sandbox="allow-scripts allow-same-origin allow-forms allow-popups" allow="camera; microphone; fullscreen; autoplay"></iframe>
                                    <div id="livePreviewOverlay" style="position:absolute; inset:0; display:flex; flex-direction:column; align-items:center; justify-content:center; background:linear-gradient(180deg, rgba(0,0,0,0.6), rgba(0,0,0,0.4)); color:#ddd; text-align:center; padding:20px; gap:12px;">
                                        <div style="max-width:720px; text-align:left;">
                                            <div style="font-size:1.1rem; font-weight:700; color:var(--gold); margin-bottom:6px;">Permisos de Cámara y Micrófono</div>
                                            <div style="color:#bbb; margin-bottom:8px;">Algunos navegadores y políticas de seguridad no permiten pedir cámara/micrófono desde un iframe o desde otro dominio. Si al entrar a una reunión ves mensajes como "Permiso denegado" o no aparecen las opciones de cámara/micrófono, sigue estos pasos:</div>
                                            <ol style="color:#ccc; margin:0 0 8px 18px;">
                                                <li>Abrir la reunión en una pestaña nueva haciendo clic en <strong>Abrir página oficial de QAXI Live</strong>.</li>
                                                <li>En la pestaña nueva (sitio oficial de QAXI Live) permite cuando el navegador pregunte por <strong>Cámara</strong> y <strong>Micrófono</strong>.</li>
                                                <li>Si el permiso no aparece, revisa los ajustes del navegador para permitir cámara/micrófono para <strong>https://qaxilive.netlify.app</strong> o para la pestaña abierta.</li>
                                            </ol>
                                            <div style="color:#bbb; margin-top:6px;">Nota: también es importante servir <code>cloud.html</code> desde HTTPS o desde un servidor local (no abrirlo con <em>file://</em>), ya que los permisos suelen requerir un contexto seguro.</div>
                                        </div>
                                        <div style="display:flex; gap:8px;">
                                            <button class="nav-btn" onclick="openLiveInNewTab()" style="border-color:var(--gold); color:var(--gold);">Abrir página oficial de QAXI Live</button>
                                            <button class="nav-btn" onclick="testMediaPermissions()">Probar permisos aquí</button>
                                        </div>
                                        <div style="font-size:0.85rem; color:#999; max-width:700px; text-align:center;">Si después de esto sigue sin funcionar, abre directamente https://qaxilive.netlify.app en una pestaña nueva y únete desde allí.</div>
                                    </div>
                                </div>
                            </div>
                    </div>
                </div>
            `;

            renderLiveMeetings();
            // If Firestore is available, enable cloud sync automatically
            try { if (typeof db !== 'undefined' && db) enableLiveCloudSync(); } catch(e){}
        }

        function loadMeetingsFromStorage() {
            try {
                const raw = localStorage.getItem(STORAGE_KEYS.LIVE) || '[]';
                const arr = JSON.parse(raw);
                // Normalize items: ensure `created` is a number timestamp
                const normalized = (Array.isArray(arr) ? arr : []).map(item => {
                    const it = Object.assign({}, item);
                    if (!it.created) it.created = Date.now();
                    // if created is string numeric, parse it
                    if (typeof it.created === 'string' && /^\d+$/.test(it.created)) it.created = parseInt(it.created, 10);
                    // if created is ISO date string, try Date.parse
                    if (typeof it.created === 'string' && isNaN(it.created)) {
                        const p = Date.parse(it.created);
                        if (!isNaN(p)) it.created = p; else it.created = Date.now();
                    }
                    if (typeof it.created !== 'number' || isNaN(it.created)) it.created = Date.now();
                    return it;
                });
                // Save back normalized list to avoid repeated invalid dates
                try { localStorage.setItem(STORAGE_KEYS.LIVE, JSON.stringify(normalized)); } catch(e){}
                return normalized;
            } catch (e) { return []; }
        }

        function getActiveMeetingsList() {
            if (liveCloudSync && Array.isArray(cloudMeetings) && cloudMeetings.length) return cloudMeetings.slice();
            return loadMeetingsFromStorage();
        }

        function formatDate(ts) {
            try {
                const d = (typeof ts === 'number') ? new Date(ts) : new Date(Number(ts));
                if (isNaN(d.getTime())) return '—';
                // show relative if within 24h
                const diff = Date.now() - d.getTime();
                const oneHour = 1000 * 60 * 60;
                const oneDay = oneHour * 24;
                if (diff < oneHour) {
                    const m = Math.max(1, Math.floor(diff / (1000 * 60)));
                    return m + ' min';
                } else if (diff < oneDay) {
                    const h = Math.max(1, Math.floor(diff / oneHour));
                    return h + ' h';
                }
                return d.toLocaleString();
            } catch(e) { return '—'; }
        }

        function saveMeetingsToStorage(list) {
            try { localStorage.setItem(STORAGE_KEYS.LIVE, JSON.stringify(list || [])); } catch(e){}
        }

        function renderLiveMeetings() {
            const list = getActiveMeetingsList();
            const container = document.getElementById('liveMeetingsList');
            if (!container) return;
            if (list.length === 0) {
                container.innerHTML = '<div style="color:#888; padding:12px;">No hay reuniones. Crea una nueva.</div>';
                return;
            }
            container.innerHTML = '';
            list.slice().reverse().forEach(m => {
                const el = document.createElement('div');
                el.style.padding = '10px';
                el.style.border = '1px solid #222';
                el.style.borderRadius = '8px';
                el.style.marginBottom = '8px';
                el.style.display = 'flex';
                el.style.justifyContent = 'space-between';
                el.style.alignItems = 'center';
                const dispDate = formatDate(m.created);
                el.innerHTML = `
                    <div style="flex:1; margin-right:8px;"><div style="font-weight:700; color:#ddd;">${m.name || m.id}</div><div style="font-size:0.8rem; color:#888;">${dispDate}</div></div>
                    <div style="display:flex; gap:6px;">
                        <button class="nav-btn" onclick="joinMeeting('${m.id}')">Entrar</button>
                        <button class="nav-btn" onclick="copyLink('${m.id}')">Copiar</button>
                        <button class="nav-btn" onclick="deleteMeeting('${m.id}')" style="background:#441111; border-color:#662222; color:#fff;">Borrar</button>
                    </div>
                `;
                container.appendChild(el);
            });
        }

        function createLiveMeeting(openAfter = false) {
            const nameInput = document.getElementById('newMeetingName');
            const name = nameInput ? nameInput.value.trim() : '';
            const id = 'qaxi-' + Date.now().toString(36) + '-' + Math.random().toString(36).slice(2,8);
            const created = Date.now();
            // If cloud sync enabled and db available, write to Firestore
            if (liveCloudSync && typeof db !== 'undefined' && db) {
                try {
                    db.collection('qaxi_live_meetings').doc(id).set({ id, name, created })
                    .then(() => {
                        // success: Firestore onSnapshot will update UI
                    }).catch(err => {
                        console.warn('Firestore write failed', err);
                        // fallback to local
                        const meetings = loadMeetingsFromStorage();
                        meetings.push({ id, name, created });
                        saveMeetingsToStorage(meetings);
                        renderLiveMeetings();
                    });
                } catch(e) {
                    console.warn('Firestore error', e);
                    const meetings = loadMeetingsFromStorage();
                    meetings.push({ id, name, created });
                    saveMeetingsToStorage(meetings);
                    renderLiveMeetings();
                }
            } else {
                const meetings = loadMeetingsFromStorage();
                meetings.push({ id, name, created });
                saveMeetingsToStorage(meetings);
                renderLiveMeetings();
            }
            if (nameInput) nameInput.value = '';
            if (openAfter) joinMeeting(id);
        }

        function joinMeeting(id) {
            const iframe = document.getElementById('liveIframe');
            const url = `https://qaxilive.netlify.app/?room=${encodeURIComponent(id)}`;
            // Update preview if available
            if (iframe) {
                try { iframe.src = url; } catch(e) { /* ignore */ }
            }
            // Open the meeting in a new tab to allow camera/mic permissions
            try {
                window.open(url, '_blank', 'noopener');
            } catch(e) {
                // fallback: navigate current window
                window.location.href = url;
            }
        }

        // Test local getUserMedia permissions (runs on this origin)
        async function testMediaPermissions() {
            if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
                alert('Tu navegador no soporta getUserMedia. Usa Chrome/Edge/Safari recientes.');
                return;
            }

            const overlay = document.getElementById('livePreviewOverlay');
            if (overlay) {
                overlay.innerHTML = '<div style="color:#ddd;"><i class="fa-solid fa-circle-notch fa-spin"></i> Solicitando permiso...</div>';
            }

            try {
                const stream = await navigator.mediaDevices.getUserMedia({ video: true, audio: true });
                // stop tracks immediately (we just wanted to test permissions)
                stream.getTracks().forEach(t => t.stop());
                if (overlay) {
                    overlay.innerHTML = '<div style="color:#d4ffb8; font-weight:700;">Permisos concedidos en este sitio</div><div style="color:#bbb;">Nota: esto solo prueba permisos para QAXI Cloud. La reunión en QAXI Live (otro dominio) deberá pedir permisos también en su pestaña.</div>';
                    setTimeout(() => { if (overlay) overlay.style.display = 'none'; }, 2200);
                }
            } catch (err) {
                console.error('getUserMedia error', err);
                const msg = (err && err.name) ? `${err.name}: ${err.message || ''}` : (err.message || 'Error de permisos');
                if (overlay) {
                    overlay.innerHTML = `
                        <div style="color:#ffb3b3; font-weight:700;">Permiso denegado o no disponible</div>
                        <div style="color:#bbb; max-width:680px; margin-top:6px;">${msg}</div>
                        <div style="text-align:left; color:#ccc; max-width:700px; margin-top:10px;">Prueba lo siguiente:
                            <ol style="margin:6px 0 0 18px; color:#ccc;">
                                <li>Abrir la reunión en una pestaña nueva usando <strong>Abrir página oficial de QAXI Live</strong>.</li>
                                <li>En la pestaña nueva (sitio oficial de QAXI Live) acepta los permisos de Cámara y Micrófono cuando el navegador lo pregunte.</li>
                                <li>Si no aparece la petición, revisa los ajustes del navegador y habilita cámara/micrófono para <strong>https://qaxilive.netlify.app</strong>.</li>
                            </ol>
                        </div>
                        <div style="margin-top:10px; display:flex; gap:8px;"><button class="nav-btn" onclick="openLiveInNewTab()" style="border-color:var(--gold); color:var(--gold);">Abrir página oficial de QAXI Live</button><button class="nav-btn" onclick="testMediaPermissions()">Volver a probar</button></div>
                        <div style="font-size:0.85rem; color:#999; max-width:700px; text-align:center; margin-top:8px;">Si continúas con problemas, abre directamente https://qaxilive.netlify.app en una pestaña y únete desde allí.</div>
                    `;
                }
                // Show guidance
                alert('No se pudo acceder a la cámara/micrófono aquí. Abre la reunión en una pestaña nueva (botón «Abrir página oficial de QAXI Live») y permite Cámara y Micrófono cuando el sitio lo solicite. También puedes abrir directamente https://qaxilive.netlify.app y unirte desde allí. Revisa los ajustes del navegador si hace falta.');
            }
        }

        // ---- Cloud sync helpers ----
        function toggleLiveCloudSync() {
            if (!db) return alert('Firebase no está inicializado o no hay acceso.');
            if (liveCloudSync) disableLiveCloudSync(); else enableLiveCloudSync();
        }

        function enableLiveCloudSync() {
            if (!db) return alert('Firebase no está disponible.');
            liveCloudSync = true;
            startLiveSyncListeners();
            const btn = document.getElementById('cloudSyncBtn'); if (btn) { btn.style.borderColor = 'var(--gold)'; btn.style.color = 'var(--gold)'; btn.innerText = 'Sincronizando (Nube)'; }
        }

        function disableLiveCloudSync() {
            liveCloudSync = false;
            if (liveUnsubscribe) { try { liveUnsubscribe(); } catch(e){} liveUnsubscribe = null; }
            const btn = document.getElementById('cloudSyncBtn'); if (btn) { btn.style.borderColor = ''; btn.style.color = '#ccc'; btn.innerText = 'Sincronizar (Nube)'; }
            // fall back to local storage list
            renderLiveMeetings();
        }

        function startLiveSyncListeners() {
            if (!db) return;
            try {
                liveUnsubscribe = db.collection('qaxi_live_meetings').orderBy('created', 'asc').onSnapshot(snapshot => {
                    const arr = [];
                    snapshot.forEach(doc => {
                        const data = doc.data();
                        arr.push({ id: data.id || doc.id, name: data.name || '', created: data.created || Date.now() });
                    });
                    cloudMeetings = arr;
                    // Mirror to localStorage so offline still works
                    try { localStorage.setItem(STORAGE_KEYS.LIVE, JSON.stringify(cloudMeetings)); } catch(e){}
                    renderLiveMeetings();
                }, err => {
                    console.error('Live sync error', err);
                    alert('Error sincronizando con Firestore: ' + (err.message || err));
                });
            } catch(e) { console.error('startLiveSyncListeners error', e); }
        }

        function copyLink(id) {
            const url = `https://qaxilive.netlify.app/?room=${encodeURIComponent(id)}`;
            try { navigator.clipboard.writeText(url); alert('Enlace copiado al portapapeles'); } catch(e) { prompt('Copia el enlace manualmente', url); }
        }

        function deleteMeeting(id) {
            if (liveCloudSync && typeof db !== 'undefined' && db) {
                try {
                    db.collection('qaxi_live_meetings').doc(id).delete().catch(e => console.warn('Firestore delete failed', e));
                } catch(e) { console.warn('Firestore delete error', e); }
            }
            let list = loadMeetingsFromStorage();
            list = list.filter(m => m.id !== id);
            saveMeetingsToStorage(list);
            renderLiveMeetings();
        }

        function openSelectedMeeting() {
            const container = document.getElementById('liveMeetingsList');
            if (!container) return alert('Selecciona una reunión de la lista.');
            // If there's at least one, open the most recent
            const list = getActiveMeetingsList();
            if (!list.length) return alert('No hay reuniones creadas.');
            joinMeeting(list[list.length - 1].id);
        }

        function copySelectedLink() {
            const list = getActiveMeetingsList();
            if (!list.length) return alert('No hay reuniones creadas.');
            copyLink(list[list.length - 1].id);
        }

        function openLiveInNewTab() {
            const iframe = document.getElementById('liveIframe');
            const url = iframe ? iframe.src || 'https://qaxilive.netlify.app' : 'https://qaxilive.netlify.app';
            window.open(url, '_blank');
        }
        
        // ========================================
        // === CARNET CREATOR ===
        // ========================================
        
        let carnetPhoto = null;
        let carnetBgImage = null;
        
        function loadCarnet(c, t) {
            t.innerHTML = `
                <button class="nav-btn" onclick="clearCarnet()">NUEVO</button>
            `;
            
            c.innerHTML = `
                <div class="carnet-container">
                    <div class="carnet-form">
                        <h3 style="color: var(--gold); margin-bottom: 10px;"><i class="fa-solid fa-id-card"></i> Crear Carnet</h3>
                        
                        <label>Empresa / Organización</label>
                        <input type="text" id="carnetCompany" placeholder="Nombre de la empresa" oninput="updateCarnetPreview()">
                        
                        <label>Nombre Completo</label>
                        <input type="text" id="carnetName" placeholder="Juan Pérez" oninput="updateCarnetPreview()">
                        
                        <label>Cargo / Rol</label>
                        <input type="text" id="carnetRole" placeholder="Gerente de Ventas" oninput="updateCarnetPreview()">
                        
                        <label>Número de ID / Código</label>
                        <input type="text" id="carnetId" placeholder="EMP-001" oninput="updateCarnetPreview()">
                        
                        <label>Email (para código QR)</label>
                        <input type="email" id="carnetEmail" placeholder="correo@empresa.com" oninput="updateCarnetPreview()">
                        
                        <label>Estilo del Carnet</label>
                        <select id="carnetStyle" onchange="updateCarnetPreview()">
                            <option value="corporate">Corporativo (Azul Oscuro)</option>
                            <option value="modern">Moderno (Morado)</option>
                            <option value="elegant">Elegante (Negro + Dorado)</option>
                            <option value="vibrant">Vibrante (Rosa)</option>
                            <option value="nature">Natural (Verde)</option>
                            <option value="sunset">Atardecer (Naranja)</option>
                            <option value="custom">🖼️ Fondo Personalizado</option>
                        </select>
                        
                        <div id="customBgSection" style="display:none;">
                            <label>Imagen de Fondo</label>
                            <input type="file" id="carnetBgInput" accept="image/*" style="display:none" onchange="loadCarnetBg(this)">
                            <button class="photo-upload-btn" onclick="document.getElementById('carnetBgInput').click()" style="background:#555;">
                                <i class="fa-solid fa-image"></i> Subir Fondo
                            </button>
                        </div>
                        
                        <label>Foto del Empleado</label>
                        <input type="file" id="carnetPhotoInput" accept="image/*" style="display:none" onchange="loadCarnetPhoto(this)">
                        <button class="photo-upload-btn" onclick="document.getElementById('carnetPhotoInput').click()">
                            <i class="fa-solid fa-camera"></i> Subir Foto
                        </button>
                    </div>
                    
                    <div class="carnet-preview-area">
                        <p style="color: #666; margin-bottom: 15px; font-size: 0.8rem;">Vista Previa</p>
                        <div id="carnetPreview" class="carnet-card style-corporate">
                            <div class="carnet-photo" id="carnetPhotoPreview">
                                <div style="text-align:center; font-size:0.6rem; opacity:0.7;"><i class="fa-solid fa-user" style="font-size:1.5rem; display:block; margin-bottom:3px;"></i>FOTO</div>
                            </div>
                            <div class="carnet-info">
                                <div class="carnet-company" id="previewCompany">EMPRESA</div>
                                <div class="carnet-name" id="previewName">Nombre Completo</div>
                                <div class="carnet-role" id="previewRole">Cargo</div>
                                <div class="carnet-id" id="previewId">ID: ---</div>
                            </div>
                            <div class="carnet-qr" id="previewQR">
                                <img src="https://api.qrserver.com/v1/create-qr-code/?size=100x100&data=QAXI" alt="QR">
                            </div>
                            <div class="carnet-logo"><i class="fa-solid fa-building"></i></div>
                        </div>
                        
                        <div class="share-options">
                            <button class="share-btn primary" onclick="downloadCarnet()">
                                <i class="fa-solid fa-download"></i> Descargar PNG
                            </button>
                            <button class="share-btn" onclick="downloadCarnetPDF()">
                                <i class="fa-solid fa-file-pdf"></i> PDF
                            </button>
                            <button class="share-btn" onclick="shareCarnetWhatsApp()">
                                <i class="fa-brands fa-whatsapp"></i> Enviar
                            </button>
                            <button class="share-btn" onclick="shareCarnetEmail()">
                                <i class="fa-solid fa-envelope"></i> Email
                            </button>
                        </div>
                    </div>
                </div>
            `;
            
            carnetPhoto = null;
            carnetBgImage = null;
        }
        
        window.updateCarnetPreview = function() {
            const company = document.getElementById('carnetCompany').value || 'EMPRESA';
            const name = document.getElementById('carnetName').value || 'Nombre Completo';
            const role = document.getElementById('carnetRole').value || 'Cargo';
            const id = document.getElementById('carnetId').value || '---';
            const email = document.getElementById('carnetEmail').value || 'contacto@empresa.com';
            const style = document.getElementById('carnetStyle').value;
            
            document.getElementById('previewCompany').innerText = company.toUpperCase();
            document.getElementById('previewName').innerText = name;
            document.getElementById('previewRole').innerText = role;
            document.getElementById('previewId').innerText = `ID: ${id}`;
            
            // Actualizar QR con vCard
            const vCardData = `BEGIN:VCARD\nVERSION:3.0\nFN:${name}\nORG:${company}\nTITLE:${role}\nEMAIL:${email}\nEND:VCARD`;
            document.getElementById('previewQR').innerHTML = `<img src="https://api.qrserver.com/v1/create-qr-code/?size=100x100&data=${encodeURIComponent(vCardData)}" alt="QR">`;
            
            // Mostrar/ocultar sección de fondo personalizado
            const customSection = document.getElementById('customBgSection');
            if (style === 'custom') {
                customSection.style.display = 'block';
            } else {
                customSection.style.display = 'none';
            }
            
            // Actualizar estilo
            const card = document.getElementById('carnetPreview');
            card.className = `carnet-card style-${style}`;
            
            // Si es custom y hay imagen de fondo
            if (style === 'custom' && carnetBgImage) {
                card.style.backgroundImage = `url(${carnetBgImage})`;
            } else {
                card.style.backgroundImage = '';
            }
        }
        
        window.loadCarnetBg = function(input) {
            if (input.files && input.files[0]) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    carnetBgImage = e.target.result;
                    updateCarnetPreview();
                };
                reader.readAsDataURL(input.files[0]);
            }
        }
        
        window.loadCarnetPhoto = function(input) {
            if (input.files && input.files[0]) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    carnetPhoto = e.target.result;
                    document.getElementById('carnetPhotoPreview').innerHTML = `<img src="${carnetPhoto}" alt="Foto">`;
                };
                reader.readAsDataURL(input.files[0]);
            }
        }
        
        window.clearCarnet = function() {
            document.getElementById('carnetCompany').value = '';
            document.getElementById('carnetName').value = '';
            document.getElementById('carnetRole').value = '';
            document.getElementById('carnetId').value = '';
            document.getElementById('carnetEmail').value = '';
            document.getElementById('carnetStyle').value = 'corporate';
            carnetPhoto = null;
            carnetBgImage = null;
            document.getElementById('carnetPhotoPreview').innerHTML = '<div style="text-align:center; font-size:0.6rem; opacity:0.7;"><i class="fa-solid fa-user" style="font-size:1.5rem; display:block; margin-bottom:3px;"></i>FOTO</div>';
            document.getElementById('customBgSection').style.display = 'none';
            updateCarnetPreview();
        }
        
        window.downloadCarnet = async function() {
            const card = document.getElementById('carnetPreview');
            const canvas = await html2canvas(card, { scale: 3, useCORS: true });
            const link = document.createElement('a');
            link.download = `carnet_${document.getElementById('carnetName').value || 'empleado'}.png`;
            link.href = canvas.toDataURL('image/png');
            link.click();
        }
        
        window.downloadCarnetPDF = async function() {
            const card = document.getElementById('carnetPreview');
            const canvas = await html2canvas(card, { scale: 3, useCORS: true });
            const pdf = new jspdf.jsPDF('l', 'mm', [90, 55]);
            pdf.addImage(canvas.toDataURL('image/png'), 'PNG', 0, 0, 90, 55);
            pdf.save(`carnet_${document.getElementById('carnetName').value || 'empleado'}.pdf`);
        }
        
        window.shareCarnetWhatsApp = async function() {
            const name = document.getElementById('carnetName').value || 'Empleado';
            const company = document.getElementById('carnetCompany').value || 'Empresa';
            const message = `¡Hola! Te comparto el carnet de ${name} de ${company}. Creado con QAXI Cloud.`;
            
            // Primero descargar, luego abrir WhatsApp
            alert('Primero se descargará el carnet. Luego podrás adjuntarlo en WhatsApp.');
            await downloadCarnet();
            window.open(`https://wa.me/?text=${encodeURIComponent(message)}`, '_blank');
        }
        
        window.shareCarnetEmail = function() {
            const name = document.getElementById('carnetName').value || 'Empleado';
            const company = document.getElementById('carnetCompany').value || 'Empresa';
            const email = document.getElementById('carnetEmail').value || '';
            const subject = `Carnet de Identificación - ${name}`;
            const body = `Hola ${name},\n\nTe enviamos tu carnet de identificación de ${company}.\n\nPor favor, descarga el carnet adjunto o genéralo desde QAXI Cloud.\n\nSaludos,\n${company}`;
            
            window.open(`mailto:${email}?subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(body)}`, '_blank');
            
            // También descargar
            downloadCarnet();
        }
        
        // ========================================
        // === FIRMA PDF ===
        // ========================================
        
        let firmaCanvas = null;
        let firmaCtx = null;
        let isDrawing = false;
        let firmaColor = '#000000';
        let firmaWidth = 2;
        let firmaImage = null;
        let pdfForSign = null;
        let firmaOverlays = [];
        
        function loadFirma(c, t) {
            t.innerHTML = `
                <button class="nav-btn" onclick="clearFirmaCanvas()">LIMPIAR FIRMA</button>
                <button class="nav-btn" onclick="saveFirmaAsImage()">GUARDAR FIRMA</button>
                <button class="nav-btn" onclick="exportSignedPDF()" style="border-color:var(--gold); color:var(--gold)">EXPORTAR PDF FIRMADO</button>
            `;
            
            c.innerHTML = `
                <div class="firma-container">
                    <div class="firma-sidebar">
                        <h3 style="color: var(--gold); margin: 0 0 10px 0;"><i class="fa-solid fa-signature"></i> Crear Firma</h3>
                        
                        <p style="color: #888; font-size: 0.8rem; margin: 0;">Dibuja tu firma aquí:</p>
                        <div class="firma-canvas-container">
                            <canvas id="firmaCanvas" width="240" height="100"></canvas>
                        </div>
                        
                        <div class="firma-tools">
                            <button class="firma-tool-btn" onclick="setFirmaColor('#000000')" style="background:#000; color:#fff;">Negro</button>
                            <button class="firma-tool-btn" onclick="setFirmaColor('#0000aa')" style="background:#0000aa; color:#fff;">Azul</button>
                            <button class="firma-tool-btn" onclick="setFirmaColor('#aa0000')" style="background:#aa0000; color:#fff;">Rojo</button>
                        </div>
                        
                        <div style="margin-top: 10px;">
                            <label style="font-size: 0.8rem; color: #888;">Grosor: </label>
                            <input type="range" min="1" max="6" value="2" id="firmaWidthSlider" oninput="setFirmaWidth(this.value)" style="width: 100%;">
                        </div>
                        
                        <div class="sep" style="width:100%; height:1px; background:#333; margin: 15px 0;"></div>
                        
                        <p style="color: #888; font-size: 0.8rem; margin: 0;">O sube una imagen de firma:</p>
                        <input type="file" id="firmaImageInput" accept="image/*" style="display:none" onchange="loadFirmaImage(this)">
                        <button class="firma-tool-btn" onclick="document.getElementById('firmaImageInput').click()" style="width:100%;">
                            <i class="fa-solid fa-upload"></i> Subir Imagen
                        </button>
                        
                        <div class="sep" style="width:100%; height:1px; background:#333; margin: 15px 0;"></div>
                        
                        <h4 style="color: var(--gold); margin: 0 0 10px 0;"><i class="fa-solid fa-file-pdf"></i> Cargar PDF</h4>
                        <input type="file" id="pdfSignInput" accept="application/pdf" style="display:none" onchange="loadPDFtoSign(this)">
                        <button class="firma-tool-btn" onclick="document.getElementById('pdfSignInput').click()" style="width:100%; background:var(--gold); color:black;">
                            <i class="fa-solid fa-file-arrow-up"></i> Seleccionar PDF
                        </button>
                        
                        <p id="pdfSignStatus" style="color: #666; font-size: 0.75rem; margin-top: 10px;"></p>
                    </div>
                    
                    <div class="firma-preview" id="firmaPreviewArea">
                        <p style="color: #666; font-size: 0.9rem;"><i class="fa-solid fa-file-pdf" style="font-size: 3rem; display: block; margin-bottom: 15px; opacity: 0.3;"></i>Carga un PDF para firmarlo</p>
                    </div>
                </div>
            `;
            
            // Inicializar canvas de firma (fondo blanco para mejor visibilidad/imprenta)
            firmaCanvas = document.getElementById('firmaCanvas');
            firmaCtx = firmaCanvas.getContext('2d');
            // Fill white background so signature is visible and exports with white
            try {
                firmaCtx.fillStyle = '#ffffff';
                firmaCtx.fillRect(0, 0, firmaCanvas.width, firmaCanvas.height);
            } catch(e) { firmaCtx.clearRect(0, 0, firmaCanvas.width, firmaCanvas.height); }
            firmaCtx.strokeStyle = firmaColor;
            firmaCtx.lineWidth = firmaWidth;
            firmaCtx.lineCap = 'round';
            firmaCtx.lineJoin = 'round';
            
            // Eventos de dibujo
            firmaCanvas.addEventListener('mousedown', startDrawing);
            firmaCanvas.addEventListener('mousemove', draw);
            firmaCanvas.addEventListener('mouseup', stopDrawing);
            firmaCanvas.addEventListener('mouseout', stopDrawing);
            
            // Touch events
            firmaCanvas.addEventListener('touchstart', (e) => {
                e.preventDefault();
                const touch = e.touches[0];
                const rect = firmaCanvas.getBoundingClientRect();
                startDrawing({ offsetX: touch.clientX - rect.left, offsetY: touch.clientY - rect.top });
            });
            firmaCanvas.addEventListener('touchmove', (e) => {
                e.preventDefault();
                const touch = e.touches[0];
                const rect = firmaCanvas.getBoundingClientRect();
                draw({ offsetX: touch.clientX - rect.left, offsetY: touch.clientY - rect.top });
            });
            firmaCanvas.addEventListener('touchend', stopDrawing);
            
            firmaOverlays = [];
            pdfForSign = null;
        }
        
        function startDrawing(e) {
            isDrawing = true;
            firmaCtx.beginPath();
            firmaCtx.moveTo(e.offsetX, e.offsetY);
        }
        
        function draw(e) {
            if (!isDrawing) return;
            firmaCtx.lineTo(e.offsetX, e.offsetY);
            firmaCtx.stroke();
        }
        
        function stopDrawing() {
            isDrawing = false;
        }
        
        window.setFirmaColor = function(color) {
            firmaColor = color;
            firmaCtx.strokeStyle = color;
        }
        
        window.setFirmaWidth = function(width) {
            firmaWidth = parseInt(width);
            firmaCtx.lineWidth = firmaWidth;
        }
        
        window.clearFirmaCanvas = function() {
            // Fill white background again
            try { firmaCtx.fillStyle = '#ffffff'; firmaCtx.fillRect(0, 0, firmaCanvas.width, firmaCanvas.height); } catch(e) { try { firmaCtx.clearRect(0,0,firmaCanvas.width,firmaCanvas.height); } catch(e){} }
            firmaImage = null;
        }
        
        window.saveFirmaAsImage = function() {
            const link = document.createElement('a');
            link.download = 'mi_firma.png';
            link.href = firmaCanvas.toDataURL('image/png');
            link.click();
        }
        
        window.loadFirmaImage = function(input) {
            if (input.files && input.files[0]) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    firmaImage = e.target.result;
                    // Mostrar en el canvas
                    const img = new Image();
                    img.onload = () => {
                        // keep background transparent
                        firmaCtx.clearRect(0, 0, firmaCanvas.width, firmaCanvas.height);
                        const scale = Math.min(firmaCanvas.width / img.width, firmaCanvas.height / img.height) * 0.9;
                        const w = img.width * scale;
                        const h = img.height * scale;
                        firmaCtx.drawImage(img, (firmaCanvas.width - w) / 2, (firmaCanvas.height - h) / 2, w, h);
                    };
                    img.src = firmaImage;
                };
                reader.readAsDataURL(input.files[0]);
            }
        }
        
        window.loadPDFtoSign = async function(input) {
            if (!input.files || !input.files[0]) return;
            
            const file = input.files[0];
            document.getElementById('pdfSignStatus').innerText = 'Cargando PDF...';
            
            // Cargar PDF.js si no está cargado
            if (!window.pdfjsLib) {
                const script = document.createElement('script');
                script.src = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js';
                document.head.appendChild(script);
                await new Promise(resolve => script.onload = resolve);
                pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
            }
            
            const reader = new FileReader();
            reader.onload = async (e) => {
                try {
                    const typedArray = new Uint8Array(e.target.result);
                    pdfForSign = await pdfjsLib.getDocument(typedArray).promise;
                    
                    document.getElementById('pdfSignStatus').innerText = `PDF cargado: ${pdfForSign.numPages} página(s)`;
                    
                    // Renderizar primera página
                    await renderPDFPage(1);
                    
                } catch (err) {
                    console.error(err);
                    document.getElementById('pdfSignStatus').innerText = 'Error al cargar PDF';
                }
            };
            reader.readAsArrayBuffer(file);
        }
        
        async function renderPDFPage(pageNum) {
            if (!pdfForSign) return;
            
            const page = await pdfForSign.getPage(pageNum);
            const scale = 1.5;
            const viewport = page.getViewport({ scale });
            
            const canvas = document.createElement('canvas');
            canvas.id = 'pdfCanvas';
            canvas.width = viewport.width;
            canvas.height = viewport.height;
            
            const ctx = canvas.getContext('2d');
            await page.render({ canvasContext: ctx, viewport }).promise;
            
            const previewArea = document.getElementById('firmaPreviewArea');
            previewArea.innerHTML = `
                <div class="pdf-preview-container" style="position: relative;">
                    <p style="color: #888; font-size: 0.75rem; margin-bottom: 10px;">Haz clic donde quieras colocar la firma:</p>
                    <div id="pdfCanvasWrapper" style="position: relative; display: inline-block;"></div>
                    <div style="margin-top: 15px;">
                        <button class="firma-tool-btn active" onclick="addFirmaToPosition()"><i class="fa-solid fa-plus"></i> Añadir firma al PDF</button>
                        <button class="firma-tool-btn" onclick="removeFirmaOverlays()"><i class="fa-solid fa-trash"></i> Quitar firmas</button>
                    </div>
                </div>
            `;
            
            document.getElementById('pdfCanvasWrapper').appendChild(canvas);
            
            // Clic para posicionar firma
            canvas.addEventListener('click', (e) => {
                const rect = canvas.getBoundingClientRect();
                const x = e.clientX - rect.left;
                const y = e.clientY - rect.top;
                placeSignature(x, y);
            });
        }
        
        function placeSignature(x, y) {
            const wrapper = document.getElementById('pdfCanvasWrapper');
            const firmaData = firmaCanvas.toDataURL('image/png');
            
            const overlay = document.createElement('div');
            overlay.className = 'firma-overlay';
            overlay.style.left = (x - 75) + 'px';
            overlay.style.top = (y - 40) + 'px';
            overlay.innerHTML = `<img src="${firmaData}" alt="Firma">`;
            
            // Hacer draggable
            let isDraggingOverlay = false;
            let offsetX, offsetY;
            
            overlay.addEventListener('mousedown', (e) => {
                isDraggingOverlay = true;
                offsetX = e.clientX - overlay.offsetLeft;
                offsetY = e.clientY - overlay.offsetTop;
                e.stopPropagation();
            });
            
            document.addEventListener('mousemove', (e) => {
                if (!isDraggingOverlay) return;
                overlay.style.left = (e.clientX - offsetX) + 'px';
                overlay.style.top = (e.clientY - offsetY) + 'px';
            });
            
            document.addEventListener('mouseup', () => {
                isDraggingOverlay = false;
            });
            
            wrapper.appendChild(overlay);
            firmaOverlays.push(overlay);
        }
        
        window.addFirmaToPosition = function() {
            alert('Haz clic en el PDF donde deseas colocar tu firma. Puedes arrastrarla para ajustar la posición.');
        }
        
        window.removeFirmaOverlays = function() {
            firmaOverlays.forEach(o => o.remove());
            firmaOverlays = [];
        }
        
        window.exportSignedPDF = async function() {
            const pdfCanvas = document.getElementById('pdfCanvas');
            if (!pdfCanvas) {
                alert('Primero carga un PDF');
                return;
            }
            
            // Crear canvas combinado
            const wrapper = document.getElementById('pdfCanvasWrapper');
            const finalCanvas = await html2canvas(wrapper, { scale: 2, useCORS: true });
            
            // Crear PDF
            const pdf = new jspdf.jsPDF({
                orientation: pdfCanvas.width > pdfCanvas.height ? 'l' : 'p',
                unit: 'px',
                format: [pdfCanvas.width, pdfCanvas.height]
            });
            
            pdf.addImage(finalCanvas.toDataURL('image/png'), 'PNG', 0, 0, pdfCanvas.width, pdfCanvas.height);
            pdf.save('documento_firmado.pdf');
        }
    </script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script>
        // Seguridad QAXI CLOUD (Compat)
        try {
            const authCompat = firebase.auth();

            authCompat.onAuthStateChanged(async (user) => {
                const loginOverlay = document.getElementById('loginModal') || document.getElementById('login-overlay');
                const appContent = document.querySelector('.main-container') || document.getElementById('app-content');

                if (user) {
                    console.log('Verificando licencia Cloud para:', user.email);
                    try {
                        const userRef = db.collection('QAXI_CLOUD_DATA').doc(user.uid);
                        const docSnap = await userRef.get();

                        if (docSnap.exists) {
                            const data = docSnap.data();
                            if (data.cloud_active !== true) {
                                Swal.fire({
                                    icon: 'error',
                                    title: 'Acceso Restringido',
                                    html: `
                                        <p>Hola <b>${user.email}</b>,</p>
                                        <p class="mt-2">Eres usuario de QAXI, pero <b>NO tienes activa la licencia QAXI CLOUD</b>.</p>
                                        <p class="text-sm text-gray-400 mt-2">Tener el POS o la Web no te da acceso automático a la Nube Titanium.</p>
                                    `,
                                    confirmButtonText: 'Cerrar Sesión',
                                    confirmButtonColor: '#ef4444',
                                    allowOutsideClick: false,
                                    background: '#0f172a',
                                    color: '#fff'
                                }).then(() => { authCompat.signOut(); location.reload(); });
                                return;
                            }
                            console.log('Licencia Cloud Válida');
                        } else {
                            await userRef.set({
                                email: user.email,
                                createdAt: new Date(),
                                cloud_active: true,
                                plan: 'Titanium Trial',
                                storage_used: 0
                            });
                            Swal.fire({ icon: 'success', title: 'Bienvenido a la Nube', text: 'Espacio inicial configurado.', background: '#0f172a', color: '#fff', timer: 2000, showConfirmButton: false });
                        }

                        if (loginOverlay) loginOverlay.style.display = 'none';
                        if (appContent) appContent.style.display = 'block';

                    } catch (err) {
                        console.error('Error de seguridad:', err);
                        Swal.fire('Error', 'No se pudo verificar tu licencia.', 'error');
                        authCompat.signOut();
                    }
                } else {
                    if (loginOverlay) loginOverlay.style.display = 'flex';
                    if (appContent) appContent.style.display = 'none';
                }
            });
        } catch(e) { console.warn('Auth compat no disponible', e); }
    </script>
</body>
</html>
